<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Agent â€” Mastermind Bet</title>
<style>
  body{margin:0;background:#0b1a2b;color:#e7f0ff;font-family:system-ui,Segoe UI,Roboto,Ubuntu,Arial}
  .wrap{max-width:900px;margin:28px auto;padding:0 14px}
  .card{background:#0f2238;border:1px solid #123356;border-radius:12px;padding:14px;margin-bottom:14px}
  input,button{padding:8px 10px;border-radius:8px;border:1px solid #1e4162;background:#0e2a46;color:#e7f0ff;outline:none}
  button{background:#ffbe0b;color:#111;border:none;cursor:pointer;font-weight:700}
  h1{font-size:20px;margin:12px 0}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid #163a5b;padding:8px 6px;text-align:left}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .muted{opacity:.8}
</style>
</head>
<body>
<div class="wrap">
  <div class="card" id="loginBox">
    <h1>Agent Login</h1>
    <div class="row">
      <input id="phone" placeholder="Phone (10 digits)"/>
      <input id="pin" placeholder="6 digit PIN"/>
      <button id="loginBtn">Login</button>
    </div>
    <div class="muted">Admin creates your account. Default PIN is 000000 (change given by admin).</div>
  </div>

  <div class="card" id="panel" style="display:none">
    <h1>Cashiers</h1>
    <div class="row">
      <input id="c_name" placeholder="Cashier name"/>
      <input id="c_pin" placeholder="6 digit PIN"/>
      <button id="createCashier">Create Cashier</button>
    </div>
    <div style="height:10px"></div>
    <table id="cashTbl">
      <thead><tr><th>ID</th><th>Name</th><th>Status</th><th>Created</th><th>Action</th></tr></thead>
      <tbody></tbody>
    </table>
    <div class="row" style="margin-top:10px">
      <button id="refresh">Refresh</button>
      <button id="logout">Logout</button>
      <a href="/pos" style="margin-left:auto;color:#9fd0ff">Go to POS</a>
    </div>
  </div>
</div>
<script>
async function me(){ const r = await fetch('/me'); return r.json(); }
async function login(){
  const phone = document.getElementById('phone').value.trim();
  const pin   = document.getElementById('pin').value.trim();
  const r = await fetch('/auth/agent/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({phone,pin})});
  const j = await r.json();
  if(!r.ok){ alert(j.error||'login failed'); return; }
  document.getElementById('loginBox').style.display='none';
  document.getElementById('panel').style.display='';
  loadCashiers();
}
async function loadCashiers(){
  const r = await fetch('/agent/api/cashiers');
  const rows = await r.json();
  const tb = document.querySelector('#cashTbl tbody');
  tb.innerHTML = rows.map(x=> `<tr>
    <td>${x.id}</td><td>${x.name}</td><td>${x.is_active?'Active':'Off'}</td><td>${new Date(x.created_at).toLocaleString()}</td>
    <td><button onclick="toggle(${x.id},${x.is_active?0:1})">${x.is_active?'Disable':'Enable'}</button></td>
  </tr>`).join('');
}
async function toggle(id, enabled){
  const r = await fetch('/agent/api/cashiers/toggle',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({cashier_id:id, enabled})});
  const j = await r.json();
  if(!r.ok){ alert(j.error||'failed'); return; }
  loadCashiers();
}
document.getElementById('loginBtn').onclick = login;
document.getElementById('refresh').onclick = loadCashiers;
document.getElementById('logout').onclick = async ()=>{ await fetch('/auth/logout',{method:'POST'}); location.reload(); };
document.getElementById('createCashier').onclick = async ()=>{
  const name = document.getElementById('c_name').value.trim();
  const pin  = document.getElementById('c_pin').value.trim();
  const r = await fetch('/agent/api/cashiers/create',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name,pin})});
  const j = await r.json();
  if(!r.ok){ alert(j.error||'failed'); return; }
  alert('Cashier added');
  loadCashiers();
};
(async ()=>{
  const u = await me();
  if (u && u.role==='agent'){ document.getElementById('loginBox').style.display='none'; document.getElementById('panel').style.display=''; loadCashiers(); }
})();
</script>
</body>
</html>
