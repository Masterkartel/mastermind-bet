<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>History — Mastermind Bet</title>
<link rel="icon" href="data:,">
<style>
  :root{--bg:#0b1120;--panel:#0f172a;--line:#1e2b4d;--text:#eaf2ff;--muted:#9ab3da;--green:#18d28a;--red:#ef476f;}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:14px/1.35 system-ui,Segoe UI,Roboto,Helvetica,Arial}
  header{display:flex;align-items:center;gap:8px;padding:12px 16px;background:linear-gradient(180deg,#0e1830,#0a1327);border-bottom:1px solid #0d1530}
  .pill{background:#101a2f;border:1px solid #243a63;color:#cfe0ff;padding:7px 10px;border-radius:999px;text-decoration:none}
  .spacer{flex:1}
  main{padding:16px}
  .card{background:linear-gradient(180deg,#0f1a33,#0c1428);border:1px solid var(--line);border-radius:14px;padding:12px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid var(--line);text-align:left}
  th{color:#aecdff}
  tr{cursor:pointer}
  tr:hover td{background:#0e1830}

  /* modal */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:16px}
  .sheet{position:relative;max-width:760px;width:100%;background:linear-gradient(180deg,#101b35,#0e162c);
         border:1px solid var(--line);border-radius:16px;overflow:hidden}
  .sheet header{border:0}
  .sheet .body{padding:16px}
  .close{position:absolute;top:12px;right:12px;cursor:pointer}

  /* watermark */
  .wm{position:absolute;inset:0;pointer-events:none;display:flex;align-items:center;justify-content:center;opacity:.08;
      font-size:120px;font-weight:900;letter-spacing:6px}
  .wm.won{color:var(--green)}
  .wm.lost{color:var(--red)}
</style>
</head>
<body>
<header>
  <a class="pill" href="/pos">POS</a>
  <a class="pill" href="/dogs">Dogs</a>
  <a class="pill" href="/horses">Horses</a>
  <a class="pill" href="/colors">Colors</a>
  <a class="pill" href="/history">History</a>
  <span class="spacer"></span>
  <span style="color:#9ab3da" id="clock">--:--</span>
</header>

<main>
  <div class="card">
    <h3 style="margin:0 0 8px">Latest Tickets</h3>
    <table id="tbl">
      <thead><tr>
        <th>ID</th><th>Agent</th><th>Stake</th><th>Potential</th><th>Status</th><th>Created</th>
      </tr></thead>
      <tbody id="rows"><tr><td colspan="6" style="color:#9ab3da">Loading…</td></tr></tbody>
    </table>
  </div>
</main>

<div class="modal" id="modal">
  <div class="sheet">
    <div class="wm" id="wm">STATUS</div>
    <header>
      <h3 id="tt">Ticket</h3>
      <div class="close" id="close">✕</div>
    </header>
    <div class="body">
      <div id="meta" style="color:#9ab3da;margin-bottom:10px"></div>
      <table style="width:100%">
        <thead><tr><th>#</th><th>Market</th><th>Pick</th><th>Odds</th></tr></thead>
        <tbody id="lines"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
const $=s=>document.querySelector(s);

function tickClock(){
  const d=new Date();
  $('#clock').textContent = new Intl.DateTimeFormat(undefined,{hour:'2-digit',minute:'2-digit',second:'2-digit'}).format(d);
}
setInterval(tickClock,1000); tickClock();

async function get(path){ const r=await fetch(path); if(!r.ok) throw new Error(r.status); return r.json(); }

async function load(){
  const items = await get('/api/tickets?limit=100');
  const rows = items.map(t=>{
    const created = new Date(t.created_at);
    const when = new Intl.DateTimeFormat(undefined,{year:'numeric',month:'short',day:'2-digit',hour:'2-digit',minute:'2-digit'}).format(created);
    const badge = t.status==='won' ? '<b style="color:#12d28a">WON</b>' :
                 t.status==='lost'? '<b style="color:#ef476f">LOST</b>' : '<b style="color:#ffd166">OPEN</b>';
    return `<tr onclick="openTicket(${t.id})">
      <td>${t.id}</td><td>${t.agent_code||'-'}</td>
      <td>${(t.stake_kes||0).toFixed(2)}</td><td>${(t.potential_kes||0).toFixed(2)}</td>
      <td>${badge}</td><td>${when}</td></tr>`;
  }).join('') || '<tr><td colspan="6" style="color:#9ab3da">No tickets.</td></tr>';
  $('#rows').innerHTML = rows;
}

async function openTicket(id){
  const t = await get('/api/tickets/'+id);
  $('#tt').textContent = 'Ticket #'+t.id;
  const when = new Date(t.created_at);
  $('#meta').innerHTML = `Agent: <b>${t.agent_code||'-'}</b> • Stake: <b>${t.stake_kes.toFixed(2)}</b> • Potential: <b>${t.potential_kes.toFixed(2)}</b> • Created: ${new Intl.DateTimeFormat(undefined,{year:'numeric',month:'short',day:'2-digit',hour:'2-digit',minute:'2-digit'}).format(when)}`;
  $('#lines').innerHTML = t.lines.map((l,i)=>`<tr><td>${i+1}</td><td>${l.market}</td><td>${l.pick}</td><td>${Number(l.price).toFixed(2)}</td></tr>`).join('');
  const wm = $('#wm'); wm.textContent = t.status.toUpperCase();
  wm.className = 'wm ' + (t.status==='won'?'won':t.status==='lost'?'lost':'');
  $('#modal').style.display='flex';
}
$('#close').onclick = ()=> $('#modal').style.display='none';
window.addEventListener('keydown',e=>{ if(e.key==='Escape') $('#modal').style.display='none'; });

load().catch(()=>{$('#rows').innerHTML='<tr><td colspan="6" style="color:#9ab3da">Failed to load.</td></tr>';});
</script>
</body>
</html>
