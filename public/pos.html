mkdir -p public
cat > public/pos.html <<'HTML'
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Mastermind — Cashier</title>
<link rel="icon" href="/favicon.svg" type="image/svg+xml"/>
<style>
  :root{ --brand:#f59e0b; --line:#e5e7eb; --text:#0f172a; --muted:#64748b; }
  body{font-family:system-ui,Segoe UI,Roboto,Ubuntu,Inter,sans-serif;margin:0;background:#fff;color:var(--text)}
  header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--line)}
  .wrap{display:grid;grid-template-columns: 2fr 1fr; gap:16px; padding:16px}
  .card{border:1px solid var(--line);border-radius:12px;padding:12px}
  .fixtures{max-height:58vh;overflow:auto}
  .fixture{display:flex;align-items:center;justify-content:space-between;border-bottom:1px dashed var(--line);padding:8px 0}
  .sel button{margin-left:6px}
  .betslip .line{display:flex;justify-content:space-between;align-items:center;border-bottom:1px dashed var(--line);padding:6px 0}
  .stake{display:flex;gap:8px;align-items:center;margin-top:10px}
  .btn{background:var(--brand);color:#111;padding:8px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:700}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .ticket{position:relative;border:1px dashed var(--line);padding:10px;border-radius:12px;margin-top:10px}
  .ticket::after{content:attr(data-status);position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
    font-weight:900;font-size:42px;opacity:.08;transform:rotate(-20deg);pointer-events:none;color:#64748b}
  .ticket.won::after{color:#16a34a;opacity:.12}
  .ticket.lost::after{color:#ef4444;opacity:.1}
  #barcode{margin:6px 0}
  .history{display:flex;gap:8px;margin-top:10px}
  .pill{border:1px solid var(--line);border-radius:999px;padding:4px 10px;color:var(--muted)}
  @media (max-width:900px){ .wrap{grid-template-columns:1fr} }
</style>
</head>
<body>
<header>
  <strong>MASTERMIND — Cashier</strong>
  <div class="pill">Stake: 20–1000 KES · Max payout 20,000 KES</div>
</header>

<div class="wrap">
  <div class="card">
    <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
      <label>League:</label>
      <select id="league">
        <option>EPL</option><option>UCL</option><option>LALIGA</option><option>CHAMPS_CUP</option>
      </select>
      <button class="btn" id="refresh">Refresh</button>
      <button class="btn" id="seed">Seed sample</button>
    </div>
    <div class="fixtures" id="fixtures"></div>
  </div>

  <div class="card betslip">
    <h3>Bet Slip</h3>
    <div id="lines"></div>
    <div class="stake">
      <label for="stake">Stake (KES):</label>
      <input id="stake" type="number" min="20" max="1000" value="50" style="width:100px"/>
      <button class="btn" id="place" disabled>Place Ticket</button>
    </div>
    <div id="payout" style="margin-top:6px;color:var(--muted)"></div>

    <div id="ticketOut"></div>

    <div class="history">
      <input id="code" placeholder="Enter ticket code" style="flex:1;padding:8px;border-radius:10px;border:1px solid var(--line)"/>
      <button class="btn" id="reprint">Find / Reprint</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
<script>
const fixturesDiv = document.getElementById('fixtures');
const leagueSel = document.getElementById('league');
const linesDiv = document.getElementById('lines');
const payoutDiv = document.getElementById('payout');
const stakeInput = document.getElementById('stake');
const placeBtn = document.getElementById('place');
const ticketOut = document.getElementById('ticketOut');
let betLines = []; // {selection_id, price, label}

async function loadFixtures(){
  fixturesDiv.innerHTML = 'Loading...';
  const r = await fetch(`/api/fixtures?league=${leagueSel.value}`);
  const fixtures = await r.json();
  if (!fixtures.length){ fixturesDiv.innerHTML = 'No open fixtures. Click SEED SAMPLE.'; return; }
  fixturesDiv.innerHTML = '';

  for (const f of fixtures){
    const wrap = document.createElement('div'); wrap.className='fixture';
    wrap.innerHTML = `<div><strong>${f.home_code}</strong> vs <strong>${f.away_code}</strong><br>
      <small>${new Date(f.kickoff_at).toLocaleTimeString()}</small></div>
      <div class="sel" id="sel-${f.id}"></div>`;
    fixturesDiv.appendChild(wrap);

    const mr = await fetch(`/api/fixtures/${f.id}/markets`); const markets = await mr.json();
    const selDiv = wrap.querySelector(`#sel-${f.id}`);
    for (const m of markets){
      for (const s of m.selections){
        const btn = document.createElement('button');
        btn.className='btn'; btn.style.padding='6px 8px';
        btn.textContent = `${m.market}:${s.code} @${Number(s.price).toFixed(2)}`;
        btn.onclick = ()=> addLine(s.selection_id, Number(s.price), `${f.home_code} vs ${f.away_code} · ${m.market} ${s.code}`);
        selDiv.appendChild(btn);
      }
    }
  }
}

function renderLines(){
  linesDiv.innerHTML='';
  betLines.forEach((l,idx)=>{
    const d = document.createElement('div'); d.className='line';
    d.innerHTML = `<div>${idx+1}. ${l.label}</div><div>@${l.price.toFixed(2)} <button data-i="${idx}">✖</button></div>`;
    d.querySelector('button').onclick = ev => { betLines.splice(Number(ev.target.dataset.i),1); compute(); };
    linesDiv.appendChild(d);
  });
  compute();
}

function addLine(id, price, label){
  betLines.push({selection_id:id, price, label});
  renderLines();
}

function compute(){
  let acc = betLines.reduce((a,b)=>a*b.price,1);
  const stake = Number(stakeInput.value||0);
  let potential = stake * acc;
  if (potential > 20000) potential = 20000; // hard cap
  payoutDiv.textContent = betLines.length ? `Accumulator: x${acc.toFixed(2)} · Potential win: KES ${potential.toFixed(2)}` : '';
  placeBtn.disabled = !(betLines.length && stake>=20 && stake<=1000);
}
stakeInput.oninput = compute;

document.getElementById('refresh').onclick = loadFixtures;
document.getElementById('seed').onclick = async ()=>{
  await fetch('/admin/seed-sample',{method:'POST'});
  loadFixtures();
};

placeBtn.onclick = async ()=>{
  const stake = Number(stakeInput.value);
  const body = { stake_kes: stake, lines: betLines.map(l=>({selection_id:l.selection_id})) };
  const r = await fetch('/api/tickets',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
  const j = await r.json();
  if (!j.ok){ alert(j.error||'Failed'); return; }
  showTicket(j.code, stake, j.potential_kes);
  betLines=[]; renderLines();
};

function showTicket(code, stake, potential){
  ticketOut.innerHTML = `
    <div class="ticket pending" data-status="PENDING" id="tkt">
      <h3>MASTERMIND BET</h3>
      <div>Ticket: <strong>${code}</strong></div>
      <svg id="barcode"></svg>
      <hr/>
      ${betLines.map((l,i)=>`<div>${i+1}. ${l.label} @${l.price.toFixed(2)}</div>`).join('')}
      <hr/>
      <div>Stake: KES ${stake.toFixed(2)}</div>
      <div>Potential: KES ${Number(potential).toFixed(2)}</div>
      <div>Status: PENDING</div>
      <button class="btn" onclick="window.print()">Print</button>
    </div>`;
  JsBarcode("#barcode", code, {format:"CODE128", width:2, height:40, displayValue:false});
}

// History / reprint
document.getElementById('reprint').onclick = async ()=>{
  const code = document.getElementById('code').value.trim();
  if (!code) return;
  const r = await fetch('/api/tickets/'+code);
  if(!r.ok){ alert('Not found'); return; }
  const t = await r.json();
  betLines = t.lines.map(x=>({selection_id:null, price:Number(x.price), label:`${x.market} ${x.pick}`}));
  renderLines();
  showTicket(t.code, t.stake_cents/100, t.potential_win_cents/100);
};
loadFixtures();
</script>
</body>
</html>
HTML
