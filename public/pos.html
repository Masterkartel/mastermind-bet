<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mastermind Bet â€” POS</title>
<link rel="icon" href="data:," />
<style>
  :root{
    --bg:#0b0f17; --panel:#121826; --panel-2:#192235; --accent:#ffb703; --red:#ef476f; --green:#06d6a0; --muted:#8aa0c7;
    --text:#eaf2ff; --soft:#cfe0ff;
  }
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial}
  header{display:flex;align-items:center;gap:10px;padding:12px 16px;background:linear-gradient(90deg,#1b2436, #0f1523);flex-wrap:wrap}
  .brand{font-weight:800;letter-spacing:.4px}
  .badge{background:var(--panel-2);padding:6px 10px;border-radius:999px;color:var(--soft);border:1px solid #23304a;text-decoration:none}
  .badge:hover{filter:brightness(1.1)}
  main{display:grid;grid-template-columns: 2fr 1fr; gap:16px; padding:16px}
  .card{background:var(--panel);border:1px solid #1a253b;border-radius:14px;overflow:hidden}
  .card h2{margin:0;padding:10px 12px;background:var(--panel-2);border-bottom:1px solid #1a253b;font-size:14px;letter-spacing:.3px}
  .leagues{display:flex;gap:8px;padding:12px;flex-wrap:wrap}
  .pill{padding:8px 12px;border-radius:10px;background:#141c2c;border:1px solid #243353;color:#cfe0ff;cursor:pointer}
  .pill.active{background:var(--accent);color:#111;border-color:#e49b00}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px; border-bottom:1px solid #1a253b}
  th{color:#9eb5e4;text-align:left;font-size:12px}
  tr:hover td{background:#121b2d}
  .odd{display:inline-block;min-width:48px;text-align:center;padding:6px 8px;border-radius:8px;background:#0e1626;border:1px solid #213150;cursor:pointer}
  .odd:hover{filter:brightness(1.2)}
  .odd.pick{background:var(--green);border-color:#10a57f;color:#08231d;font-weight:700}
  .shelf{padding:12px;display:flex;flex-direction:column;gap:10px}
  .row{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
  .btn{background:var(--accent);border:0;padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer}
  .btn.secondary{background:#223356;color:#cfe0ff;border:1px solid #2a416b}
  .info{color:var(--muted);font-size:12px}
  input,select{background:#10192b;border:1px solid #263a60;color:#cfe0ff;border-radius:10px;padding:8px 10px}
  .totals{display:flex;justify-content:space-between;padding:10px 12px;background:#0f1727;border-top:1px solid #1a253b}
  .spacer{flex:1}
</style>
</head>
<body>
<header>
  <div class="brand">ðŸ’¥ Mastermind Bet â€” POS</div>
  <span class="badge">House Edge On âœ…</span>
  <!-- Quick navigation to all front products -->
  <a class="badge" href="/pos">Football</a>
  <a class="badge" href="/dogs">Dogs</a>
  <a class="badge" href="/horses">Horses</a>
  <a class="badge" href="/colors">Colors</a>
  <span class="spacer"></span>
  <a class="badge" href="/virtual">Virtual</a>
  <a class="badge" href="/admin">Admin</a>
  <a class="badge" href="/history">History</a>
</header>

<main>
  <section class="card" id="marketCard">
    <h2>Pick League â€¢ Fixtures & Markets</h2>
    <div class="leagues" id="leagues"></div>
    <div class="shelf">
      <div class="row info">Click any price to add to betslip. Markets included: 1X2, O/U, DC, GG/NG, Home/Away O/U, 1X2+O/U (1.5 & 2.5), Total Goal Bands.</div>
      <div id="fixtures"></div>
    </div>
  </section>

  <section class="card" id="slipCard">
    <h2>Bet Slip</h2>
    <div class="shelf">
      <div class="row">
        <label>Agent Code</label><input id="agentCode" placeholder="(optional, e.g. AG001)" />
      </div>
      <div id="slip"></div>
      <div class="row">
        <label>Stake</label><input id="stake" type="number" min="20" value="50" />
        <button class="btn" id="place">Place Bet</button>
        <button class="btn secondary" id="clear">Clear</button>
      </div>
      <div class="totals"><div>Lines: <span id="lineCount">0</span></div><div>Est. Odds: <span id="estOdds">1.00</span></div></div>
      <div class="info" id="limits"></div>
      <div class="info" id="msg"></div>
    </div>
  </section>
</main>

<script>
const leaguesBar = document.getElementById('leagues');
const fixturesDiv = document.getElementById('fixtures');
const slipDiv = document.getElementById('slip');
const lineCount = document.getElementById('lineCount');
const estOdds = document.getElementById('estOdds');
const limitsEl = document.getElementById('limits');
const msg = document.getElementById('msg');
const state = { league: 'EPL', slip: [] };

function fmt(n){ return Number(n).toFixed(2); }

async function get(path){ const r = await fetch(path); if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }

async function loadLimits(){
  try{
    const j = await get('/admin/limits');
    limitsEl.textContent = `Min Stake: ${j.min_stake} â€¢ Max Stake: ${j.max_stake} â€¢ Max Payout: ${j.max_payout}`;
  }catch{ limitsEl.textContent=''; }
}
function addToSlip(sel){
  if(state.slip.find(s=>s.id===sel.selection_id)) return;
  state.slip.push({ id: sel.selection_id, market: sel.label, pick: sel.name, price: Number(sel.price) });
  renderSlip();
}
function removeFromSlip(id){
  state.slip = state.slip.filter(s=>s.id!==id); renderSlip();
}
function renderSlip(){
  slipDiv.innerHTML = state.slip.map(s=>
    `<div class="row"><span class="badge">${s.market}</span> <strong>${s.pick}</strong>
      <span class="badge">@ ${fmt(s.price)}</span>
      <button class="btn secondary" onclick="removeFromSlip(${s.id})">x</button></div>`
  ).join('') || '<div class="info">No selections yet.</div>';
  lineCount.textContent = state.slip.length;
  const mult = state.slip.reduce((a,b)=>a*b.price,1)||1;
  estOdds.textContent = fmt(mult);
}
async function loadLeagues(){
  const j = await get('/api/competitions');
  if(!Array.isArray(j) || j.length===0){
    leaguesBar.innerHTML = '<span class="badge">No competitions</span>'; return;
  }
  leaguesBar.innerHTML = j.map(x => 
    `<button class="pill ${x.code===state.league?'active':''}" onclick="changeLeague('${x.code}')">${x.code}</button>`
  ).join('');
}
async function changeLeague(code){ state.league = code; await loadFixtures(); await loadLeagues(); }

async function loadFixtures(){
  fixturesDiv.innerHTML = '<div class="info">Loadingâ€¦</div>';
  const fx = await get(`/api/fixtures?competition_code=${state.league}`);
  if(!Array.isArray(fx) || fx.length===0){ fixturesDiv.innerHTML = '<div class="info">No fixtures.</div>'; return; }
  const blocks = [];
  for(const f of fx){
    const rows = await get(`/api/selections?fixture_id=${f.id}`);
    const groups = {};
    rows.forEach(r=>{
      const key = r.label;
      (groups[key] ||= []).push(r);
    });
    const mkHtml = Object.keys(groups).map(k=>{
      const cells = groups[k].map(s=>`<span class="odd" onclick='addToSlip(${JSON.stringify({selection_id:s.id,label:escapeHtml(k),name:escapeHtml(s.name),price:s.price})})'>${escapeHtml(s.name)}<br>${fmt(s.price)}</span>`).join(' ');
      return `<div class="row"><span class="badge">${escapeHtml(k)}</span> ${cells}</div>`;
    }).join('');
    blocks.push(`
      <div class="card">
        <h2>${escapeHtml(f.home)} vs ${escapeHtml(f.away)} â€” ${new Date(f.start_time).toLocaleString()}</h2>
        <div class="shelf">${mkHtml||'<div class="info">No markets for this fixture.</div>'}</div>
      </div>`);
  }
  fixturesDiv.innerHTML = blocks.join('');
}
function escapeHtml(s){ return String(s).replace(/[&<>"]/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[m])); }

document.getElementById('clear').onclick = ()=>{ state.slip=[]; renderSlip(); };
document.getElementById('place').onclick = async ()=>{
  const stake = Number(document.getElementById('stake').value||0);
  const agent_code = (document.getElementById('agentCode').value||'').trim()||null;
  const items = state.slip.map(x=>({ selection_id:x.id }));
  msg.textContent='â€¦';
  try{
    const res = await fetch('/api/tickets',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({agent_code,stake,items})});
    const j = await res.json();
    if(!res.ok) throw new Error(j.error||'Failed');
    msg.textContent = `âœ… Ticket #${j.ticket_id} placed. Payout up to ${j.potential_payout}`;
    state.slip = []; renderSlip();
  }catch(e){
    msg.textContent = 'âŒ ' + e.message;
  }
};

loadLimits().catch(()=>{});
changeLeague('EPL');
</script>
</body>
</html>
