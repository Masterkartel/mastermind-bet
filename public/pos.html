<!doctype html>
<html lang="en">
<meta charset="utf-8" />
<title>Mastermind Cashier</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  body { font-family: system-ui, Arial, sans-serif; margin:0; background:#0f172a; color:#e2e8f0; }
  header { padding:12px 16px; background:#111827; display:flex; gap:12px; align-items:center; }
  header h1 { margin:0; font-size:18px; }
  main { display:grid; grid-template-columns: 2fr 1fr; gap:12px; padding:12px; }
  .card { background:#111827; border:1px solid #1f2937; border-radius:12px; padding:12px; }
  .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  button, input, select { background:#0b1220; color:#e5e7eb; border:1px solid #243047; border-radius:8px; padding:8px 10px; }
  button.primary { background:#14532d; border-color:#14532d; }
  button.danger { background:#7f1d1d; border-color:#7f1d1d; }
  .fixture { display:flex; justify-content:space-between; padding:8px; border:1px dashed #243047; border-radius:8px; margin-bottom:8px; }
  .market { margin:8px 0; }
  .pill { display:inline-block; padding:6px 8px; border:1px solid #374151; border-radius:999px; margin:4px 6px 0 0; cursor:pointer; }
  .pill:hover { background:#1f2937; }
  .betslip li { display:flex; justify-content:space-between; margin:6px 0; }
  .receipt { background:#fff; color:#111; padding:16px; border-radius:8px; }
  .watermark { position:relative; }
  .watermark::after {
    content: attr(data-status);
    position:absolute; inset:0;
    display:flex; align-items:center; justify-content:center;
    font: 700 48px/1 system-ui;
    color: rgba(16,185,129,0.18); /* green */
    letter-spacing:4px; transform: rotate(-18deg);
    pointer-events:none;
  }
  .barcode { display:block; margin:8px auto; }
  .muted { color:#6b7280; }
</style>

<header>
  <h1>Mastermind Cashier</h1>
  <button id="seed">Seed Sample</button>
  <div class="muted">Min KES 20 • Max KES 1000 • Max payout KES 20000</div>
</header>

<main>
  <section class="card">
    <div class="row">
      <select id="league">
        <option value="EPL">EPL</option>
        <option value="UCL">Champions League</option>
        <option value="LALIGA">La Liga</option>
      </select>
      <button id="refresh">Refresh fixtures</button>
    </div>
    <div id="fixtures"></div>
    <div id="markets"></div>
  </section>

  <section class="card">
    <h3>Betslip</h3>
    <ul id="slip" class="betslip"></ul>
    <div class="row">
      <input id="stake" type="number" min="20" max="1000" step="1" placeholder="Stake (KES)" />
      <div>Potential: <strong id="potential">0.00</strong> KES</div>
    </div>
    <div class="row" style="margin-top:8px;">
      <button class="primary" id="place">Place Ticket</button>
      <button class="danger" id="clear">Clear</button>
    </div>

    <hr style="border-color:#1f2937; margin:12px 0;" />

    <div class="row">
      <input id="codeLookup" placeholder="Enter ticket code (MM-...)" />
      <button id="reprint">Find / Reprint</button>
    </div>

    <div id="printArea" style="margin-top:12px;"></div>
  </section>
</main>

<script>
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));

let slip = []; // {selection_id, label, price}

function fmt(n){ return Number(n).toFixed(2); }

async function api(url, opts){ const r = await fetch(url, opts); if(!r.ok) throw new Error(await r.text()); return r.json(); }

async function loadFixtures(){
  const league = $('#league').value;
  const data = await api(`/api/fixtures?league=${encodeURIComponent(league)}`);
  const box = $('#fixtures');
  box.innerHTML = '<h3>Fixtures</h3>' + data.map(f => `
    <div class="fixture">
      <div>${new Date(f.kickoff_at).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</div>
      <div><strong>${f.home_code}</strong> vs <strong>${f.away_code}</strong></div>
      <div><button data-fx="${f.id}" class="loadMarkets">Markets</button></div>
    </div>
  `).join('');
}

async function loadMarkets(fixtureId){
  const data = await api(`/api/fixtures/${fixtureId}/markets`);
  const box = $('#markets');
  box.innerHTML = '<h3>Markets</h3>' + data.map(m => `
    <div class="market">
      <div><strong>${m.market}</strong></div>
      <div>
        ${m.selections.map(s => `
          <span class="pill" data-sel="${s.selection_id}" data-label="${m.market}:${s.code}" data-price="${s.price}">
            ${s.code} @ ${s.price}
          </span>
        `).join('')}
      </div>
    </div>
  `).join('');
}

function renderSlip(){
  const ul = $('#slip');
  ul.innerHTML = slip.map((l,i)=>`
    <li>
      <span>${l.label}</span>
      <span>@ ${l.price} <button data-i="${i}" class="rm">×</button></span>
    </li>
  `).join('');

  const stake = Number($('#stake').value || 0);
  const odd = slip.reduce((a,x)=>a*Number(x.price),1);
  let potential = stake * odd;
  if (potential > 20000) potential = 20000; // hard cap displayed
  $('#potential').textContent = fmt(potential);
}

function clearSlip(){ slip = []; renderSlip(); }

async function placeTicket(){
  const stake = Number($('#stake').value || 0);
  if (stake < 20 || stake > 1000) { alert('Stake must be between 20 and 1000 KES'); return; }
  if (!slip.length) { alert('Add at least one selection'); return; }

  const body = {
    stake_kes: stake,
    lines: slip.map(x => ({ selection_id: x.selection_id }))
  };
  try {
    const r = await api('/api/tickets', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
    printTicket(r.code);
    clearSlip();
  } catch (e) {
    alert('Ticket failed: ' + e.message);
  }
}

async function printTicket(code){
  const r = await api(`/api/tickets/${encodeURIComponent(code)}`);
  const area = $('#printArea');
  area.innerHTML = `
    <div class="receipt watermark" data-status="${r.status}">
      <h3 style="margin:0 0 8px 0;">Mastermind Bet</h3>
      <div class="muted">${new Date(r.created_at).toLocaleString()}</div>
      <div style="margin-top:8px;"><strong>Ticket:</strong> ${r.code}</div>
      <img class="barcode" src="/barcode/${encodeURIComponent(r.code)}" alt="barcode" />
      <hr/>
      <div><strong>Stake:</strong> KES ${Number(r.stake_kes).toFixed(2)}</div>
      <div><strong>Potential:</strong> KES ${Number(r.potential_kes).toFixed(2)}</div>
      <hr/>
      <div><strong>Lines</strong></div>
      <ul>
        ${r.lines.map(l => `<li>${l.market} — ${l.pick} @ ${l.price}</li>`).join('')}
      </ul>
      <div class="muted">Status watermark will turn <span style="color:#10b981;font-weight:700;">WON</span> when settled.</div>
    </div>`;
  window.print && window.print();
}

// events
document.addEventListener('click', e => {
  if (e.target.classList.contains('loadMarkets')) {
    loadMarkets(e.target.dataset.fx);
  }
  if (e.target.classList.contains('pill')) {
    const sel = e.target.dataset.sel;
    const exists = slip.some(x => x.selection_id === sel);
    if (!exists) {
      slip.push({
        selection_id: sel,
        label: e.target.dataset.label,
        price: e.target.dataset.price
      });
      renderSlip();
    }
  }
  if (e.target.id === 'clear') clearSlip();
  if (e.target.classList.contains('rm')) {
    slip.splice(Number(e.target.dataset.i),1);
    renderSlip();
  }
  if (e.target.id === 'place') placeTicket();
  if (e.target.id === 'refresh') loadFixtures();
  if (e.target.id === 'seed') {
    fetch('/admin/seed-sample', { method:'POST' }).then(loadFixtures);
  }
  if (e.target.id === 'reprint') {
    const code = $('#codeLookup').value.trim();
    if (code) printTicket(code);
  }
});

document.getElementById('stake').addEventListener('input', renderSlip);

// init
loadFixtures();
renderSlip();
</script>
</html>
