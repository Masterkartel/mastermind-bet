<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Colors — Mastermind Bet</title>
<link rel="icon" href="/favicon.ico"/>
<style>
  :root{
    --bg:#0b1a2b; --panel:#0f2238; --panel-2:#0c1e31;
    --text:#dbe6ff; --muted:#8aa0c5; --accent:#ffbe0b;
    --pill:#123150;
  }
  *{box-sizing:border-box}
  body{margin:0;background:radial-gradient(1200px 600px at 30% -10%,#12253c 0%,#091525 55%,#081421 100%);
       color:var(--text);font:14px/1.3 system-ui,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
  a{color:#8ecbff;text-decoration:none}
  header{display:flex;gap:14px;align-items:center;justify-content:space-between;
         padding:10px 16px;background:#0a1a2b;border-bottom:1px solid #0f2a45;position:sticky;top:0;z-index:5}
  .brand{display:flex;gap:10px;align-items:center;font-weight:700}
  .ball-mini{width:14px;height:14px;border-radius:50%;
    box-shadow:inset -2px -2px 4px rgba(0,0,0,.45), inset 2px 2px 4px rgba(255,255,255,.25)}
  .b-red{background:radial-gradient(circle at 30% 30%,#ff6868,#b70000)}
  .b-blue{background:radial-gradient(circle at 30% 30%,#6aa8ff,#0433a6)}
  .b-green{background:radial-gradient(circle at 30% 30%,#72ff8a,#008f3d)}
  .b-yellow{background:radial-gradient(circle at 30% 30%,#ffe082,#f1a400)}
  .b-purple{background:radial-gradient(circle at 30% 30%,#d39bff,#6e2bbf)}
  .b-orange{background:radial-gradient(circle at 30% 30%,#ffb272,#cc5400)}
  nav .tab{display:inline-block;padding:6px 10px;border-radius:18px;background:#0f2a45;margin-right:6px}
  .clock{opacity:.8}

  .wrap{max-width:1200px;margin:18px auto;padding:0 14px}
  .row{display:grid;grid-template-columns:1fr 380px;gap:14px}
  .card{background:linear-gradient(180deg,var(--panel),var(--panel-2));border:1px solid #0e2b49;border-radius:14px;padding:12px;box-shadow:0 6px 20px rgba(0,0,0,.25)}
  .subtle{color:var(--muted)}
  .bar{display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:8px}
  .chip{background:var(--pill);color:#bcd3f2;border:1px solid #20486f;border-radius:10px;padding:3px 8px;font-size:12px}
  .pills{display:flex;gap:8px;flex-wrap:wrap}

  /* glossy balls */
  .ball{width:68px;height:68px;border-radius:50%;
    display:flex;align-items:center;justify-content:center;margin:6px auto 2px auto;
    color:#fff;font-weight:800;font-size:22px;letter-spacing:.5px;
    box-shadow: inset -6px -8px 16px rgba(0,0,0,.55), inset 6px 6px 14px rgba(255,255,255,.28),
                0 8px 14px rgba(0,0,0,.45);}
  .ball.red{background:radial-gradient(circle at 30% 30%,#ff7a7a,#b10000)}
  .ball.blue{background:radial-gradient(circle at 30% 30%,#7ab4ff,#0b3baa)}
  .ball.green{background:radial-gradient(circle at 30% 30%,#83ff97,#00a14a)}
  .ball.yellow{background:radial-gradient(circle at 30% 30%,#ffec8c,#f2a500)}
  .ball.purple{background:radial-gradient(circle at 30% 30%,#e2b2ff,#7629c6)}
  .ball.orange{background:radial-gradient(circle at 30% 30%,#ffc08a,#cd5d00)}
  .ball.num{background:radial-gradient(circle at 30% 30%,#7ab4ff,#0b3baa)}

  .odds{font-size:12px;text-align:center;color:#dfe9ff;opacity:.95}
  .grid{display:grid;grid-template-columns:repeat(10, minmax(80px,1fr));gap:8px}
  .group{margin:10px 0 6px}
  .group h4{margin:6px 0 10px;font-size:12px;color:#a9c2e6;text-transform:uppercase;letter-spacing:.8px}

  .pill{background:#0e2e4d;border:1px solid #20537e;color:#cde1ff;border-radius:999px;padding:5px 8px;font-size:12px;cursor:pointer}
  .pill.active{background:#154a79;color:#fff}
  .muted{opacity:.75}

  /* betslip tiny */
  .betslip-line{display:flex;align-items:center;justify-content:space-between;padding:6px 8px;border-bottom:1px dashed #234b72}
  .btn{background:#ffbe0b;border:none;color:#202020;font-weight:700;border-radius:8px;padding:8px 12px;cursor:pointer}
  input, .in{background:#0f2a45;border:1px solid #20486f;border-radius:8px;padding:6px 8px;color:#dbe6ff;outline:none}

  @media (max-width:980px){ .row{grid-template-columns:1fr} }
</style>
</head>
<body>
<header>
  <div class="brand">
    <span style="font-weight:700">Colors — Mastermind Bet</span>
    <span class="ball-mini b-red"></span>
    <span class="ball-mini b-blue"></span>
    <span class="ball-mini b-green"></span>
    <span class="ball-mini b-yellow"></span>
    <span class="ball-mini b-purple"></span>
    <span class="ball-mini b-orange"></span>
  </div>
  <nav>
    <a class="tab" href="/pos">POS</a>
    <a class="tab" href="/dogs">Dogs</a>
    <a class="tab" href="/horses">Horses</a>
    <a class="tab" href="/admin">Admin</a>
    <a class="tab" href="/history">History</a>
  </nav>
  <div class="clock" id="clock"></div>
</header>

<div class="wrap">
  <div class="row">
    <!-- LEFT -->
    <div class="card">
      <div class="bar">
        <span class="chip">Draw <span id="drawNo">—</span></span>
        <span class="chip">Starts <span id="startsAt">—</span></span>
        <span class="chip">⏱ <span id="countdown">00:00</span></span>
        <div class="pills" id="drawPills"></div>
      </div>

      <div class="group">
        <h4>Winning Color</h4>
        <div class="grid" id="winGrid"></div>
      </div>

      <div class="group">
        <h4>Number of Colors</h4>
        <div class="grid" id="numGrid"></div>
      </div>

      <div class="subtle muted">Tap a glossy ball to add to betslip. Odds shown under each ball.</div>
    </div>

    <!-- RIGHT: Betslip (lite) -->
    <div class="card">
      <div class="bar" style="justify-content:space-between">
        <div style="font-weight:700">Betslip</div>
        <div class="subtle">Est. Odds: <span id="estOdds">1.00</span></div>
      </div>

      <div class="bar">
        <input id="agentCode" class="in" placeholder="optional e.g. AG001" style="flex:1;max-width:220px"/>
        <input id="stake" class="in" type="number" value="50" style="width:100px"/>
        <button id="place" class="btn">Place Bet</button>
        <button id="clear" class="in" style="cursor:pointer">Clear</button>
      </div>

      <div id="lines"></div>
    </div>
  </div>
</div>

<script>
  /* ====== CLOCK (Nairobi) ====== */
  function tickClock(){
    const s = new Date().toLocaleString('en-KE',{ timeZone:'Africa/Nairobi', hour12:false });
    document.getElementById('clock').textContent = s;
  }
  setInterval(tickClock, 1000); tickClock();

  /* ====== HELPERS ====== */
  const colorClass = name => ({
    RED:'red', BLUE:'blue', GREEN:'green', YELLOW:'yellow', PURPLE:'purple', ORANGE:'orange'
  }[name] || 'blue');

  function ballHTML(label, cls, odds, selection_id){
    return `
      <div class="ball ${cls}" data-sel="${selection_id}" title="${label} @ ${odds}">
        ${label}
      </div>
      <div class="odds"> ${Number(odds).toFixed(2)} </div>
    `;
  }
  function numLabel(s){ return s.replace(/^(\d)\+?$/,'$1+') } // show 2+ etc.

  /* ====== STATE ====== */
  let upcoming = [];  // [{id,draw_no,start_time,status}]
  let activeDraw = null;
  let betItems = [];  // {selection_id, label, price}

  /* ====== LOAD DRAWS (pills) ====== */
  async function loadDraws(){
    const r = await fetch('/api/colors/draws?limit=12');
    const rows = await r.json();
    upcoming = rows;
    const pills = document.getElementById('drawPills');
    pills.innerHTML = rows.map((d,idx) =>
      `<button class="pill" data-id="${d.id}">#${d.draw_no} • ${new Date(d.start_time).toLocaleTimeString('en-KE',{timeZone:'Africa/Nairobi',hour:'2-digit',minute:'2-digit'})}</button>`
    ).join('');
    [...pills.querySelectorAll('.pill')].forEach((el,idx)=>{
      el.addEventListener('click', ()=> showDraw(Number(el.dataset.id)));
      if(idx===0) el.classList.add('active');
    });
    if(rows.length) showDraw(rows[0].id);
  }

  async function showDraw(id){
    [...document.querySelectorAll('.pill')].forEach(p=>p.classList.toggle('active', Number(p.dataset.id)===id));
    const d = upcoming.find(x=>x.id===id); if(!d) return;
    activeDraw = d;
    document.getElementById('drawNo').textContent = d.draw_no;
    document.getElementById('startsAt').textContent =
      new Date(d.start_time).toLocaleString('en-KE',{timeZone:'Africa/Nairobi',hour:'2-digit',minute:'2-digit',second:'2-digit'});

    // countdown
    const startMs = new Date(d.start_time).getTime();
    if(window.__cd) clearInterval(window.__cd);
    window.__cd = setInterval(()=>{
      const rem = Math.max(0, Math.floor((startMs - Date.now())/1000));
      const mm = String(Math.floor(rem/60)).padStart(2,'0');
      const ss = String(rem%60).padStart(2,'0');
      document.getElementById('countdown').textContent = `${mm}:${ss}`;
    }, 500);

    // selections
    const r = await fetch(`/api/colors/draws/${id}/selections`);
    const data = await r.json();

    const winGrid = document.getElementById('winGrid');
    winGrid.innerHTML = (data.winning_color||[]).map(s =>
      `<div>${ballHTML(s.label[0], colorClass(s.label), s.price, s.id)}</div>`
    ).join('');

    const numGrid = document.getElementById('numGrid');
    numGrid.innerHTML = (data.number_of_colors||[]).map(s =>
      `<div>${ballHTML(numLabel(s.label), 'num', s.price, s.id)}</div>`
    ).join('');

    // click to add
    [...document.querySelectorAll('.ball')].forEach(b=>{
      b.addEventListener('click', ()=>{
        const sid = Number(b.dataset.sel);
        const label = b.getAttribute('title');
        const price = Number(b.nextElementSibling?.textContent?.trim() || '1');
        betItems.push({ selection_id: sid, label, price });
        renderSlip();
      });
    });
  }

  function renderSlip(){
    const lines = document.getElementById('lines');
    let est = 1.0;
    lines.innerHTML = betItems.map((it, i)=> {
      est *= Number(it.price||1);
      return `<div class="betslip-line">
        <div>${i+1}. ${it.label}</div>
        <div>@ ${Number(it.price).toFixed(2)}</div>
      </div>`;
    }).join('') || `<div class="subtle">No selections yet.</div>`;
    document.getElementById('estOdds').textContent = est.toFixed(2);
  }

  document.getElementById('clear').addEventListener('click', ()=>{ betItems = []; renderSlip(); });

  document.getElementById('place').addEventListener('click', async ()=>{
    if(!betItems.length){ alert('Pick at least one selection'); return; }
    const payload = {
      agent_code: document.getElementById('agentCode').value || null,
      stake: Number(document.getElementById('stake').value || 0),
      items: betItems.map(b => ({ selection_id: b.selection_id }))
    };
    const r = await fetch('/api/tickets', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    const j = await r.json();
    if(!r.ok){ alert(j.error || 'Failed'); return; }
    alert(`Ticket #${j.ticket_id}\nStake: ${j.stake}\nPotential: ${j.potential_payout}`);
    betItems = []; renderSlip();
  });

  loadDraws();
</script>
</body>
</html>
