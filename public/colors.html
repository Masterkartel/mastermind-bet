<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Colors ‚Äî Mastermind Bet</title>
<link rel="icon" href="data:,">
<style>
  :root{
    --bg:#0a0f18; --felt:#102233; --panel:#0f1727; --panel-2:#17233b; --line:#1e3053;
    --text:#e9f2ff; --muted:#9ab3da; --accent:#ffb703; --green:#12d28a; --red:#ef476f;
  }
  *{box-sizing:border-box}
  body{margin:0;background:radial-gradient(1400px 700px at 20% -10%,#162846 0%,#0b1423 60%), var(--bg);
       color:var(--text);font:14px/1.35 system-ui,Segoe UI,Roboto,Helvetica,Arial}
  a{color:inherit;text-decoration:none}
  header{display:flex;align-items:center;gap:10px;padding:12px 16px;border-bottom:1px solid #0d1530;
         background:linear-gradient(180deg,#0e1830,#0a1327)}
  .brand{font-weight:800;letter-spacing:.5px}
  .nav{display:flex;gap:8px;flex-wrap:wrap;margin-left:8px}
  .pill{background:#101a2f;border:1px solid #243a63;color:#cfe0ff;padding:7px 10px;border-radius:999px}
  .pill:hover{filter:brightness(1.08)}
  .spacer{flex:1}
  .clock{font-variant-numeric:tabular-nums;color:var(--muted)}
  .header-balls{display:flex;gap:10px;margin-left:6px}
  .mini-ball{width:18px;height:18px;border-radius:50%;position:relative;
    box-shadow:inset 0 0 0 1px rgba(255,255,255,.1), 0 4px 8px rgba(0,0,0,.6)}
  .mini-ball.red{background:radial-gradient(circle at 30% 30%,#ff7a7a,#a40013 60%,#68000a)}
  .mini-ball.blue{background:radial-gradient(circle at 30% 30%,#7ab4ff,#0a46c0 60%,#052565)}
  .mini-ball.green{background:radial-gradient(circle at 30% 30%,#8ef0b2,#0a8e55 60%,#055132)}
  .mini-ball.yellow{background:radial-gradient(circle at 30% 30%,#fff3a3,#e0a000 60%,#8a5f00)}
  .mini-ball.purple{background:radial-gradient(circle at 30% 30%,#d6a8ff,#6a25c7 60%,#3e0c7e)}
  .mini-ball.orange{background:radial-gradient(circle at 30% 30%,#ffc28a,#d66a00 60%,#7c3600)}

  main{display:grid;grid-template-columns:1.6fr .9fr;gap:16px;padding:16px}
  .card{background:linear-gradient(180deg,#0f1a33,#0c1428); border:1px solid var(--line);
        border-radius:14px;overflow:hidden}
  .head{display:flex;align-items:center;gap:10px;padding:10px 12px;background:var(--panel-2);border-bottom:1px solid var(--line)}
  .head h2{margin:0;font-size:14px;letter-spacing:.3px}
  .sub{display:flex;gap:8px;align-items:center}
  .btn{background:var(--accent);border:0;border-radius:10px;padding:8px 12px;font-weight:700;color:#111;cursor:pointer}
  .btn.secondary{background:#1a2a48;color:#cfe0ff;border:1px solid #2a416b}
  .wrap{padding:12px}

  .cluster{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:14px}
  .tag{font-size:12px;color:#cfe0ff;background:#12203a;border:1px solid #1e345a;border-radius:8px;padding:6px 10px}

  /* glossy balls */
  .ball{width:64px;height:64px;border-radius:50%;position:relative;display:flex;align-items:center;justify-content:center;
        text-transform:uppercase;font-weight:900;letter-spacing:.5px;color:white;user-select:none;cursor:pointer}
  .ball:after{content:'';position:absolute;inset:-2px;border-radius:50%;
    box-shadow:inset 0 6px 18px rgba(255,255,255,.25), inset 0 -8px 18px rgba(0,0,0,.55), 0 15px 30px rgba(0,0,0,.6)}
  .ball .cap{position:absolute;top:4px;left:6px;width:24px;height:18px;border-radius:50%;
    background:radial-gradient(circle at 30% 30%, rgba(255,255,255,.95), rgba(255,255,255,.15) 65%, transparent 70%)}
  .ball .label{position:absolute;bottom:-18px;left:50%;transform:translateX(-50%);font-weight:700;
    font-size:12px;color:#d8e6ff}
  .ball .odd{position:absolute;bottom:-34px;left:50%;transform:translateX(-50%);
    background:#0f1a2f;border:1px solid #27406d;padding:3px 8px;border-radius:999px;font-size:12px}
  .red{background:radial-gradient(circle at 30% 30%,#ff8fa0,#c9184a 60%,#6a0016)}
  .blue{background:radial-gradient(circle at 30% 30%,#9bd0ff,#0d47c7 60%,#072b76)}
  .green{background:radial-gradient(circle at 30% 30%,#9bf3c6,#0f9d58 60%,#075f36)}
  .yellow{background:radial-gradient(circle at 30% 30%,#fff2a1,#f2a900 60%,#8a5e00)}
  .purple{background:radial-gradient(circle at 30% 30%,#e6c3ff,#7e33d6 60%,#471388)}
  .orange{background:radial-gradient(circle at 30% 30%,#ffd2a1,#e67300 60%,#8b3e00)}
  .black{background:radial-gradient(circle at 30% 30%,#5a5a5a,#101010 60%,#000)}

  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(90px,1fr));gap:26px}
  .hint{color:var(--muted);font-size:12px}

  /* draw toggles */
  .tabs{display:flex;gap:8px;flex-wrap:wrap}
  .tab{background:#111c31;border:1px solid #2a416b;border-radius:10px;padding:6px 10px;cursor:pointer;color:#cfe0ff}
  .tab.active{outline:2px solid var(--accent);color:#fff}

  /* slip */
  .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin:6px 0}
  input{background:#0f192b;border:1px solid #2a416b;color:#e6f0ff;border-radius:10px;padding:8px 10px}
  .totals{display:flex;justify-content:space-between;align-items:center;margin-top:6px;padding:10px;border-top:1px solid var(--line);background:#0e1830}
  .slipline{display:flex;gap:6px;align-items:center;background:#0f1a31;border:1px solid #243a63;border-radius:10px;padding:8px}
  .x{cursor:pointer;color:#ff9b9b}
</style>
</head>
<body>
<header>
  <div class="brand">üé± Colors ‚Äî Mastermind Bet</div>
  <div class="header-balls">
    <div class="mini-ball red"></div>
    <div class="mini-ball blue"></div>
    <div class="mini-ball green"></div>
    <div class="mini-ball yellow"></div>
    <div class="mini-ball purple"></div>
    <div class="mini-ball orange"></div>
  </div>
  <nav class="nav">
    <a class="pill" href="/pos">POS</a>
    <a class="pill" href="/dogs">Dogs</a>
    <a class="pill" href="/horses">Horses</a>
    <a class="pill" href="/colors">Colors</a>
    <a class="pill" href="/admin">Admin</a>
    <a class="pill" href="/history">History</a>
  </nav>
  <div class="spacer"></div>
  <div class="clock" id="clock">--:--</div>
</header>

<main>
  <section class="card">
    <div class="head" style="gap:12px;flex-wrap:wrap">
      <h2>Next Draw</h2>
      <div class="tabs" id="tabs"></div>
      <div class="spacer"></div>
      <div class="sub" id="subinfo">
        <span class="tag" id="drawNo">Draw #‚Äî</span>
        <span class="tag">Starts <span id="startLocal">--:--</span></span>
        <span class="tag" id="cd">‚è± 00:00</span>
      </div>
    </div>
    <div class="wrap">
      <div class="cluster"><span class="tag">WINNING COLOR</span></div>
      <div class="grid" id="colorsGrid"></div>
      <div class="cluster" style="margin-top:18px"><span class="tag">NUMBER OF COLORS</span></div>
      <div class="grid" id="countGrid"></div>
      <div class="hint" style="margin-top:10px">Tap a glossy ball to add to betslip. Odds shown under each ball.</div>
    </div>
  </section>

  <section class="card">
    <div class="head"><h2>Betslip</h2></div>
    <div class="wrap">
      <div class="row"><label>Agent Code</label><input id="agent" placeholder="optional e.g. AG001"></div>
      <div id="slip"></div>
      <div class="row"><label>Stake</label><input id="stake" type="number" min="20" value="50">
        <button class="btn" id="place">Place Bet</button>
        <button class="btn secondary" id="clear">Clear</button>
      </div>
      <div class="totals"><div>Lines: <b id="lineCount">0</b></div><div>Est. Odds: <b id="estOdds">1.00</b></div></div>
      <div class="hint" id="msg"></div>
    </div>
  </section>
</main>

<script>
const $ = s=>document.querySelector(s);
const colorsGrid = $('#colorsGrid');
const countGrid  = $('#countGrid');
const drawNo = $('#drawNo');
const startLocal = $('#startLocal');
const cd = $('#cd');
const tabs = $('#tabs');
const msg = $('#msg');

const state = { picks:[], startsAt: null, currentDrawId: null, countdownIv: null };

function tickClock(){
  const d = new Date();
  $('#clock').textContent = new Intl.DateTimeFormat(undefined,
    {hour:'2-digit',minute:'2-digit',second:'2-digit'}).format(d);
}
setInterval(tickClock,1000); tickClock();

function ballHtml({id, label, price, color, text}) {
  return `
    <div class="ball ${color}" onclick='addPick(${JSON.stringify({id, label, price})})' title="${label} @ ${price}">
      <div class="cap"></div>
      <div style="z-index:1;font-size:22px">${text}</div>
      <div class="label">${label}</div>
      <div class="odd">@ ${Number(price).toFixed(2)}</div>
    </div>`;
}

function renderSlip(){
  const slip = $('#slip');
  if(state.picks.length===0){ slip.innerHTML = '<div class="hint">No selections yet.</div>'; }
  else {
    slip.innerHTML = state.picks.map(p=>`
      <div class="slipline"><span>${p.label}</span>
      <b>@ ${Number(p.price).toFixed(2)}</b>
      <span class="x" onclick="removePick(${p.id})">‚úï</span></div>`).join('');
  }
  $('#lineCount').textContent = state.picks.length;
  const m = state.picks.reduce((a,b)=>a*Number(b.price),1)||1;
  $('#estOdds').textContent = m.toFixed(2);
}

function addPick(sel){ if(!state.picks.find(x=>x.id===sel.id)) state.picks.push(sel); renderSlip(); }
function removePick(id){ state.picks = state.picks.filter(x=>x.id!==id); renderSlip(); }
$('#clear').onclick = ()=>{ state.picks=[]; renderSlip(); };

async function get(path){ const r = await fetch(path); if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }

function mapColorNameToClass(name){
  const k = String(name||'').toUpperCase();
  if (k.includes('RED')) return 'red';
  if (k.includes('BLUE')) return 'blue';
  if (k.includes('GREEN')) return 'green';
  if (k.includes('YELLOW')) return 'yellow';
  if (k.includes('PURPLE')) return 'purple';
  if (k.includes('ORANGE')) return 'orange';
  return 'black';
}

function formatCountBallText(label){
  // show 0, 2+, 3+, 4+, 5+, 6
  const L = String(label||'').toUpperCase();
  if (/\b0\b|ZERO/.test(L)) return '0';
  if (/\b1\b|ONE/.test(L)) return '1';
  if (/\b2\b|TWO/.test(L)) return '2+';
  if (/\b3\b|THREE/.test(L)) return '3+';
  if (/\b4\b|FOUR/.test(L)) return '4+';
  if (/\b5\b|FIVE/.test(L)) return '5+';
  if (/\b6\b|SIX/.test(L)) return '6';
  const m = L.match(/\d+/); return m ? (Number(m[0]) >= 2 ? m[0]+'+' : m[0]) : L;
}

async function loadUpcoming(){
  const list = await get('/api/colors/draws?limit=5');
  tabs.innerHTML = list.map((d,i)=>{
    const t = new Date(d.start_time);
    const hh = new Intl.DateTimeFormat(undefined,{hour:'2-digit',minute:'2-digit'}).format(t);
    return `<div class="tab" data-id="${d.id}">#${d.draw_no} ‚Ä¢ ${hh}</div>`;
  }).join('') || '<span class="tag">No upcoming draws</span>';

  // click handlers
  [...tabs.querySelectorAll('.tab')].forEach(el=>{
    el.onclick = ()=> {
      [...tabs.children].forEach(t=>t.classList.remove('active'));
      el.classList.add('active');
      const id = Number(el.getAttribute('data-id'));
      loadDrawById(id).catch(err=>msg.textContent='Load failed: '+err.message);
    };
  });

  // auto-select first one
  const first = tabs.querySelector('.tab');
  if (first) first.click();
}

async function loadDrawById(id){
  const j = await get('/api/colors/draws/'+id);
  if(!j){ msg.textContent='No draw found.'; return; }
  state.currentDrawId = id;

  drawNo.textContent = 'Draw #'+j.draw.draw_no;
  const ts = new Date(j.draw.start_time);
  state.startsAt = ts.getTime();
  startLocal.textContent = new Intl.DateTimeFormat(undefined,{
    hour:'2-digit',minute:'2-digit',second:'2-digit',year:'numeric',month:'short',day:'numeric'
  }).format(ts);

  colorsGrid.innerHTML = (j.picks||[]).map(p=>{
    const c = mapColorNameToClass(p.color||p.name);
    const txt = (p.color||p.name||'')[0] || '?';
    return ballHtml({id:p.id,label:p.color||p.name,price:p.price,color:c,text:txt});
  }).join('');

  countGrid.innerHTML = (j.number_of_colors||[]).map(p=>{
    const txt = formatCountBallText(p.name);
    return ballHtml({id:p.id,label:p.name,price:p.price,color:'blue',text:txt});
  }).join('');

  startCountdown();
}

function startCountdown(){
  if(state.countdownIv) clearInterval(state.countdownIv);
  if(!state.startsAt) return;
  state.countdownIv = setInterval(()=>{
    const diff = Math.max(0, Math.floor((state.startsAt - Date.now())/1000));
    const m = String(Math.floor(diff/60)).padStart(2,'0');
    const s = String(diff%60).padStart(2,'0');
    cd.textContent = `‚è± ${m}:${s}`;
    if(diff===0){ clearInterval(state.countdownIv); setTimeout(loadUpcoming, 1500); }
  },1000);
}

$('#place').onclick = async ()=>{
  try{
    if(state.picks.length===0) throw new Error('Add selections first');
    const items = state.picks.map(p=>({selection_id:p.id}));
    const stake = Number($('#stake').value||0);
    const agent_code = ($('#agent').value||'').trim()||null;
    const res = await fetch('/api/tickets',{method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({agent_code,stake,items})});
    const j = await res.json();
    if(!res.ok) throw new Error(j.error||'Failed');
    msg.textContent = `‚úÖ Ticket #${j.ticket_id} placed. Potential ${j.potential_payout}`;
    state.picks=[]; renderSlip();
  }catch(e){ msg.textContent='‚ùå '+e.message; }
};

loadUpcoming().catch(e=>{msg.textContent='Failed to load: '+e.message});
</script>
</body>
</html>
