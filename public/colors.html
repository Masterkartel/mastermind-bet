<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Colors — Mastermind Bet</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="/styles.css">
  <style>
    :root{
      --bg:#0e1926; --panel:#0f2337; --muted:#8da2b6; --accent:#ffb300; --chip:#162a42;
      --ball-gloss:#ffffff30; --ball-shadow:#00000055; --odd-pill:#111b28; --ok:#00d67a;
    }
    body{background:radial-gradient(1200px 600px at 40% 0%,#0f2135 0%,#0b1623 55%,#08121d 100%), var(--bg); color:#d9e6f2; font:14px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial}
    a{color:#9fd1ff;text-decoration:none}
    .container{max-width:1280px;margin:28px auto;padding:0 18px}

    /* top nav */
    .nav{display:flex;align-items:center;gap:8px;margin-bottom:14px}
    .brand{font-weight:700;opacity:.95}
    .chip{background:var(--chip);border-radius:999px;padding:6px 10px;color:#bcd0e4;border:1px solid #1a3552}
    .right{margin-left:auto;opacity:.8}

    /* header balls banner */
    .banner-balls{display:flex;gap:8px;margin:6px 10px 0}
    .tiny-ball{width:14px;height:14px;border-radius:50%;box-shadow:inset 0 10px 16px #ffffff22, inset 0 -10px 16px #00000066, 0 2px 6px #0008}

    /* panels */
    .panel{background:linear-gradient(180deg,#0f2337,#0d1e2f);border:1px solid #122c46;border-radius:14px;padding:12px 14px;box-shadow:0 8px 25px #0006}
    .panel+h2,.panel+.panel{margin-top:12px}
    .panel-head{display:flex;align-items:center;gap:8px;margin-bottom:10px}
    .slots{display:flex;gap:8px;flex-wrap:wrap}
    .slot{background:#0d2033;border:1px solid #122c46;border-radius:12px;padding:10px 12px}

    /* draw chips (upcoming) */
    .draw-chips{display:flex;gap:6px;flex-wrap:wrap}
    .draw-chip{background:#142a45;border:1px solid #1a3552;border-radius:8px;padding:6px 8px;font-weight:600;cursor:pointer}
    .draw-chip.active{background:#1b3b60;border-color:#2b5b90;color:#fff}

    /* glossy pool balls */
    .balls{display:flex;gap:18px;flex-wrap:wrap}
    .ball{position:relative;width:70px;height:70px;border-radius:50%;
      display:grid;place-items:center;color:#fff;font-weight:800;
      box-shadow:inset 0 18px 28px var(--ball-gloss), inset 0 -18px 28px #00000088, 0 10px 18px var(--ball-shadow);
      border:1px solid #00000055; user-select:none; cursor:pointer; transition:transform .06s ease}
    .ball:hover{transform:translateY(-2px)}
    .ball .label{font-size:24px;letter-spacing:1px;text-shadow:0 2px 4px #0009}
    .odd{margin-top:6px;background:var(--odd-pill);display:inline-block;padding:2px 6px;border-radius:8px;color:#dfeafb;border:1px solid #1d334a;font-weight:700}

    /* color themes */
    .blue{background:radial-gradient(120% 100% at 60% 30%, #6bb6ff 0%, #0b6be8 38%, #0a3e9c 100%)}
    .green{background:radial-gradient(120% 100% at 60% 30%, #97f2a8 0%, #15c66a 40%, #0e7f49 100%)}
    .purple{background:radial-gradient(120% 100% at 60% 30%, #f5b8ff 0%, #bb35ff 40%, #6d1bb6 100%)}
    .yellow{background:radial-gradient(120% 100% at 60% 30%, #ffe39b 0%, #ffb700 40%, #a36e00 100%)}
    .black{background:radial-gradient(120% 100% at 60% 30%, #6a7892 0%, #253140 40%, #0c1119 100%)}

    /* layout blocks */
    .section-title{font-size:12px;color:#aac1d4;margin:12px 0 8px 4px;font-weight:700;letter-spacing:.4px}
    .grid{display:flex;gap:18px;flex-wrap:wrap}

    /* betslip */
    .betslip{min-height:210px}
    .row{display:flex;justify-content:space-between;align-items:center;margin:8px 0}
    .input{background:#0d2033;border:1px solid #173451;border-radius:8px;color:#e6f1ff;padding:8px 10px;min-width:220px}
    .btn{background:#ffb300;border:0;color:#1a2431;font-weight:800;padding:8px 14px;border-radius:8px;cursor:pointer}
    .btn:active{transform:translateY(1px)}

    .muted{color:#8da2b6;font-size:12px}
  </style>
</head>
<body>
  <div class="container">
    <div class="nav">
      <div class="brand">Colors — Mastermind Bet</div>
      <div class="banner-balls">
        <span class="tiny-ball blue"></span>
        <span class="tiny-ball green"></span>
        <span class="tiny-ball purple"></span>
        <span class="tiny-ball yellow"></span>
        <span class="tiny-ball black"></span>
      </div>
      <span class="chip"><a href="/pos">POS</a></span>
      <span class="chip"><a href="/dogs.html">Dogs</a></span>
      <span class="chip"><a href="/horses.html">Horses</a></span>
      <span class="chip"><a href="/admin.html">Admin</a></span>
      <span class="chip"><a href="/history.html">History</a></span>
      <div class="right" id="local-clock">--:--:--</div>
    </div>

    <div class="panel">
      <div class="panel-head">
        <div class="brand">Next Draw</div>
        <div class="draw-chips" id="drawChips"></div>
        <div class="right">
          <span class="chip" id="drawNo">Draw #–</span>
          <span class="chip" id="startsAt">Starts —</span>
          <span class="chip" id="countdown">00:00</span>
        </div>
      </div>

      <div class="section-title">WINNING COLOR</div>
      <div class="balls" id="winningRow"></div>

      <div class="section-title">NUMBER OF COLORS</div>
      <div class="balls" id="countRow"></div>

      <div class="muted" style="margin-top:10px">Tap a glossy ball to add to betslip. Odds shown under each ball.</div>
    </div>

    <div class="panel betslip">
      <div class="panel-head"><div class="brand">Betslip</div></div>
      <div class="row">
        <div>
          <input id="agentCode" class="input" placeholder="optional e.g. AG001"/>
          <input id="stake" class="input" style="width:100px" value="50"/>
          <button id="placeBtn" class="btn">Place Bet</button>
          <button id="clearBtn" class="chip">Clear</button>
        </div>
        <div class="muted">Lines: <span id="lineCount">0</span> &nbsp; · &nbsp; Est. Odds: <span id="estOdds">1.00</span></div>
      </div>
      <div id="lines" class="slots"></div>
    </div>
  </div>

  <script>
  // ===== Utilities
  const fmt2 = n => Number(n).toFixed(2);

  // ===== Live local clock
  setInterval(()=>{
    const d = new Date();
    const hh = String(d.getHours()).padStart(2,'0');
    const mm = String(d.getMinutes()).padStart(2,'0');
    const ss = String(d.getSeconds()).padStart(2,'0');
    document.getElementById('local-clock').textContent = `${hh}:${mm}:${ss}`;
  }, 500);

  // ===== Draw schedule (chips)
  async function loadSchedule(){
    const res = await fetch('/api/colors/draws-upcoming?limit=12');
    const draws = await res.json();
    const wrap = document.getElementById('drawChips');
    wrap.innerHTML = '';
    draws.forEach((d,idx)=>{
      const el = document.createElement('span');
      el.className = 'draw-chip' + (idx===0?' active':'');
      el.textContent = `#${d.draw_no} · ${new Date(d.start_time).toLocaleTimeString()}`;
      el.onclick = ()=>renderDraw(d);
      wrap.appendChild(el);
    });
    if (draws[0]) renderDraw(draws[0]);
  }

  // ===== Render a draw
  let timer=null;
  async function renderDraw(draw){
    // set header chips
    document.querySelectorAll('.draw-chip').forEach(c=>c.classList.remove('active'));
    [...document.querySelectorAll('.draw-chip')].find(c=>c.textContent.startsWith('#'+draw.draw_no))?.classList.add('active');
    document.getElementById('drawNo').textContent = `Draw #${draw.draw_no}`;
    document.getElementById('startsAt').textContent = 'Starts ' + new Date(draw.start_time).toLocaleString();

    // countdown
    if (timer) clearInterval(timer);
    timer = setInterval(()=>{
      const ms = new Date(draw.start_time) - new Date();
      const s = Math.max(0, Math.floor(ms/1000));
      const m = String(Math.floor(s/60)).padStart(2,'0');
      const ss = String(s%60).padStart(2,'0');
      document.getElementById('countdown').textContent = `${m}:${ss}`;
      if (s<=0) clearInterval(timer);
    }, 250);

    // fetch markets/selections for this draw
    const res = await fetch('/api/selections?color_draw_id='+draw.id);
    const rows = await res.json();
    const wins = rows.filter(r=>r.kind==='COLOR' && r.label==='WINNING COLOR');
    const nums = rows.filter(r=>r.kind==='COLOR' && r.label==='NUMBER OF COLORS');

    // map names -> colors for balls (change here if you want RED/BLUE/…)
    const colorMap = { BLUE:'blue', GREEN:'green', PURPLE:'purple', YELLOW:'yellow', BLACK:'black', RED:'yellow' /* fallback */ };

    const winWrap = document.getElementById('winningRow'); winWrap.innerHTML='';
    wins.forEach(w=>{
      const b = document.createElement('div');
      b.className = `ball ${colorMap[w.name]||'blue'}`;
      b.innerHTML = `<div class="label">${w.name[0]}</div><div class="odd">${fmt2(w.price)}</div>`;
      b.onclick = ()=>addLine(w);
      winWrap.appendChild(b);
    });

    const cntWrap = document.getElementById('countRow'); cntWrap.innerHTML='';
    nums.forEach(n=>{
      const b = document.createElement('div');
      b.className = 'ball blue';
      b.innerHTML = `<div class="label">${n.name}</div><div class="odd">${fmt2(n.price)}</div>`;
      b.onclick = ()=>addLine(n);
      cntWrap.appendChild(b);
    });
  }

  // ===== Betslip
  const slip = { lines:[], product:1.0 };
  function addLine(sel){
    slip.lines.push({ id:sel.id, text:`${sel.name} (${sel.label})`, price:Number(sel.price) });
    slip.product *= Number(sel.price);
    redrawSlip();
  }
  function redrawSlip(){
    const box=document.getElementById('lines'); box.innerHTML='';
    slip.lines.forEach((ln,i)=>{
      const el=document.createElement('div'); el.className='slot';
      el.innerHTML=`<strong>${i+1}.</strong> ${ln.text} &nbsp; <b>@ ${fmt2(ln.price)}</b>`;
      box.appendChild(el);
    });
    document.getElementById('lineCount').textContent = slip.lines.length;
    document.getElementById('estOdds').textContent = fmt2(slip.product||1);
  }
  document.getElementById('clearBtn').onclick=()=>{ slip.lines=[]; slip.product=1; redrawSlip(); };

  document.getElementById('placeBtn').onclick=async()=>{
    if(!slip.lines.length) return alert('Pick at least one selection');
    const stake = Number(document.getElementById('stake').value||0);
    if(!(stake>0)) return alert('Stake required');
    const payload={
      agent_code: (document.getElementById('agentCode').value||'').trim()||null,
      stake,
      items: slip.lines.map(l=>({ selection_id:l.id }))
    };
    const r = await fetch('/api/tickets',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    if(!r.ok){ const j=await r.json().catch(()=>({})); return alert('Failed: '+(j.error||r.status)); }
    const j=await r.json();
    alert('Ticket '+j.ticket_id+' placed');
    slip.lines=[]; slip.product=1; redrawSlip();
  };

  // boot
  loadSchedule().catch(console.error);
  </script>
</body>
</html>
