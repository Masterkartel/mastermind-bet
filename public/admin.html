<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Admin — Mastermind Bet</title>
<style>
  :root{--bg:#0b1a2b;--panel:#0f2238;--line:#123356;--line2:#163a5b;--text:#e7f0ff;--accent:#ffbe0b;--muted:#9fd0ff}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Ubuntu,Arial}
  .wrap{max-width:1000px;margin:28px auto;padding:0 14px}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:14px;margin-bottom:14px}
  input,button,textarea,select{padding:8px 10px;border-radius:8px;border:1px solid #1e4162;background:#0e2a46;color:var(--text);outline:none}
  button{background:var(--accent);color:#111;border:none;cursor:pointer;font-weight:700}
  button[disabled]{opacity:.6;cursor:not-allowed}
  h1{font-size:20px;margin:12px 0}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid var(--line2);padding:8px 6px;text-align:left;vertical-align:middle}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .muted{opacity:.85}
  .topbar{background:var(--line);padding:6px 10px;font-size:14px;text-align:right;color:var(--muted)}
  .floatbtn{padding:6px 10px;font-size:12px;margin-left:4px}
  .right{margin-left:auto}
  /* dialogs */
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:50}
  .dialog{width:min(520px,92vw);background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:16px}
  .dialog h2{margin:0 0 10px 0;font-size:18px}
  .grid{display:grid;grid-template-columns:120px 1fr;gap:8px;align-items:center}
  .grid label{color:#cfe4ff}
  .row-end{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
  .toast{position:fixed;right:10px;bottom:10px;background:#08304f;color:#cfe4ff;border:1px solid #0e426b;padding:10px 12px;border-radius:10px;display:none}
  .btnline > button{margin-right:6px}
</style>
</head>
<body>
<div class="topbar">
  <span id="clock">--:--:--</span> Nairobi Time
</div>

<div class="wrap">
  <div class="card" id="loginBox">
    <h1>Admin Login</h1>
    <div class="row">
      <input id="phone" value="0715151010" readonly/>
      <input id="password" type="password" placeholder="Password" value="Oury2933#"/>
      <button id="loginBtn">Login</button>
    </div>
    <div id="msg" class="muted"></div>
  </div>

  <div class="card" id="panel" style="display:none">
    <h1>Agents</h1>
    <div class="row">
      <input id="a_phone" placeholder="Phone (10 digits)" maxlength="10" />
      <input id="a_name" placeholder="Agent name"/>
      <input id="a_location" placeholder="Location (e.g. Umoja 2)"/>
      <input id="a_pin" placeholder="6 digit PIN" maxlength="6"/>
      <button id="createAgent">Create / Reset</button>
      <span class="right muted" id="list_hint"></span>
    </div>
    <div style="height:10px"></div>
    <table id="agentsTbl">
      <thead>
        <tr>
          <th>Phone</th><th>Name</th><th>Location</th><th>Status</th><th>Balance (KES)</th><th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="row" style="margin-top:10px">
      <button id="refresh">Refresh List</button>
      <button id="logout">Logout</button>
      <a href="/pos" class="right" style="color:#9fd0ff">Go to POS</a>
    </div>
  </div>
</div>

<!-- Adjust Float Dialog -->
<div class="overlay" id="dlg">
  <div class="dialog">
    <h2>Adjust Agent Float</h2>
    <div class="grid">
      <label>Agent</label><div id="dlg_agent" class="muted"></div>
      <label>Amount (KES)</label>
      <input id="dlg_amount" inputmode="numeric" placeholder="e.g. 1500 or -750" />
      <label>Note (optional)</label>
      <input id="dlg_note" placeholder="Reason e.g. top-up, correction"/>
      <label>Preview</label>
      <div id="dlg_preview" class="muted">KES 0.00</div>
    </div>
    <div class="row-end">
      <button id="dlg_cancel">Cancel</button>
      <button id="dlg_apply">Apply</button>
    </div>
  </div>
</div>

<!-- Reset PIN Dialog -->
<div class="overlay" id="pinDlg">
  <div class="dialog">
    <h2>Reset Agent PIN</h2>
    <div class="grid">
      <label>Agent</label><div id="pin_agent" class="muted"></div>
      <label>New PIN</label>
      <input id="pin_input" placeholder="000000" value="000000" maxlength="6" />
      <label>Hint</label>
      <div class="muted">Must be 6 digits. Default is <b>000000</b>.</div>
    </div>
    <div class="row-end">
      <button id="pin_cancel">Cancel</button>
      <button id="pin_apply">Reset PIN</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
const $ = s => document.querySelector(s);
function fmtKES(n){ return Number(n||0).toLocaleString('en-KE',{style:'currency',currency:'KES'}); }

async function me(){ const r = await fetch('/me'); return r.json(); }

async function login(){
  const phone = $('#phone').value.trim();
  const password = $('#password').value;
  const r = await fetch('/auth/admin/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({phone,password})});
  const j = await r.json();
  if(!r.ok){ $('#msg').textContent = j.error||'login failed'; return; }
  $('#loginBox').style.display='none';
  $('#panel').style.display='';
  loadAgents();
}

let agentsCache = [];
async function loadAgents(){
  const r = await fetch('/admin/api/agents/list');
  const rows = await r.json();
  agentsCache = rows;
  $('#list_hint').textContent = `${rows.length} agent${rows.length===1?'':'s'}`;
  const tb = $('#agentsTbl tbody');
  tb.innerHTML = rows.map(x=> `
    <tr>
      <td>${x.phone}</td>
      <td>${x.name||''}</td>
      <td>${x.location||'-'}</td>
      <td>${x.is_active?'Active':'Off'}</td>
      <td>${fmtKES(x.balance)}</td>
      <td class="btnline">
        <button class="floatbtn" onclick="openAdjust('${x.phone}')">Adjust…</button>
        <button class="floatbtn" onclick="openPin('${x.phone}')">Reset PIN</button>
      </td>
    </tr>`).join('');
}

// ---------- Adjust float ----------
let currentPhone = null;
function openAdjust(phone){
  currentPhone = phone;
  $('#dlg_agent').textContent = phone;
  $('#dlg_amount').value = '';
  $('#dlg_note').value = '';
  $('#dlg_preview').textContent = fmtKES(0);
  $('#dlg').style.display='flex';
  $('#dlg_amount').focus();
}
function closeAdjust(){ $('#dlg').style.display='none'; currentPhone = null; }
$('#dlg_cancel').onclick = closeAdjust;
$('#dlg_amount').addEventListener('input', ()=>{
  const v = Number($('#dlg_amount').value);
  $('#dlg_preview').textContent = Number.isFinite(v)&&v!==0 ? fmtKES(v) : 'KES 0.00';
});
$('#dlg_apply').onclick = async ()=>{
  const amount = Number($('#dlg_amount').value);
  const note = $('#dlg_note').value.trim();
  if(!currentPhone) return;
  if(!Number.isFinite(amount) || amount===0){ toast('Enter a non-zero numeric amount'); return; }
  const btn = $('#dlg_apply'); btn.disabled=true;
  try{
    const r = await fetch('/admin/api/agents/mint',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({phone: currentPhone, amount, note})});
    const j = await r.json(); if(!r.ok) throw new Error(j.error||'adjust failed');
    toast(`Adjusted ${currentPhone}: ${fmtKES(amount)}`);
    closeAdjust(); loadAgents();
  }catch(e){ toast(e.message||'Failed'); }
  finally{ btn.disabled=false; }
};

// ---------- Reset PIN ----------
let pinPhone = null;
function openPin(phone){
  pinPhone = phone;
  $('#pin_agent').textContent = phone;
  $('#pin_input').value = '000000';
  $('#pinDlg').style.display='flex';
  $('#pin_input').focus();
}
function closePin(){ $('#pinDlg').style.display='none'; pinPhone = null; }
$('#pin_cancel').onclick = closePin;
$('#pin_apply').onclick = async ()=>{
  if(!pinPhone) return;
  const pin = $('#pin_input').value.trim();
  if(!/^\d{6}$/.test(pin)){ toast('PIN must be exactly 6 digits'); return; }
  const btn = $('#pin_apply'); btn.disabled=true;
  try{
    const r = await fetch('/admin/api/agents/reset-pin',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({phone: pinPhone, new_pin: pin})});
    const j = await r.json(); if(!r.ok) throw new Error(j.error||'reset failed');
    toast(`Reset PIN for ${pinPhone} to ${j.pin}`);
    closePin();
  }catch(e){ toast(e.message||'Failed'); }
  finally{ btn.disabled=false; }
};

function toast(msg){ const t = document.getElementById('toast'); t.textContent = msg; t.style.display='block'; setTimeout(()=> t.style.display='none', 2800); }

document.getElementById('loginBtn').onclick = login;
document.getElementById('refresh').onclick = loadAgents;
document.getElementById('logout').onclick = async ()=>{ await fetch('/auth/logout',{method:'POST'}); location.reload(); };
document.getElementById('createAgent').onclick = async ()=>{
  const phone = document.getElementById('a_phone').value.trim();
  const name  = document.getElementById('a_name').value.trim();
  const location = document.getElementById('a_location').value.trim();
  const pin   = document.getElementById('a_pin').value.trim();
  if(!/^\d{10}$/.test(phone)) { toast('Phone must be 10 digits'); return; }
  if(!name) { toast('Name required'); return; }
  if(!/^\d{6}$/.test(pin)){ toast('PIN must be 6 digits'); return; }
  const r = await fetch('/admin/api/agents/create',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({phone,name,pin,location})});
  const j = await r.json(); if(!r.ok){ toast(j.error||'Create failed'); return; }
  toast('Agent created/reset');
  document.getElementById('a_phone').value=''; document.getElementById('a_name').value=''; document.getElementById('a_location').value=''; document.getElementById('a_pin').value='';
  loadAgents();
};

(async ()=>{
  const u = await me();
  if (u && u.role==='admin'){ document.getElementById('loginBox').style.display='none'; document.getElementById('panel').style.display=''; loadAgents(); }
  startClock();
})();

async function startClock(){
  async function tick(){
    try{
      const r = await fetch('/api/time'); const j = await r.json();
      if(j && j.unix_ms) document.getElementById('clock').textContent = new Date(j.unix_ms).toLocaleTimeString('en-KE');
    }catch{}
  }
  tick(); setInterval(tick,1000);
}
</script>
</body>
</html>
