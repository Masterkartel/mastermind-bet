<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Aviator (Shop Mode)</title>
<style>
  :root{
    --bg:#0a0e1a; --panel:#0e162b; --line:#24304f; --text:#e6edf3;
    --muted:#9aa4b2; --ok:#16a34a; --danger:#ef4444; --accent:#f43f5e;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,Arial,sans-serif;background:var(--bg);color:var(--text)}
  header{padding:10px 16px;border-bottom:1px solid var(--line);display:flex;align-items:center;gap:14px;justify-content:space-between}
  .brand{font-weight:900}
  .chip{padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#0f1933;color:#cfe1ff;text-decoration:none}
  .wrap{max-width:1300px;margin:0 auto;padding:14px;display:grid;gap:14px}

  /* Stage */
  .stage{background:radial-gradient(ellipse at 50% 35%, #0f2748 0 55%, #0b1426 60% 100%);
         border:1px solid var(--line);border-radius:18px;height:520px;position:relative;overflow:hidden}
  #cv{position:absolute;inset:0}
  .centerText{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:58px;text-shadow:0 5px 22px #0008;white-space:pre-line;text-align:center;pointer-events:none}
  .flew{color:#ff5a5a}
  .multi{color:#ffffff}
  .topbar{position:absolute;top:8px;left:12px;right:12px;display:flex;gap:10px;align-items:center;justify-content:space-between}
  .leftTB{display:flex;gap:10px;align-items:center}
  .pill{padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#0e172f;color:#cfe1ff;white-space:nowrap}
  .history{display:flex;gap:6px;align-items:center}
  .hx{font-weight:900;padding:2px 6px;border-radius:8px;background:#071024;border:1px solid #0f2347;font-size:12px;line-height:18px;white-space:nowrap}
  .hx.good{color:#22c55e;border-color:#1b4027;background:#0b2013}
  .hx.avg{color:#f59e0b;border-color:#4b3e12;background:#2b250f}
  .hx.bad{color:#ef4444;border-color:#4d1313;background:#3b0b0b}
  .dots{cursor:pointer;font-weight:900;font-size:16px;padding:0 6px;user-select:none}

  /* Player cards row */
  .players{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:12px;display:grid;gap:10px}
  .ttl{display:flex;align-items:center;justify-content:space-between;gap:10px}
  .tabs{display:flex;gap:6px}
  .tab{padding:6px 10px;border:1px solid var(--line);border-radius:10px;background:#0f1933;color:#e6edf3;cursor:pointer;font-weight:800}
  .tab.active{outline:2px solid #22c55e}
  label{font-size:12px;color:var(--muted)}
  input[type="number"]{width:100%;padding:10px;border-radius:10px;border:1px solid var(--line);background:#0d1428;color:#fff}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .btn{padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#0d1428;color:#fff;cursor:pointer;font-weight:800}
  .btn.green{background:#0f2b1b;border-color:#1b4d28}
  .btn.red{background:#3b0b0b;border-color:#4d1313}
  .kpi{font-size:12px;color:#b9c2cf}
  .tickets{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:12px}

  /* make stage responsive */
  @media (max-width:1100px){
    .players{grid-template-columns:1fr}
  }
</style>
</head>
<body>
<header>
  <div class="brand">Aviator (Shop Mode)</div>
  <div class="chip" id="clock">—</div>
</header>

<div class="wrap">
  <div class="stage">
    <div class="topbar">
      <div class="leftTB">
        <!-- compact history + inline expander -->
        <div class="history" id="history">
          <!-- pills injected -->
        </div>
        <span class="dots" id="hxMore" title="More results">⋯</span>
        <div class="pill" id="phasePill">BETTING</div>
        <!-- removed any extra messaging inside -->
      </div>
      <!-- right side empty to keep clean -->
      <div></div>
    </div>

    <!-- canvas (curve + trail) -->
    <canvas id="cv"></canvas>

    <!-- SVG plane (3x previous size), positioned via JS -->
    <svg id="plane" viewBox="0 0 180 100" width="180" height="100" style="position:absolute; left:0; bottom:0; transform-origin:50% 50%; pointer-events:none">
      <!-- Simple “real” airplane silhouette -->
      <g fill="#ff4757" stroke="#ff98a3" stroke-width="2">
        <!-- fuselage -->
        <path d="M10,55 L120,55 C142,55 158,48 168,42 L175,38 L168,60 C158,66 142,73 120,73 L10,73 Z"/>
        <!-- nose -->
        <path d="M175,38 L175,60 L178,52 Z"/>
        <!-- tail -->
        <path d="M10,55 L6,45 L18,55 Z"/>
        <!-- top wing -->
        <path d="M60,50 L120,40 L120,48 L60,58 Z"/>
        <!-- bottom wing -->
        <path d="M60,78 L120,70 L120,78 L60,86 Z"/>
      </g>
    </svg>

    <div class="centerText" id="centerText"></div>
  </div>

  <div class="players">
    <!-- Player A -->
    <div class="card" data-player="pA">
      <div class="ttl">
        <div><b>Player A</b> <span class="kpi">Bal: <b id="pA-bal">0</b> KES</span> <span class="kpi" id="pA-status">idle</span></div>
        <div class="tabs">
          <div class="tab active" data-mode="manual">Bet</div>
          <div class="tab" data-mode="auto">Auto</div>
        </div>
      </div>
      <div class="pane manual">
        <label>Stake (KES)</label>
        <input id="pA-stake" type="number" min="20" max="1000" value="100"/>
        <div class="row">
          <button class="btn green" id="pA-bet">Bet</button>
          <button class="btn red" id="pA-cash">Cash-Out</button>
        </div>
      </div>
      <div class="pane auto" style="display:none">
        <div class="row" style="width:100%">
          <div style="flex:1">
            <label>Stake (KES)</label>
            <input id="pA-auto-stake" type="number" min="20" max="1000" value="100"/>
          </div>
          <div style="flex:1">
            <label>Auto Cash-Out at (x)</label>
            <input id="pA-auto-x" type="number" step="0.01" min="1.05" value="1.10"/>
          </div>
        </div>
        <button class="btn green" id="pA-auto-on">Place Auto</button>
      </div>
      <div class="row">
        <div class="pill">Ticket: <b id="pA-ticket">—</b></div>
        <div class="pill">Payout: <b id="pA-payout">—</b></div>
      </div>
    </div>

    <!-- Player B -->
    <div class="card" data-player="pB">
      <div class="ttl">
        <div><b>Player B</b> <span class="kpi">Bal: <b id="pB-bal">0</b> KES</span> <span class="kpi" id="pB-status">idle</span></div>
        <div class="tabs">
          <div class="tab active" data-mode="manual">Bet</div>
          <div class="tab" data-mode="auto">Auto</div>
        </div>
      </div>
      <div class="pane manual">
        <label>Stake (KES)</label>
        <input id="pB-stake" type="number" min="20" max="1000" value="100"/>
        <div class="row">
          <button class="btn green" id="pB-bet">Bet</button>
          <button class="btn red" id="pB-cash">Cash-Out</button>
        </div>
      </div>
      <div class="pane auto" style="display:none">
        <div class="row" style="width:100%">
          <div style="flex:1">
            <label>Stake (KES)</label>
            <input id="pB-auto-stake" type="number" min="20" max="1000" value="100"/>
          </div>
          <div style="flex:1">
            <label>Auto Cash-Out at (x)</label>
            <input id="pB-auto-x" type="number" step="0.01" min="1.05" value="1.20"/>
          </div>
        </div>
        <button class="btn green" id="pB-auto-on">Place Auto</button>
      </div>
      <div class="row">
        <div class="pill">Ticket: <b id="pB-ticket">—</b></div>
        <div class="pill">Payout: <b id="pB-payout">—</b></div>
      </div>
    </div>

    <!-- Player C -->
    <div class="card" data-player="pC">
      <div class="ttl">
        <div><b>Player C</b> <span class="kpi">Bal: <b id="pC-bal">0</b> KES</span> <span class="kpi" id="pC-status">idle</span></div>
        <div class="tabs">
          <div class="tab active" data-mode="manual">Bet</div>
          <div class="tab" data-mode="auto">Auto</div>
        </div>
      </div>
      <div class="pane manual">
        <label>Stake (KES)</label>
        <input id="pC-stake" type="number" min="20" max="1000" value="100"/>
        <div class="row">
          <button class="btn green" id="pC-bet">Bet</button>
          <button class="btn red" id="pC-cash">Cash-Out</button>
        </div>
      </div>
      <div class="pane auto" style="display:none">
        <div class="row" style="width:100%">
          <div style="flex:1">
            <label>Stake (KES)</label>
            <input id="pC-auto-stake" type="number" min="20" max="1000" value="100"/>
          </div>
          <div style="flex:1">
            <label>Auto Cash-Out at (x)</label>
            <input id="pC-auto-x" type="number" step="0.01" min="1.05" value="1.50"/>
          </div>
        </div>
        <button class="btn green" id="pC-auto-on">Place Auto</button>
      </div>
      <div class="row">
        <div class="pill">Ticket: <b id="pC-ticket">—</b></div>
        <div class="pill">Payout: <b id="pC-payout">—</b></div>
      </div>
    </div>
  </div>

  <div class="tickets">
    <div class="kpi"><b>Recent Tickets (this terminal)</b></div>
    <div id="ticketsBox" class="kpi">No tickets yet.</div>
  </div>
</div>

<script>
/* ===== Config & helpers ===== */
const api  = location.origin.replace(/:\\d+$/, ':4000'); // keeps working behind nginx
const KES  = x => new Intl.NumberFormat('en-KE',{style:'currency',currency:'KES'}).format(Number(x||0));
const clamp= (n,min,max)=> Math.max(min, Math.min(max,n));

/* ===== Clock ===== */
const clk = document.getElementById('clock'); let skew=0;
async function syncClock(){ try{ const r=await fetch(\`\${api}/health\`); const j=await r.json(); skew=j.ts-Date.now(); }catch(e){} }
setInterval(()=>{ const d=new Date(Date.now()+skew); clk.textContent=d.toLocaleString(); }, 500); syncClock();

/* ===== Stage + Plane drawing ===== */
const cv = document.getElementById('cv'); const ctx=cv.getContext('2d');
const plane = document.getElementById('plane');
function fit(){
  cv.width=cv.clientWidth||cv.parentElement.clientWidth;
  cv.height=cv.clientHeight||520;
}
fit(); addEventListener('resize',fit);

const centerText = document.getElementById('centerText');
function mapMultiplierToProgress(mult){
  // progress grows slowly so clients can see; log curve for gentle takeoff
  const t = Math.log10(Math.max(1, mult)) / Math.log10(6); // 6x maps ~near end
  return Math.max(0, Math.min(1, t));
}

function draw(mult, phase){
  const w=cv.width, h=cv.height;
  ctx.clearRect(0,0,w,h);

  // define bottom-left origin with margins
  const left=50, bottom=h-40, right=w-40, top=40;
  const trackW = right-left, trackH = bottom-top;

  const progress = mapMultiplierToProgress(mult||1);
  const curveY = (p)=> bottom - (Math.pow(p, 2.2) * (trackH*0.85)); // soaring curve
  const x = left + progress * trackW;
  const y = curveY(progress);

  // red smoke/tail (area under curve) – only show while flying or just busted
  if (phase !== 'betting'){
    ctx.beginPath();
    ctx.moveTo(left, bottom);
    for (let i=0;i<=240;i++){
      const p=i/240;
      const xi = left + p*trackW;
      const yi = curveY(p);
      ctx.lineTo(xi, yi);
    }
    ctx.lineTo(right, bottom);
    ctx.closePath();
    ctx.fillStyle='rgba(239,68,68,0.28)';
    ctx.fill();
  }

  // Plane position (3x SVG already): anchor the plane so nose points along slope
  const dx = 1e-3 + trackW/240, dy = curveY(Math.min(1,progress+0.004)) - y;
  const angle = Math.atan2(-dy, dx) * 180/Math.PI; // negative dy because canvas Y grows downward
  plane.style.left = (x - 90) + 'px';   // center the 180px wide plane
  plane.style.top  = (y - 50) + 'px';   // center the 100px tall plane
  plane.style.transform = \`rotate(\${angle}deg)\`;

  // Center display text
  centerText.className='centerText '+(phase==='busted'?'flew':'multi');
  centerText.textContent=(phase==='busted'?'FLEW AWAY!\n':'')+(mult? \`\${Number(mult).toFixed(2)}x\` : '');
}

/* ===== History pills with inline expander ===== */
const phasePill = document.getElementById('phasePill');
const histBox = document.getElementById('history');
const dotsBtn = document.getElementById('hxMore');
let showCount = 10; // default visible
function renderHistory(arr){
  histBox.innerHTML='';
  const used = (arr||[]).slice(0, showCount);
  used.forEach(v=>{
    const d=document.createElement('div'); d.className='hx';
    if (v>=2) d.classList.add('good'); else if (v>=1.3) d.classList.add('avg'); else d.classList.add('bad');
    d.textContent=Number(v).toFixed(2)+'x'; histBox.appendChild(d);
  });
  dotsBtn.style.opacity = (arr && arr.length>showCount) ? 1 : 0.3;
}
dotsBtn.addEventListener('click', ()=>{ showCount = (showCount===10? 24 : 10); renderHistory(STATE.history); });

/* ===== Players / tickets ===== */
const tBox=document.getElementById('ticketsBox'); const tickets=[];
function addTicket(t){ tickets.unshift(t); renderTickets(); }
function renderTickets(){
  if(!tickets.length){ tBox.textContent='No tickets yet.'; return; }
  tBox.innerHTML='';
  tickets.slice(0,14).forEach(t=>{
    const d=document.createElement('div');
    const status = t.state + (t.hit? \` @ \${t.hit.toFixed(2)}x\` : '');
    d.innerHTML = \`<b>\${t.playerId}</b>: \${KES(t.stake)} \${t.autoCashOut?(\`auto@\${t.autoCashOut}x\`):''} — <b>\${status}</b>\` +
                  (t.payout? \` — \${KES(t.payout)}\` : '');
    tBox.appendChild(d);
  });
}
function markTicketsOnBust(mult){
  // any LIVE tickets become LOST (unless already CASHED)
  tickets.forEach(t=>{
    if (t.state==='LIVE'){ t.state='LOST'; t.hit=mult; t.payout=0; }
  });
  renderTickets();
}

/* ===== Wallet helpers ===== */
async function refreshBal(pid){
  try{
    const r=await fetch(\`\${api}/aviator/wallet/\${pid}\`);
    const j=await r.json();
    if(j && j.ok!==false){ const el=document.getElementById(\`\${pid}-bal\`); if(el) el.textContent=j.balance||0; }
  }catch(e){}
}

/* ===== Wire player cards ===== */
function wireCard(pid){
  const card=document.querySelector(\`.card[data-player="\${pid}"]\`);
  const tabs=card.querySelectorAll('.tab'); const manual=card.querySelector('.pane.manual'); const auto=card.querySelector('.pane.auto');
  tabs.forEach(tb=>tb.onclick=()=>{ tabs.forEach(x=>x.classList.remove('active')); tb.classList.add('active'); const m=tb.dataset.mode; manual.style.display=m==='manual'?'block':'none'; auto.style.display=m==='auto'?'block':'none'; });

  const status=card.querySelector(\`#\${pid}-status\`), tEl=card.querySelector(\`#\${pid}-ticket\`), pEl=card.querySelector(\`#\${pid}-payout\`);
  const stakeEl=card.querySelector(\`#\${pid}-stake\`), betBtn=card.querySelector(\`#\${pid}-bet\`), cashBtn=card.querySelector(\`#\${pid}-cash\`);
  const aStake=card.querySelector(\`#\${pid}-auto-stake\`), aX=card.querySelector(\`#\${pid}-auto-x\`), aBtn=card.querySelector(\`#\${pid}-auto-on\`);

  betBtn.onclick = async ()=>{
    const stake=clamp(Number(stakeEl.value||0),20,1000);
    try{
      const r=await fetch(\`\${api}/aviator/bet\`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({playerId:pid, stake})});
      const j=await r.json(); if(!j.ok) return alert(j.error||'Bet failed');
      status.textContent='LIVE'; tEl.textContent=j.ticketId; pEl.textContent='—';
      if(j.balance!=null){ const bal=document.getElementById(\`\${pid}-bal\`); if(bal) bal.textContent=j.balance; }
      addTicket({playerId:pid,ticketId:j.ticketId,stake,state:'LIVE'});
    }catch(e){ alert('Bet error'); }
  };
  cashBtn.onclick = async ()=>{
    try{
      const r=await fetch(\`\${api}/aviator/cashout\`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({playerId:pid})});
      const j=await r.json(); if(!j.ok) return alert(j.error||'Cashout failed');
      status.textContent='CASHED'; pEl.textContent=KES(j.payout);
      if(j.balance!=null){ const bal=document.getElementById(\`\${pid}-bal\`); if(bal) bal.textContent=j.balance; }
      const t=tickets.find(x=>x.playerId===pid && x.state==='LIVE'); if(t){ t.state='CASHED'; t.payout=j.payout; t.hit=j.multiplier; } renderTickets();
    }catch(e){ alert('Cashout error'); }
  };
  aBtn.onclick = async ()=>{
    const stake=clamp(Number(aStake.value||0),20,1000), x=clamp(Number(aX.value||0),1.05,1000);
    try{
      const r=await fetch(\`\${api}/aviator/bet\`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({playerId:pid, stake, autoCashOut:x})});
      const j=await r.json(); if(!j.ok) return alert(j.error||'Auto bet failed');
      if(j.balance!=null){ const bal=document.getElementById(\`\${pid}-bal\`); if(bal) bal.textContent=j.balance; }
      status.textContent='LIVE'; tEl.textContent=j.ticketId; pEl.textContent='—';
      addTicket({playerId:pid,ticketId:j.ticketId,stake,autoCashOut:x,state:'LIVE'});
    }catch(e){ alert('Auto bet error'); }
  };

  refreshBal(pid);
}
['pA','pB','pC'].forEach(wireCard);

/* ===== Polling & phase handling ===== */
let STATE = { phase:'betting', multiplier:1.00, history:[] };
let lastPhase = 'betting';
async function poll(){
  try{
    const r=await fetch(\`\${api}/aviator/state\`, {cache:'no-store'}); if(!r.ok) throw new Error();
    const j=await r.json();
    const phase = j.phase ? j.phase : (j.status==='RUNNING'?'flying': j.status==='BUST'?'busted':'betting');
    const multiplier = j.multiplier!=null ? Number(j.multiplier) : (j.liveMultiplier!=null? Number(j.liveMultiplier):1);
    STATE = { phase, multiplier, history: j.history||[] };

    // update UI
    phasePill.textContent = phase.toUpperCase();
    renderHistory(STATE.history);
    draw(multiplier, phase);

    // transitions -> ticket status updates
    if (lastPhase!=='busted' && phase==='busted'){
      markTicketsOnBust(multiplier);
    }
    if (lastPhase==='busted' && phase==='betting'){
      // round reset: set statuses of finished tickets to WON/LOST already, LIVE remains until cashed or lost at bust; nothing extra here
    }
    lastPhase = phase;
  }catch(e){
    phasePill.textContent='API unavailable';
  }
}
setInterval(poll, 150);
poll();
</script>
</body>
</html>
