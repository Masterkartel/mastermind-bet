<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Aviator (Shop Mode)</title>
<style>
  :root{ --bg:#0a0e1a; --panel:#0e162b; --line:#24304f; --text:#e6edf3; --muted:#9aa4b2; }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:Inter,system-ui,Arial,sans-serif;background:var(--bg);color:var(--text);}

  .header{display:flex;align-items:center;justify-content:flex-end;gap:10px;padding:8px 14px;border-bottom:1px solid var(--line);position:sticky;top:0;background:rgba(10,14,26,.85);backdrop-filter:blur(6px);z-index:20}
  .pill{padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#0e172f;color:#cfe1ff}
  .pill.click{cursor:pointer;user-select:none}
  .clock{min-width:220px;text-align:right}

  .wrap{max-width:100vw;margin:0 auto;padding:0;display:grid;gap:14px}

  .stage{
    position:relative;width:100%;height:min(62vh,620px);min-height:360px;border:1px solid var(--line);
    border-radius:18px;overflow:hidden;
    background: radial-gradient(120% 95% at 50% -20%, #163660 0 38%, #0f2748 39% 62%, #0b1426 63% 100%);
  }
  canvas#area{position:absolute;inset:0;z-index:1}
  .centerText{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
              font-weight:900;font-size:52px;text-shadow:0 5px 22px #0006;white-space:pre-line;text-align:center;
              z-index:3;pointer-events:none}
  .flew{color:#ff5a5a} .multi{color:#fff}

  .topbar{position:absolute;top:8px;left:12px;right:12px;display:flex;gap:10px;align-items:center;justify-content:flex-start;z-index:4}
  .leftTB{display:flex;gap:10px;align-items:center}
  .chipsRow{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
  .chip{font-weight:800;padding:4px 8px;border-radius:8px;background:#071024;border:1px solid #0f2347;font-size:12px;white-space:nowrap}
  .chip.good{color:#22c55e;border-color:#1b4027;background:#0b2013}
  .chip.avg{color:#f59e0b;border-color:#4b3e12;background:#2b250f}
  .chip.bad{color:#ef4444;border-color:#4d1313;background:#3b0b0b}
  .dotbtn{width:30px;height:30px;border-radius:8px;border:1px solid var(--line);background:#0b1324;color:#cfe1ff;cursor:pointer;font-weight:900}
  .expander{position:absolute;left:12px;right:12px;top:46px;display:none;z-index:3}
  .grid{display:flex;gap:6px;flex-wrap:wrap}

  .players{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-top:8px;padding:0 14px}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:12px;display:grid;gap:10px}
  .ttl{display:flex;align-items:center;justify-content:space-between;gap:10px}
  .tabs{display:flex;gap:6px}
  .tab{padding:6px 10px;border:1px solid var(--line);border-radius:10px;background:#0f1933;color:#e6edf3;cursor:pointer;font-weight:800}
  .tab.active{outline:2px solid #22c55e}
  label{font-size:12px;color:var(--muted)}
  input[type="number"]{width:100%;padding:10px;border-radius:10px;border:1px solid var(--line);background:#0d1428;color:#fff}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .btn{padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#0d1428;color:#fff;cursor:pointer;font-weight:800}
  .btn.green{background:#0f2b1b;border-color:#1b4d28}
  .btn.red{background:#3b0b0b;border-color:#4d1313}
  .kpi{font-size:12px;color:#b9c2cf}
  .tickets{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:12px;margin:0 14px 14px}

  .toaster{position:fixed;top:16px;right:16px;display:flex;flex-direction:column;gap:10px;z-index:50}
  .toast{background:#0f1933;border:1px solid #2a3b63;color:#e6edf3;padding:10px 12px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.35);opacity:0;transform:translateY(-6px);transition:opacity .18s ease, transform .18s ease}
  .toast.show{opacity:1;transform:none}
  .toast.success{border-color:#1d3f2a;background:#0e2217}
  .toast.error{border-color:#4d1a1a;background:#2a0e0e}
  .toast b{font-weight:900}

  @media (max-width:1100px){ .players{grid-template-columns:1fr} .centerText{font-size:44px} }
  @media (max-width:600px){ .centerText{font-size:36px} .stage{height:52vh} }
</style>
</head>
<body>
  <div class="header">
    <div class="pill click" id="soundBtn" title="Sound">ðŸ”‡</div>
    <div class="pill clock" id="clock">â€”</div>
  </div>

  <div class="wrap">
    <div class="stage">
      <div class="topbar">
        <div class="leftTB">
          <button class="dotbtn" id="moreBtn" title="More history">â‹¯</button>
          <div class="chipsRow" id="chips"></div>
        </div>
      </div>

      <div class="expander" id="expander"><div class="grid" id="drawerGrid"></div></div>
      <canvas id="area"></canvas>
      <div class="centerText" id="centerText">Place your betsâ€¦</div>
    </div>

    <!-- Players -->
    <div class="players">
      <!-- A -->
      <div class="card" data-player="pA">
        <div class="ttl">
          <div><b>Player A</b> <span class="kpi">Bal: <b id="pA-bal">0</b> KES</span> <span class="kpi" id="pA-status">idle</span></div>
          <div class="tabs"><div class="tab active" data-mode="manual">Bet</div><div class="tab" data-mode="auto">Auto</div></div>
        </div>
        <div class="pane manual">
          <label>Stake (KES)</label><input id="pA-stake" type="number" min="20" max="1000" value="100"/>
          <div class="row"><button class="btn green" id="pA-bet">Bet</button><button class="btn red" id="pA-cash">Cash-Out</button></div>
        </div>
        <div class="pane auto" style="display:none">
          <div class="row" style="width:100%">
            <div style="flex:1"><label>Stake (KES)</label><input id="pA-auto-stake" type="number" min="20" max="1000" value="100"/></div>
            <div style="flex:1"><label>Auto Cash-Out at (x)</label><input id="pA-auto-x" type="number" step="0.01" min="1.05" value="1.10"/></div>
          </div>
          <button class="btn green" id="pA-auto-on">Place Auto</button>
        </div>
        <div class="row"><div class="pill">Ticket: <b id="pA-ticket">â€”</b></div><div class="pill">Payout: <b id="pA-payout">â€”</b></div></div>
      </div>
      <!-- B -->
      <div class="card" data-player="pB">
        <div class="ttl">
          <div><b>Player B</b> <span class="kpi">Bal: <b id="pB-bal">0</b> KES</span> <span class="kpi" id="pB-status">idle</span></div>
          <div class="tabs"><div class="tab active" data-mode="manual">Bet</div><div class="tab" data-mode="auto">Auto</div></div>
        </div>
        <div class="pane manual">
          <label>Stake (KES)</label><input id="pB-stake" type="number" min="20" max="1000" value="100"/>
          <div class="row"><button class="btn green" id="pB-bet">Bet</button><button class="btn red" id="pB-cash">Cash-Out</button></div>
        </div>
        <div class="pane auto" style="display:none">
          <div class="row" style="width:100%">
            <div style="flex:1"><label>Stake (KES)</label><input id="pB-auto-stake" type="number" min="20" max="1000" value="100"/></div>
            <div style="flex:1"><label>Auto Cash-Out at (x)</label><input id="pB-auto-x" type="number" step="0.01" min="1.05" value="1.20"/></div>
          </div>
          <button class="btn green" id="pB-auto-on">Place Auto</button>
        </div>
        <div class="row"><div class="pill">Ticket: <b id="pB-ticket">â€”</b></div><div class="pill">Payout: <b id="pB-payout">â€”</b></div></div>
      </div>
      <!-- C -->
      <div class="card" data-player="pC">
        <div class="ttl">
          <div><b>Player C</b> <span class="kpi">Bal: <b id="pC-bal">0</b> KES</span> <span class="kpi" id="pC-status">idle</span></div>
          <div class="tabs"><div class="tab active" data-mode="manual">Bet</div><div class="tab" data-mode="auto">Auto</div></div>
        </div>
        <div class="pane manual">
          <label>Stake (KES)</label><input id="pC-stake" type="number" min="20" max="1000" value="100"/>
          <div class="row"><button class="btn green" id="pC-bet">Bet</button><button class="btn red" id="pC-cash">Cash-Out</button></div>
        </div>
        <div class="pane auto" style="display:none">
          <div class="row" style="width:100%">
            <div style="flex:1"><label>Stake (KES)</label><input id="pC-auto-stake" type="number" min="20" max="1000" value="100"/></div>
            <div style="flex:1"><label>Auto Cash-Out at (x)</label><input id="pC-auto-x" type="number" step="0.01" min="1.05" value="1.50"/></div>
          </div>
          <button class="btn green" id="pC-auto-on">Place Auto</button>
        </div>
        <div class="row"><div class="pill">Ticket: <b id="pC-ticket">â€”</b></div><div class="pill">Payout: <b id="pC-payout">â€”</b></div></div>
      </div>
    </div>

    <div class="tickets">
      <div class="kpi"><b>Recent Tickets (this terminal)</b></div>
      <div id="ticketsBox" class="kpi">No tickets yet.</div>
    </div>
  </div>

  <div id="toaster" class="toaster"></div>

<script>
/* endpoints */
const API = {
  health: () => '/health',
  aviState: () => '/aviator/state',
  walletGet: (pid) => `/aviator/wallet/${pid}`,
  walletLoad: () => '/aviator/wallet/load',
  bet: () => '/aviator/bet',
  cashout: () => '/aviator/cashout'
};
const KES  = x => new Intl.NumberFormat('en-KE',{style:'currency',currency:'KES'}).format(Number(x||0));
const clamp= (n,min,max)=> Math.max(min, Math.min(max,n));

/* Toasts */
const toaster=document.getElementById('toaster');
function notify(msg,type='info',ms=2400){
  const t=document.createElement('div');
  t.className='toast'+(type==='success'?' success':type==='error'?' error':'');
  t.textContent=msg; toaster.appendChild(t);
  requestAnimationFrame(()=>t.classList.add('show'));
  setTimeout(()=>{ t.classList.remove('show'); setTimeout(()=>t.remove(),180); }, ms);
}

/* SFX (tiny, inline) */
const sndBtn = document.getElementById('soundBtn');
const AudioCtx = window.AudioContext || window.webkitAudioContext;
let ACTX=null, MASTER=null, SOUND_ON=false;
function ensureAudio(){
  if (!ACTX){ ACTX = new AudioCtx(); MASTER = ACTX.createGain(); MASTER.gain.value = 0.18; MASTER.connect(ACTX.destination); }
}
function tone({type='sine',freq=440,dur=0.15,vol=0.35,attack=0.005,decay=0.12}){
  if(!SOUND_ON||!ACTX) return;
  const t=ACTX.currentTime; const o=ACTX.createOscillator(); const g=ACTX.createGain();
  o.type=type; o.frequency.setValueAtTime(freq,t);
  g.gain.setValueAtTime(0,t); g.gain.linearRampToValueAtTime(vol,t+attack); g.gain.linearRampToValueAtTime(0.0001,t+attack+decay);
  o.connect(g); g.connect(MASTER); o.start(t); o.stop(t+dur);
}
function sweepUp(f1=380,f2=1100,dur=0.5,type='sawtooth',vol=0.28){
  if(!SOUND_ON||!ACTX) return;
  const t=ACTX.currentTime; const o=ACTX.createOscillator(); const g=ACTX.createGain();
  o.type=type; o.frequency.setValueAtTime(f1,t); o.frequency.exponentialRampToValueAtTime(f2,t+dur);
  g.gain.setValueAtTime(0,t); g.gain.linearRampToValueAtTime(vol,t+0.03); g.gain.exponentialRampToValueAtTime(0.0001,t+dur);
  o.connect(g); g.connect(MASTER); o.start(t); o.stop(t+dur+0.02);
}
function sweepDown(f1=1500,f2=90,dur=0.5,type='triangle',vol=0.30){
  if(!SOUND_ON||!ACTX) return;
  const t=ACTX.currentTime; const o=ACTX.createOscillator(); const g=ACTX.createGain();
  o.type=type; o.frequency.setValueAtTime(f1,t); o.frequency.exponentialRampToValueAtTime(f2,t+dur);
  g.gain.setValueAtTime(0,t); g.gain.linearRampToValueAtTime(vol,t+0.02); g.gain.exponentialRampToValueAtTime(0.0001,t+dur);
  o.connect(g); g.connect(MASTER); o.start(t); o.stop(t+dur+0.02);
}
const SFX = {
  toggle(){ SOUND_ON=!SOUND_ON; if(SOUND_ON){ ensureAudio(); sndBtn.textContent='ðŸ”Š'; } else { sndBtn.textContent='ðŸ”‡'; } },
  play(name){
    if(!SOUND_ON) return;
    if(name==='bet') tone({type:'square',freq:920,dur:0.09,vol:0.22,attack:0.002,decay:0.07});
    if(name==='cash') { tone({type:'triangle',freq:720,dur:0.12,vol:0.26}); tone({type:'triangle',freq:1020,dur:0.16,vol:0.26}); }
    if(name==='takeoff') sweepUp(340,1400,0.55,'sawtooth',0.22);
    if(name==='bust') sweepDown(1600,110,0.55,'triangle',0.28);
  }
};
sndBtn.onclick = ()=>{ try{ SFX.toggle(); if(SOUND_ON&&ACTX.state==='suspended') ACTX.resume(); }catch{} };

/* ===== Clock & skew ===== */
const clk=document.getElementById('clock'); let healthSkew=0; /* (FIX) no duplicate gameSkew here */
async function syncClock(){ try{ const r=await fetch(API.health()); const j=await r.json(); healthSkew=j.ts-Date.now(); }catch{ clk.textContent='OFFLINE'; } }
setInterval(()=>{ const d=new Date(Date.now()+healthSkew); clk.textContent=d.toLocaleString(); }, 500); syncClock();

/* ===== Canvas ===== */
const cv=document.getElementById('area'); const ctx=cv.getContext('2d');
let cssW=0, cssH=0;

let tAccum = 0;

function drawSun(){
  const cx = cssW*0.5, cy = -cssH*0.12, r = cssH*0.85;
  const g = ctx.createRadialGradient(cx,cy, r*0.05, cx,cy, r);
  g.addColorStop(0, 'rgba(255,240,180,0.25)');
  g.addColorStop(0.35, 'rgba(255,200,120,0.12)');
  g.addColorStop(1, 'rgba(255,200,120,0)');
  ctx.fillStyle = g;
  ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.fill();
}

/* Stars */
const STARS=[];
function initStars(){
  STARS.length=0;
  const n = 120;
  for(let i=0;i<n;i++){
    STARS.push({
      x: Math.random()*cssW,
      y: Math.random()*cssH*0.8,
      r: 0.4 + Math.random()*1.2,
      a: 0.25 + Math.random()*0.55,
      w: 0.8 + Math.random()*1.6,
      ph: Math.random()*Math.PI*2
    });
  }
}
function drawStars(slideY){
  ctx.save();
  for(const s of STARS){
    const y = s.y - slideY*0.6;
    const tw = 0.6 + 0.4*Math.sin(s.w*tAccum + s.ph);
    ctx.fillStyle = `rgba(220,235,255,${s.a*tw})`;
    ctx.beginPath(); ctx.arc(s.x, y, s.r, 0, Math.PI*2); ctx.fill();
  }
  ctx.restore();
}

/* sizing */
function fit(){
  const rect=cv.parentElement.getBoundingClientRect();
  const dpr=Math.max(1, Math.min(3, window.devicePixelRatio||1));
  cssW = rect.width; cssH = cv.parentElement.clientHeight;
  cv.style.width = cssW+'px'; cv.style.height = cssH+'px';
  cv.width  = Math.round(cssW*dpr); cv.height = Math.round(cssH*dpr);
  ctx.setTransform(dpr,0,0,dpr,0,0);
  initStars();
}
fit(); addEventListener('resize',()=>requestAnimationFrame(fit));

/* Sky bits */
const SKY = { streaks:[], clouds:[] };
(function initSky(){
  SKY.streaks.length=0; SKY.clouds.length=0;
  const rnd=(a,b)=> a + Math.random()*(b-a);
  const LAYERS = [
    {n:28, sp:  16, len:[20,60], th:[1,2], a:0.10},
    {n:22, sp:  28, len:[30,90], th:[1,2], a:0.16},
    {n:16, sp:  42, len:[40,120],th:[1,2], a:0.22},
  ];
  LAYERS.forEach(L=>{ for(let i=0;i<L.n;i++){ SKY.streaks.push({ x:Math.random()*cssW, y:Math.random()*cssH, len:rnd(L.len[0],L.len[1]), th:rnd(L.th[0],L.th[1]), sp:L.sp*(0.7+Math.random()*0.6), a:L.a*(0.6+Math.random()*0.8) }); }});
  for(let i=0;i<7;i++){ SKY.clouds.push({ x:Math.random()*cssW, y:Math.random()*cssH*0.7, r:120+Math.random()*220, a:0.05+Math.random()*0.08, spx:2+Math.random()*3, spy:-4 - Math.random()*4 }); }
})();

/* contrail particles â€” kept in world coords and drawn inside transform */
const PARTICLES=[];
function spawnParticles(px,py,dt){
  const count = Math.min(30, Math.round(18 * dt * (0.6 + 1.1*progressVis)));
  for(let i=0;i<count;i++){
    PARTICLES.push({
      x: px + (Math.random()*6-3),
      y: py + (Math.random()*6-3),
      vx: -20 - Math.random()*22,
      vy:  6  + Math.random()*10,
      life: 0.9 + Math.random()*1.0,
      age: 0,
      r: 1.0 + Math.random()*1.4
    });
  }
}
function updateParticles(dt){
  for(let i=PARTICLES.length-1; i>=0; i--){
    const p = PARTICLES[i];
    p.age += dt;
    p.x += p.vx*dt;
    p.y += p.vy*dt;
    if (p.age > p.life) PARTICLES.splice(i,1);
  }
}
function drawParticles(){
  for(const p of PARTICLES){
    const a = Math.max(0, 1 - p.age/p.life) * 0.5;
    ctx.fillStyle = `rgba(255,180,210,${a})`;
    ctx.beginPath(); ctx.arc(p.x, p.y, p.r*(0.7+0.6*(1-p.age/p.life)), 0, Math.PI*2); ctx.fill();
  }
}

/* plane sprite */
const planeImg=new Image();
planeImg.src='data:image/svg+xml;utf8,'+encodeURIComponent(`
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 140 60">
  <g fill="#ff4d6d">
    <path d="M4 36 L62 30 L138 30 L110 40 L62 38 L4 36 Z" opacity=".65"/>
    <path d="M22 28 L66 20 L104 14 L122 18 L66 26 L22 28 Z"/>
    <path d="M110 18 L136 29 L110 34 Z"/>
    <rect x="61" y="24" width="10" height="6" rx="2" />
  </g>
</svg>`);

/* UI chips */
function chipClass(v){ return v>=2?'good':(v>=1.3?'avg':'bad'); }
const chipsBox=document.getElementById('chips'); const drawerGrid=document.getElementById('drawerGrid');
const expander=document.getElementById('expander'); const moreBtn=document.getElementById('moreBtn');
let expanded=false; moreBtn.onclick=()=>{ expanded=!expanded; expander.style.display=expanded?'block':'none'; };
function paintChips(list){
  chipsBox.innerHTML='';
  (list||[]).slice(0,6).forEach(v=>{
    const c=document.createElement('div'); c.className='chip '+chipClass(v);
    c.textContent=Number(v).toFixed(2)+'x'; c.title=c.textContent; chipsBox.appendChild(c);
  });
  drawerGrid.innerHTML='';
  (list||[]).slice(0,96).forEach(v=>{
    const d=document.createElement('div'); d.className='chip '+chipClass(v);
    d.textContent=Number(v).toFixed(2)+'x'; d.title=d.textContent; drawerGrid.appendChild(d);
  });
}
const centerText=document.getElementById('centerText');

/* ===== Flight model ===== */
let STATE={ phase:'betting', multiplier:1, bust:2, history:[], speed:0.46, roundId:'-' };
let gameSkew = 0;  // (FIX) declare only here, used for precise cashout timestamps

function minFrontSeconds(bust){
  if (!bust || bust <= 1.02) return 0.10;
  if (bust <= 1.10) return 0.9;
  if (bust <= 1.30) return 1.8;
  return 5.5;
}

let flightStartMs = 0;
let flightDurSec  = 6.0;
let progressVis   = 0;
let LAST_DRAW_MULT = 1.00;

const NOISE = { sx:0, sy:0, fx:0, fy:0, phx:0, phy:0 };
function mulberry32(a){ return function(){ let t=(a+=0x6D2B79F5); t=Math.imul(t^t>>>15,t|1); t^=t+Math.imul(t^t>>>7,t|61); return ((t^t>>>14)>>>0)/4294967296; } }
function seedFromString(s){ let h=2166136261>>>0; for(let i=0;i<s.length;i++){ h^=s.charCodeAt(i); h=Math.imul(h,16777619); } return h>>>0; }
function reseedNoise(roundId){
  const rnd = mulberry32(seedFromString(String(roundId||'x')));
  NOISE.sx = 0.0011 + rnd()*0.0012;
  NOISE.sy = 0.0036 + rnd()*0.0036;
  NOISE.fx = 1.0   + rnd()*1.2;
  NOISE.fy = 1.2   + rnd()*1.4;
  NOISE.phx= rnd()*Math.PI*2;
  NOISE.phy= rnd()*Math.PI*2;
}

function tFromMult(mult,bust){ if(!mult||mult<=1||!bust||bust<=1) return 0; return Math.min(1, Math.log(mult)/Math.log(bust)); }
function multFromT(t,bust){ const b=Math.max(1.000001,Number(bust||2)); return Math.pow(b, Math.max(0,Math.min(1,t))); }
function damp(cur,tgt,rate,dt){ const k=Math.exp(-rate*Math.max(0,dt)); return cur*k + tgt*(1-k); }

/* Path helpers */
const DIAG_END = 0.30;
function pathX(p, left, trackW){ const s = 1 - Math.exp(-2.4 * p); const base = left + trackW * DIAG_END * s; const wob = Math.pow(p,1.2)*(0.0011*trackW)*Math.sin(1.2*Math.PI*p); return base + wob; }
function pathY(p, baseY, bust){
  const steep = Math.log(Math.max(1.0001, Number(bust || 2)));
  const k   = 0.44 + 0.16 * steep;
  const pow = 1.05 + 0.10 * steep;
  return baseY - Math.pow(p, pow) * (baseY * (0.95 * k));
}

/* draw */
let lastTs=performance.now();
function draw(mult,phase,dt){
  ctx.clearRect(0,0,cssW,cssH);

  const left=0, baseY=cssH-1, trackW=cssW-1, bust=STATE.bust||2;

  // background
  const tSky = (phase==='flying') ? progressVis : (phase==='busted' ? 1 : 0);
  const slideY = tSky * cssH * 0.42;
  drawSun();
  drawStars(slideY);

  if (phase === 'busted') {
    centerText.className='centerText flew';
    centerText.textContent='FLEW AWAY!\n'+(mult?`${Number(mult).toFixed(2)}x`:``);
    LAST_DRAW_MULT = Number(mult||1);
    PARTICLES.length=0;
    return;
  }

  if (phase === 'betting'){
    centerText.className='centerText multi';
    centerText.textContent='Place your betsâ€¦';
    LAST_DRAW_MULT = 1.00;
    PARTICLES.length=0;
    return;
  }

  // FLYING
  const t = progressVis;

  // plane tip world coords
  const tipX=pathX(t, left, trackW), tipY=pathY(t, baseY, bust);

  // Follow-cam so plane never disappears; smaller margins on phones
  const isPhone = cssW < 640;
  const marginTop = cssH * (isPhone ? 0.40 : 0.28);
  const camDY = (tipY < marginTop) ? (marginTop - tipY) : 0;
  const camScale = (isPhone ? (1 + t*0.14) : (1 + t*0.18));

  ctx.save();
  ctx.translate(0, camDY);
  ctx.translate(left, baseY);
  ctx.scale(camScale, camScale);
  ctx.translate(-left, -baseY);

  // trail polygon
  const steps=Math.max(2, Math.floor(340*t));
  ctx.beginPath(); ctx.moveTo(left, baseY);
  for(let i=0;i<=steps;i++){ const p=i/340; ctx.lineTo(pathX(p,left,trackW), pathY(p,baseY,bust)); }
  ctx.strokeStyle='#ff4d6d'; ctx.lineWidth=2; ctx.stroke();

  ctx.lineTo(tipX, baseY); ctx.lineTo(left, baseY); ctx.closePath();
  ctx.fillStyle='rgba(255,77,109,0.18)'; ctx.fill();

  // particles (draw inside transform so positioning always matches plane)
  const p2 = Math.max(0, t - 0.010);
  const px2 = pathX(p2, left, trackW), py2 = pathY(p2, baseY, bust);
  spawnParticles(px2, py2, dt);
  updateParticles(dt);
  drawParticles();

  // plane sprite â€” half-size on phones
  const BASE_PLANE_SCALE = isPhone ? 0.75 : 1.5;   // (FIX) phone = half-size
  const w=140*BASE_PLANE_SCALE, h=60*BASE_PLANE_SCALE;
  const tailAx=4/140, tailAy=36/60;
  ctx.save(); ctx.translate(tipX, tipY); ctx.drawImage(planeImg, -w*tailAx, -h*tailAy, w, h); ctx.restore();

  ctx.restore();

  centerText.className='centerText multi';
  centerText.textContent = mult?`${Number(mult).toFixed(2)}x`:``;
  LAST_DRAW_MULT = Number(mult||1);
}

/* animation loop */
function tick(now){
  const dt=(now-lastTs)/1000; lastTs=now; tAccum += dt;

  let target = 0;
  if (STATE.phase==='flying'){
    const elapsedSec = Math.max(0, (now - flightStartMs)/1000);
    target = Math.min(1, elapsedSec / flightDurSec);
  } else if (STATE.phase==='busted'){
    target = 1;
  }

  const rate = (STATE.phase==='flying') ? 7.0 : 9.0;
  progressVis = damp(progressVis, target, rate, dt);

  const bust=Number(STATE.bust||2);
  const visualMult = (STATE.phase==='busted') ? Math.max(1, Number(STATE.multiplier||1))
                    : Math.max(1, multFromT(progressVis, bust));

  draw(visualMult, STATE.phase, dt);
  maybeNotifyAutoWins(visualMult);

  requestAnimationFrame(tick);
}
requestAnimationFrame(tick);

/* tickets */
const tBox=document.getElementById('ticketsBox'); const tickets=[];
function addT(t){ tickets.unshift(t); renderT(); }
function renderT(){
  if(!tickets.length){ tBox.textContent='No tickets yet.'; return; }
  tBox.innerHTML=''; tickets.slice(0,14).forEach(t=>{
    const d=document.createElement('div');
    const stat=t.state+(t.hit?` @ ${Number(t.hit).toFixed(2)}x`:``);
    d.innerHTML=`<b>${t.playerId}</b>: ${KES(t.stake)} ${t.autoCashOut?`auto@${t.autoCashOut}x`:''} â€” <b>${stat}</b>`+(t.payout?` â€” ${KES(t.payout)}`:'');
    tBox.appendChild(d);
  });
}
function markAllLiveAsLost(mult){ tickets.forEach(t=>{ if(t.state==='LIVE'){ t.state='LOST'; t.hit=mult; t.payout=0; } }); renderT(); }

/* Notify auto-cashout */
function maybeNotifyAutoWins(currentMult){
  if (STATE.phase!=='flying') return;
  tickets.forEach(t=>{
    if (t.state==='LIVE' && t.autoCashOut && !t._autoAnnounced && currentMult >= t.autoCashOut){
      const est = Math.min(t.stake * currentMult, 20000);
      notify(`Auto cash-out: ${KES(est)} at ${currentMult.toFixed(2)}x`, 'success');
      SFX.play('cash');
      t.state='CASHED'; t.payout=est; t.hit=currentMult; t._autoAnnounced=true;
      const statusEl=document.getElementById(`${t.playerId}-status`);
      const pEl=document.getElementById(`${t.playerId}-payout`);
      if(statusEl) statusEl.textContent='CASHED (auto)';
      if(pEl) pEl.textContent=KES(est);
      renderT();
    }
  });
}

/* polling */
let lastPhase='betting', lastRoundId='-';
async function poll(){
  try{
    const r=await fetch(API.aviState(),{cache:'no-store'}); if(!r.ok) throw 0;
    const j=await r.json();
    const phase = j.phase || (j.status==='RUNNING'?'flying': j.status==='BUST'?'busted':'betting');
    const m = j.multiplier!=null ? Number(j.multiplier) : (j.liveMultiplier!=null? Number(j.liveMultiplier):1);
    const history = Array.isArray(j.history)? j.history : [];
    const bust = Number(j.bust || j.bustAt || 2);
    const speed = Number(j.speed || 0.46);
    const roundId = j.roundId || '-';
    if (Number.isFinite(Number(j.serverNow))) gameSkew = Number(j.serverNow) - Date.now();

    if (lastPhase !== 'flying' && phase === 'flying'){
      const timeToBustSec = Math.log(Math.max(1.000001,bust)) / Math.max(0.01, speed);
      flightDurSec = Math.max(minFrontSeconds(bust), timeToBustSec);
      const offsetSec = Math.min(flightDurSec, Math.log(Math.max(1.000001,m)) / Math.max(0.01, speed));
      flightStartMs = performance.now() - offsetSec*1000;
      progressVis = 0;
      if (roundId !== lastRoundId){ reseedNoise(roundId); lastRoundId=roundId; }
      SFX.play('takeoff');
    }
    if (lastPhase !== 'busted' && phase === 'busted'){ markAllLiveAsLost(m); SFX.play('bust'); }

    STATE={ phase, multiplier:m, history, bust, speed, roundId };
    paintChips(history);
    lastPhase = phase;
  }catch{}
}
setInterval(poll, 220); poll();

/* wallet + controls */
async function refreshBal(pid){
  try{ const r=await fetch(API.walletGet(pid)); const j=await r.json();
       if(j && j.ok!==false){ const el=document.getElementById(`${pid}-bal`); if(el) el.textContent=j.balance||0; return j.balance||0; }
  }catch{}
  return 0;
}
async function ensureMinBalance(pid, min=100){
  const bal=await refreshBal(pid);
  if (bal<min){ try{ await fetch(API.walletLoad(),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({playerId:pid, amount:2000})}); await refreshBal(pid);}catch{} }
}
function wireCard(pid){
  const card=document.querySelector(`.card[data-player="${pid}"]`);
  const tabs=card.querySelectorAll('.tab'); const manual=card.querySelector('.pane.manual'); const auto=card.querySelector('.pane.auto');
  tabs.forEach(tb=>tb.onclick=()=>{ tabs.forEach(x=>x.classList.remove('active')); tb.classList.add('active'); const m=tb.dataset.mode; manual.style.display=m==='manual'?'block':'none'; auto.style.display=m==='auto'?'block':'none'; });

  const status=card.querySelector(`#${pid}-status`), tEl=card.querySelector(`#${pid}-ticket`), pEl=card.querySelector(`#${pid}-payout`);
  const stakeEl=card.querySelector(`#${pid}-stake`), betBtn=card.querySelector(`#${pid}-bet`), cashBtn=card.querySelector(`#${pid}-cash`);
  const aStake=card.querySelector(`#${pid}-auto-stake`), aX=card.querySelector(`#${pid}-auto-x`), aBtn=card.querySelector(`#${pid}-auto-on`);

  betBtn.onclick=async ()=>{
    const stake=clamp(Number(stakeEl.value||0),20,1000);
    try{
      const r=await fetch(API.bet(),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({playerId:pid, stake})});
      const j=await r.json(); if(!j.ok) return notify(j.error||'Bet failed','error');
      status.textContent='LIVE'; tEl.textContent=j.ticketId; pEl.textContent='â€”';
      addT({playerId:pid,ticketId:j.ticketId,stake,state:'LIVE'});
      notify(`Bet placed: ${KES(stake)}`, 'success', 1600);
      SFX.play('bet');
      await refreshBal(pid);
    }catch{ notify('Network error placing bet','error'); }
  };
  cashBtn.onclick=async ()=>{
    const serverClickTs = Math.round(Date.now() + gameSkew);
    const uiMult = Number(LAST_DRAW_MULT||1);
    try{
      const r=await fetch(API.cashout(),{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({playerId:pid, clientTs: serverClickTs, uiMult})
      });
      const j=await r.json(); if(!j.ok) return notify(j.error||'Cashout failed','error');
      status.textContent='CASHED'; pEl.textContent=KES(j.payout);
      const t=tickets.find(x=>x.playerId===pid && x.state==='LIVE');
      if(t){ t.state='CASHED'; t.payout=j.payout; t.hit=j.multiplier; }
      renderT();
      notify(`Cashout: ${KES(j.payout)} at ${Number(j.multiplier).toFixed(2)}x`, 'success');
      SFX.play('cash');
      await refreshBal(pid);
    }catch{ notify('Network error during cashout','error'); }
  };
  aBtn.onclick=async ()=>{
    const stake=clamp(Number(aStake.value||0),20,1000), x=clamp(Number(aX.value||0),1.05,1000);
    try{
      const r=await fetch(API.bet(),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({playerId:pid, stake, autoCashOut:x})});
      const j=await r.json(); if(!j.ok) return notify(j.error||'Auto bet failed','error');
      status.textContent='LIVE'; tEl.textContent=j.ticketId; pEl.textContent='â€”';
      addT({playerId:pid,ticketId:j.ticketId,stake,autoCashOut:x,state:'LIVE'});
      notify(`Auto bet placed: ${KES(stake)} @ ${x}x`, 'success', 1700);
      SFX.play('bet');
      await refreshBal(pid);
    }catch{ notify('Network error placing auto bet','error'); }
  };

  ensureMinBalance(pid, 100);
}
['pA','pB','pC'].forEach(wireCard);
</script>
</body>
</html>
