<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Cashier</title>
  <style>
    :root{
      --bg:#070b16; --panel:#0b1428; --line:#1c2741; --text:#e6edf3; --muted:#9aa4b2;
      --accent:#22c55e; --danger:#ef4444; --warn:#f59e0b; --chip:#0f1a33; --ink:#0e172f;
      --sky1:#122445; --sky2:#0b1324;
      --dial-bg:#0d1428; --dial-fg:#22c55e; --dial-warn:#f59e0b; --dial-live:#ef4444;
      --maxw:100%;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;font-family:Inter,system-ui,Arial,sans-serif;
      background:radial-gradient(140% 120% at 50% -20%, var(--sky1) 0 45%, var(--sky2) 46% 100%);
      color:var(--text)
    }
    a{color:#7dd3fc}

    /* Header */
    header{
      position:sticky; top:0; z-index:50; display:flex; align-items:center; gap:12px;
      padding:10px 16px; border-bottom:1px solid var(--line);
      background:rgba(8,12,24,.85); backdrop-filter:blur(6px)
    }
    .brand{font-weight:900;letter-spacing:.3px;font-size:16px}
    .grow{flex:1}
    .pill{padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#0d1428;font-size:12px}
    .clock{min-width:220px;text-align:right}

    /* Round dial (circular clock countdown) */
    .roundbar{display:flex;align-items:center;gap:10px}
    .dial{
      --p:0deg; --col:var(--dial-fg);
      width:34px;height:34px;border-radius:50%;
      background:
        conic-gradient(var(--col) var(--p), #0000 var(--p)),
        radial-gradient(circle 15px, #0000 14px, var(--dial-bg) 15px);
      border:1px solid var(--line);
      position:relative;
    }
    .dial.live{ --col: var(--dial-live); animation:pulse 1.1s infinite alternate; }
    @keyframes pulse{ from{filter:brightness(1)} to{filter:brightness(1.25)} }
    .roundtxt{display:flex;flex-direction:column;line-height:1}
    .roundtxt b{font-size:12px}
    .roundtxt small{font-size:11px;color:var(--muted)}

    /* Layout */
    .container{max-width:var(--maxw);margin:0 auto;padding:10px 10px 14px;display:grid;grid-template-columns:2fr 1fr;gap:14px}
    @media (max-width:1100px){ .container{grid-template-columns:1fr} }

    .panel{background:var(--panel);border:1px solid var(--line);border-radius:18px;padding:12px}
    .title{font-weight:900;margin-bottom:8px}
    .muted{color:var(--muted);font-size:12px}
    .divider{height:1px;background:var(--line);margin:10px 0}

    /* Tabs & chips */
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
    .tab{padding:8px 12px;border:1px solid var(--line);border-radius:12px;background:#0f1933;color:#e6edf3;cursor:pointer;font-weight:800}
    .tab.active{outline:2px solid var(--accent)}
    .chips{display:flex;gap:6px;flex-wrap:wrap}
    .chip{padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#0f1933;cursor:pointer}
    .chip.active{outline:2px solid var(--accent)}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}

    /* Grids & selectors */
    .grid{display:grid;gap:10px}
    .list{border:1px dashed var(--line);border-radius:12px;padding:10px}
    .sel{padding:10px;border:1px solid var(--line);border-radius:10px;background:#0d1428;cursor:pointer;text-align:center}
    .sel:hover{outline:2px solid #1f6feb44}

    /* Markets toggle (horizontal) */
    .markets{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0 10px}
    .mkt{padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#0f1933;cursor:pointer;font-size:12px}
    .mkt.active{outline:2px solid #22c55e}

    /* Fixture card */
    .fx{display:grid; gap:8px; margin-bottom:10px}
    .fx-head{display:flex; align-items:center; justify-content:space-between; gap:8px}
    .teams{display:flex; align-items:center; gap:10px; font-weight:800}
    .club{display:flex; align-items:center; gap:6px}
    .logo{width:26px;height:26px;border-radius:50%;background:#0b1324;border:1px solid #1c2741;object-fit:cover}
    .ph{width:26px;height:26px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;background:#10203c;color:#9fb3d4;font-weight:900}

    /* Racing lanes (dogs/horses) — 8 lanes for horses fixed */
    .track{position:relative;height:186px;border:1px dashed var(--line);border-radius:14px;margin:10px 0 6px;
      background:
        linear-gradient(90deg,#0b1324 0 10px, #12203f 10px 12px, transparent 12px),
        repeating-linear-gradient(to bottom, #0f1629 0, #0f1629 26px, #0b1324 26px, #0b1324 28px);
      overflow:hidden}
    .runner{position:absolute;left:8px;width:42px;height:20px;background:#e5e7eb;border-radius:3px 10px 10px 3px;
      box-shadow:0 0 6px #fff2, inset 0 -2px 3px #0003}
    .runner:after{content:"";position:absolute;right:-6px;top:6px;width:8px;height:8px;border-radius:50%;background:#e5e7eb;box-shadow:0 0 5px #fff4}

    /* Balls (Colors & Numbers) */
    .balls{display:grid;gap:10px}
    .balls.colors{grid-template-columns:repeat(6,1fr)}
    .balls.numbers{grid-template-columns:repeat(7,1fr)}
    .ball{
      height:48px;width:48px;border-radius:50%;
      display:flex;align-items:center;justify-content:center;
      font-weight:900;color:#fff;border:2px solid #00000040;
      position:relative;box-shadow:inset -6px -8px 14px #00000055, inset 6px 6px 14px #ffffff1a, 0 2px 6px #00000066;
      cursor:pointer;user-select:none
    }
    .ball::after{
      content:""; position:absolute; top:6px; left:8px; width:18px; height:10px;
      background:radial-gradient(circle at 10px 5px, #ffffffcc, #ffffff22 60%, #ffffff00 100%);
      border-radius:50%; filter:blur(0.3px);
    }
    .RED{background:#ef4444}
    .BLUE{background:#3b82f6}
    .GREEN{background:#10b981}
    .YELLOW{background:#f59e0b}
    .PURPLE{background:#a855f7}
    .BLACK{background:#111827;color:#e5e7eb;border-color:#000}

    /* Betslip & tickets */
    .betslip{display:grid;gap:8px}
    input,button,select{font-family:inherit}
    input[type="number"], input[type="text"]{width:100%;padding:10px;border-radius:10px;border:1px solid var(--line);background:#0d1428;color:#fff}
    .btn{padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#0d1428;color:#fff;cursor:pointer;font-weight:800}
    .btn.primary{background:#0f2b1b;border-color:#1b4d28}
    .ticket{position:relative;padding:8px;border:1px dashed var(--line);border-radius:10px;margin-bottom:6px;background:#0c162c}
    .wm{position:absolute;inset:8px;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:28px;
      color:#fff1; pointer-events:none; transform:rotate(-18deg)}
    .wm.OPEN{color:#7dd3fc22}
    .wm.WON{color:#22c55e22}
    .wm.LOST{color:#ef444422}

    /* Toasts */
    .toaster{position:fixed;top:16px;right:16px;display:flex;flex-direction:column;gap:10px;z-index:9999}
    .toast{background:#0f1933;border:1px solid #2a3b63;color:#e6edf3;padding:10px 12px;border-radius:12px;
      box-shadow:0 8px 24px rgba(0,0,0,.35);opacity:0;transform:translateY(-6px);transition:opacity .18s ease, transform .18s ease}
    .toast.show{opacity:1;transform:none}
    .toast.success{border-color:#1d3f2a;background:#0e2217}
    .toast.error{border-color:#4d1a1a;background:#2a0e0e}
  </style>
</head>
<body>
<header>
  <div class="brand">Cashier</div>
  <div class="grow"></div>

  <!-- Global live clock -->
  <div class="pill clock" id="clock">—</div>

  <!-- Aviator link on right -->
  <a href="/aviator" class="pill" style="display:flex;gap:6px;align-items:center;background:#0e172f;margin-left:6px">
    <img src="/static/img/aviator-icon.png" alt="Aviator" style="width:18px;height:18px;border-radius:50%"/>
    <span style="font-weight:800">Aviator</span>
  </a>
</header>

<div class="container">
  <!-- LEFT -->
  <div class="panel">
    <div class="tabs">
      <div class="tab active" data-tab="football">Football</div>
      <div class="tab" data-tab="dogs">Dogs</div>
      <div class="tab" data-tab="horses">Horses</div>
      <div class="tab" data-tab="colors">Colors & Numbers</div>
    </div>

    <!-- Round dial + label -->
    <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:6px">
      <div class="roundbar">
        <div id="dial" class="dial" title="Round timer"></div>
        <div class="roundtxt">
          <b id="liveText">—</b>
          <small id="roundLabel">—</small>
        </div>
      </div>
      <div class="pill" id="roundTimer">Next in —</div>
    </div>

    <!-- Football league chips -->
    <div class="chips" id="leagueChips" style="display:flex"></div>

    <div id="stage" class="grid"></div>
  </div>

  <!-- RIGHT -->
  <div class="panel">
    <div class="title">Controls</div>
    <div class="row">
      <div class="pill" id="cashierIdShow">Cashier: <b id="cashierId">shop-1</b></div>
      <div class="pill">Balance: <b id="cashBal">0 KES</b></div>
      <input id="cashierIdInput" value="shop-1" style="max-width:160px">
      <button class="btn" onclick="applyCashier()">Set</button>
      <button class="btn" onclick="topupCashier(5000)">Top-up 5,000</button>
    </div>
    <div class="divider"></div>

    <div>
      <div class="title">Aviator Players — Wallets</div>
      <div class="row">
        <select id="aviPlayer">
          <option value="pA">Player A</option>
          <option value="pB">Player B</option>
          <option value="pC">Player C</option>
        </select>
        <input id="aviAmount" type="number" value="1000" min="1" style="max-width:120px" />
        <button class="btn" onclick="aviLoad()">Load</button>
        <button class="btn" onclick="aviView()">View</button>
        <button class="btn" onclick="aviClear()">Pay & Clear</button>
        <div class="pill" id="aviBal">Bal: —</div>
      </div>
    </div>

    <div class="divider"></div>

    <div>
      <div class="title">Up Next</div>
      <div id="next" class="list"></div>
      <div class="divider"></div>
      <div class="row" style="justify-content:space-between">
        <div class="title">History</div>
        <input id="historySearch" placeholder="Scan / type Ref or Code…" style="max-width:220px"/>
      </div>
      <div id="tickets" class="list"></div>
    </div>

    <div class="divider"></div>

    <div>
      <div class="title">Betslip</div>
      <div class="betslip" id="betslip" style="display:none">
        <div class="muted" id="currentSel">No selection</div>
        <input id="stake" type="number" min="20" max="1000" value="100" placeholder="Stake (KES)"/>
        <div class="row"><div class="pill">Odds: <b id="odds">—</b></div><div class="pill">Potential: <b id="payout">—</b></div></div>
        <button class="btn primary" onclick="placeBet()">Place Bet</button>
        <div class="muted">Min 20, Max 1000, Max Payout 20,000</div>
      </div>
      <div id="noSlip" class="muted">Click a market to build a betslip.</div>
    </div>
  </div>
</div>

<!-- Toaster -->
<div id="toaster" class="toaster"></div>

<script>
/* ---------------- Toasts ---------------- */
const toaster=document.getElementById('toaster');
function notify(msg,type='info',ms=2200){
  const t=document.createElement('div');
  t.className='toast'+(type==='success'?' success':type==='error'?' error':'');
  t.textContent=msg; toaster.appendChild(t);
  requestAnimationFrame(()=>t.classList.add('show'));
  setTimeout(()=>{ t.classList.remove('show'); setTimeout(()=>t.remove(),180); }, ms);
}

/* ---------------- Basics ---------------- */
const api = location.origin.replace(/:\\d+$/, ':4000');
const KES = (x)=> new Intl.NumberFormat('en-KE',{style:'currency',currency:'KES'}).format(Number(x||0));
function el(id){ return document.getElementById(id); }

/* Global clock (sync) */
let healthSkew=0;
async function syncClock(){ try{ const r=await fetch(`${api}/health`); const j=await r.json(); healthSkew=j.ts-Date.now(); }catch{} }
setInterval(()=>{ const d=new Date(Date.now()+healthSkew); el('clock').textContent=d.toLocaleString(); }, 500); syncClock();

/* Cashier */
let CASHIER_ID = 'shop-1';
async function refreshCashier(){
  try{ const r=await fetch(`${api}/cashier/${CASHIER_ID}/balance`); const j=await r.json();
    el('cashBal').textContent = KES(j.balance||0);
    el('cashierId').textContent = CASHIER_ID;
  }catch{}
}
async function topupCashier(amount){
  await fetch(`${api}/cashier/topup`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({cashierId:CASHIER_ID,amount})});
  refreshCashier();
}
function applyCashier(){ CASHIER_ID = el('cashierIdInput').value || 'shop-1'; refreshCashier(); }

/* Aviator wallets */
async function aviView(){
  const pid=el('aviPlayer').value; try{
    const r=await fetch(`${api}/aviator/wallet/${pid}`); const j=await r.json();
    el('aviBal').textContent = `Bal: ${KES(j.balance||0)}`;
  }catch{ el('aviBal').textContent='Bal: —'; }
}
async function aviLoad(){
  const pid=el('aviPlayer').value; const amt=Number(el('aviAmount').value||0)||0;
  if (amt===0) return notify('Enter amount to load.', 'error');
  try{
    const r=await fetch(`${api}/aviator/wallet/load`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({playerId:pid, amount:amt})});
    const j=await r.json(); el('aviBal').textContent = `Bal: ${KES(j.balance||0)}`;
    notify('Wallet updated','success');
  }catch{ notify('Wallet update failed','error'); }
}
async function aviClear(){
  const pid=el('aviPlayer').value;
  try{
    const r=await fetch(`${api}/aviator/wallet/${pid}`); const j=await r.json();
    const bal=j.balance||0; if (bal>0){
      await fetch(`${api}/aviator/wallet/load`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({playerId:pid, amount:-bal})});
      el('aviBal').textContent = `Bal: ${KES(0)}`;
      notify('Paid & cleared','success');
    } else notify('Nothing to clear','info');
  }catch{ notify('Clear failed','error'); }
}

/* Logo loader with fallbacks */
function logoHTML(leagueFolder, abbr){
  const code = (abbr||'???').toUpperCase();
  const base = `/static/logos/${leagueFolder}/${code}`;
  const id = `lg_${leagueFolder}_${code}_${Math.random().toString(36).slice(2,7)}`;
  const img = `<img id="${id}" class="logo" src="${base}.png" alt="${code}">`;
  const ph  = `<span class="ph" id="${id}_ph" style="display:none">${code}</span>`;
  setTimeout(()=>{
    const tag = document.getElementById(id);
    const phTag = document.getElementById(id+'_ph');
    if(!tag) return;
    tag.onerror = ()=>{
      if (tag.src.endsWith('.png')) tag.src = `${base}.jpg`;
      else if (tag.src.endsWith('.jpg')) tag.src = `${base}.svg`;
      else {
        tag.style.display='none';
        if (phTag) phTag.style.display='inline-flex';
      }
    };
  },0);
  return img+ph;
}

/* ------------- Rounds/Weeks engine ------------- */
/*
Football “Weeks”: 4-cycle (WEEK 1..4). Each week boundary = every 7 minutes.
Dogs/Horses/Colors “Rounds”: 4 slots per cycle, spaced 3 minutes (e.g., :33/:36/:39/:42 style).
We run a LIVE dial (conic-gradient) + label and auto-reload data on boundary.
*/
const dial = el('dial');
const roundTimer = el('roundTimer');
const liveText = el('liveText');
const roundLabel = el('roundLabel');

let MODE = 'football'; // football | dogs | horses | colors
let weekIndex = 1;     // 1..4 (football)
let roundIndex = 1;    // 1..4 (others)
let nextBoundaryTs = null;
let boundarySpanMs = 0;

function ceilToStep(dateMs, stepMin){
  const stepMs = stepMin*60*1000;
  return Math.ceil(dateMs/stepMs)*stepMs;
}
function ceilTo3MinSlot(dateMs){
  // next slot: round up to next multiple of 3 minutes
  return ceilToStep(dateMs, 3);
}
function setFootballWeekTiming(){
  MODE='football';
  const now = Date.now()+healthSkew;
  nextBoundaryTs = ceilToStep(now, 7);
  boundarySpanMs = 7*60*1000;
  roundLabel.textContent = `WEEK ${weekIndex}`;
}
function setRacingRoundTiming(){
  MODE = (CURRENT_TAB==='dogs'?'dogs': CURRENT_TAB==='horses'?'horses':'colors');
  const now = Date.now()+healthSkew;
  nextBoundaryTs = ceilTo3MinSlot(now);
  boundarySpanMs = 3*60*1000;
  roundLabel.textContent = `ROUND ${roundIndex}`;
}
function advanceCycle(){
  if (MODE==='football'){
    weekIndex = (weekIndex % 4) + 1;
    roundLabel.textContent = `WEEK ${weekIndex}`;
    notify(`New WEEK ${weekIndex}`, 'success', 1500);
    loadFootball(); // refresh fixtures view
  } else {
    roundIndex = (roundIndex % 4) + 1;
    roundLabel.textContent = `ROUND ${roundIndex}`;
    notify(`New ROUND ${roundIndex}`, 'success', 1500);
    if (CURRENT_TAB==='dogs') loadRacing('dog');
    if (CURRENT_TAB==='horses') loadRacing('horse');
    if (CURRENT_TAB==='colors') loadColorsNumbers();
  }
}
function tickDial(){
  const now = Date.now()+healthSkew;
  const remain = Math.max(0, (nextBoundaryTs||now) - now);
  const ratio = boundarySpanMs ? 1 - remain / boundarySpanMs : 0;
  const deg = Math.max(0, Math.min(360, ratio*360));
  dial.style.setProperty('--p', deg+'deg');

  // LIVE label + countdown text
  const ss = Math.ceil(remain/1000);
  const mm = Math.floor(ss/60), s = ss%60;
  roundTimer.textContent = `Next in ${String(mm).padStart(2,'0')}:${String(s).padStart(2,'0')}`;

  const liveWindow = remain <= 30*1000 || ratio>0.05; // show LIVE most of the cycle
  dial.classList.toggle('live', liveWindow);
  liveText.textContent = liveWindow ? 'LIVE' : '—';

  if (remain<=0){
    // move to next boundary
    nextBoundaryTs += boundarySpanMs;
    advanceCycle();
  }
}
setInterval(tickDial, 500);

/* ------------- Global view state ------------- */
let CURRENT = null; // {event, market, selection}
let CURRENT_TAB = 'football';
let CURRENT_LEAGUE = 'EPL';
let CURRENT_MARKET = 'MAIN';
const MARKET_TABS = ['MAIN','OU15','OU25','BTTS','H15','A15','CMB15','CMB25'];

/* Betslip */
function showSlip(show){ el('betslip').style.display=show?'block':'none'; el('noSlip').style.display=show?'none':'block'; }
function validateStake(stakeRaw){
  const stake = Number(stakeRaw);
  if (!Number.isFinite(stake) || stake<=0){ notify('Enter a valid stake.', 'error'); return null; }
  if (stake < 20){ notify('Minimum stake is 20 KES.', 'error'); return null; }
  if (stake > 1000){ notify('Maximum stake is 1000 KES.', 'error'); return null; }
  return stake;
}
function updatePotential(){
  if (!CURRENT){ el('payout').textContent='—'; return; }
  const stake = Number(el('stake').value || 0);
  const odds = Number(CURRENT.market.odds[CURRENT.selection.id]);
  const pot = stake ? Math.min(stake*odds, 20000) : 0;
  el('payout').textContent = stake ? KES(pot) : '—';
}
function choose(ev, m, sel){
  CURRENT = {event:ev, market:m, selection:sel};
  el('currentSel').textContent = `${ev.game.toUpperCase()} — ${m.type} — ${sel.name}`;
  el('odds').textContent = m.odds[sel.id];
  updatePotential();
  showSlip(true);
}
el('stake').addEventListener('input', updatePotential);
async function placeBet(){
  if (!CURRENT) return notify('Pick a selection first','error');
  const stake = validateStake(el('stake').value);
  if (stake==null) return;
  const payload = { eventId: CURRENT.event.id, marketId: CURRENT.market.id, selectionId: CURRENT.selection.id, stake, cashierId: CASHIER_ID };
  const r = await fetch(`${api}/bets`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
  const j = await r.json();
  if (!j.ok){ notify(j.error||'Bet failed','error'); return; }
  await refreshCashier();
  await loadTickets();
  const w = window.open(`/receipt/${j.bet.id}`,'_blank','width=380,height=560');
  try{ w.focus(); }catch{}
  notify('Bet placed','success');
}

/* History + search */
async function loadTickets(){
  const r = await fetch(`${api}/bets?cashierId=${encodeURIComponent(CASHIER_ID)}`); const list = await r.json();
  renderTickets(list);
  const input = el('historySearch');
  input.oninput = ()=>{
    const q = input.value.trim().toUpperCase();
    if(!q) return renderTickets(list);
    const filtered = list.filter(t=>{
      const code = (t.id||'').slice(0,8).toUpperCase();
      const ref = (t.ref||`T-${code}`).toUpperCase();
      return ref.includes(q) || code.includes(q);
    });
    renderTickets(filtered);
  };
}
function renderTickets(list){
  const box = el('tickets'); box.innerHTML = '';
  list.slice(0,14).forEach(t=>{
    const d = document.createElement('div'); d.className='ticket';
    const ref = t.ref || `T-${(t.id||'').slice(0,8).toUpperCase()}`;
    d.innerHTML = `
      <div class="wm ${t.status||'OPEN'}">${t.status||'OPEN'}</div>
      <div><b>${ref}</b> — ${t.game?.toUpperCase()||''} — ${t.status||'OPEN'}</div>
      <div class="muted">${KES(t.stake)} • ${t.odds} → ${t.payout?KES(t.payout):'—'}</div>`;
    box.appendChild(d);
  });
}

/* ---------- FOOTBALL (single-market view; week cycle) ---------- */
async function loadFootball(){
  // week scheduler
  setFootballWeekTiming();

  el('leagueChips').style.display='flex';
  el('stage').innerHTML='';
  el('roundTimer').title = '7-minute week cycles';

  // league chips
  const head = el('leagueChips'); head.innerHTML='';
  ['EPL','LALIGA','UCL'].forEach(L=>{
    const c=document.createElement('div'); c.className='chip'; if(L===CURRENT_LEAGUE) c.classList.add('active');
    c.textContent=L; c.onclick=()=>{ CURRENT_LEAGUE=L; loadFootball(); };
    head.appendChild(c);
  });

  // market tabs row (single view only)
  const mrow = document.createElement('div'); mrow.className='markets';
  const MLAB = {MAIN:'MAIN', OU15:'OU 1.5', OU25:'OU 2.5', BTTS:'BTTS', H15:'HOME 1.5', A15:'AWAY 1.5', CMB15:'1X2+OU1.5', CMB25:'1X2+OU2.5'};
  MARKET_TABS.forEach(m=>{
    const b=document.createElement('div'); b.className='mkt'; b.textContent = MLAB[m];
    if(m===CURRENT_MARKET) b.classList.add('active');
    b.onclick=()=>{ CURRENT_MARKET=m; loadFootball(); };
    mrow.appendChild(b);
  });
  el('stage').appendChild(mrow);

  const all = (await (await fetch(`${api}/events?game=football`)).json()).filter(e=>e.league===CURRENT_LEAGUE);
  if (!all.length){ el('stage').innerHTML+='<div class="muted">No fixtures.</div>'; return; }

  // Build compact cards for the SELECTED market only
  for (const ev of all.slice(0, 18)){
    const markets = await (await fetch(`${api}/markets/${ev.id}`)).json();
    const byType={}; markets.forEach(m=>byType[m.type]=m);

    const box = document.createElement('div'); box.className='list';
    const hbar = document.createElement('div'); hbar.className='fx-head';
    const clubs = document.createElement('div'); clubs.className='teams';
    const folder = CURRENT_LEAGUE.toLowerCase()==='epl'?'epl':(CURRENT_LEAGUE.toLowerCase()==='laliga'?'laliga':'ucl');
    const H = ev.home.abbr, A = ev.away.abbr;
    clubs.innerHTML = `
      <span class="club">${logoHTML(folder,H)} ${H}</span>
      <span style="opacity:.6">vs</span>
      <span class="club">${logoHTML(folder,A)} ${A}</span>`;
    const tm = document.createElement('div'); tm.className='pill'; tm.textContent=new Date(ev.runsAt+healthSkew).toLocaleTimeString();
    hbar.appendChild(clubs); hbar.appendChild(tm);
    box.appendChild(hbar);

    function rowFor(mdef, cols=3){
      if(!mdef) return;
      const row=document.createElement('div'); row.style.display='grid'; row.style.gridTemplateColumns=`repeat(${cols}, 1fr)`; row.style.gap='8px';
      mdef.selections.forEach(s=>{
        const txt = `${s.name.replace(/\s*\(.*?\)\s*/g,'')} ${mdef.odds[s.id]}`;
        const b=document.createElement('div'); b.className='sel'; b.textContent=txt;
        b.onclick=()=>choose(ev,mdef,s);
        row.appendChild(b);
      });
      box.appendChild(row);
    }

    if (CURRENT_MARKET==='MAIN') rowFor(byType[`MAIN_1X2_${CURRENT_LEAGUE}`], 3);
    if (CURRENT_MARKET==='OU15') rowFor(byType[`OU_1_5_${CURRENT_LEAGUE}`], 2);
    if (CURRENT_MARKET==='OU25') rowFor(byType[`OU_2_5_${CURRENT_LEAGUE}`], 2);
    if (CURRENT_MARKET==='BTTS') rowFor(byType[`BTTS_${CURRENT_LEAGUE}`], 2);
    if (CURRENT_MARKET==='H15') rowFor(byType[`HOME_OU_1_5_${CURRENT_LEAGUE}`], 2);
    if (CURRENT_MARKET==='A15') rowFor(byType[`AWAY_OU_1_5_${CURRENT_LEAGUE}`], 2);
    if (CURRENT_MARKET==='CMB15') rowFor(byType[`COMBO_1X2_OU_1_5_${CURRENT_LEAGUE}`], 3);
    if (CURRENT_MARKET==='CMB25') rowFor(byType[`COMBO_1X2_OU_2_5_${CURRENT_LEAGUE}`], 3);

    el('stage').appendChild(box);
  }

  // Up next (sidebar)
  el('next').innerHTML='';
  all.slice(0,6).forEach(n=>{
    const d=document.createElement('div'); d.className='sel';
    d.textContent=`${new Date(n.runsAt+healthSkew).toLocaleTimeString()} — ${n.home.abbr} vs ${n.away.abbr}`;
    el('next').appendChild(d);
  });
}

/* -------- Racing (Dogs/Horses) with 3-min rounds and 8-lane horses -------- */
async function loadRacing(game){
  setRacingRoundTiming();

  el('leagueChips').style.display='none';
  el('stage').innerHTML='';
  el('roundTimer').title = '3-minute round slots (x4)';

  if (!window.racingMkt) window.racingMkt = {dog:'MAIN', horse:'MAIN'};
  const mrow = document.createElement('div'); mrow.className='markets';
  ['MAIN','FORECAST','QUINELLA','TRICAST'].forEach(m=>{
    const b=document.createElement('div'); b.className='mkt'; if((window.racingMkt[game])===m) b.classList.add('active');
    b.textContent=m; b.onclick=()=>{ window.racingMkt[game]=m; loadRacing(game); };
    mrow.appendChild(b);
  });
  el('stage').appendChild(mrow);

  const events = (await (await fetch(`${api}/events?game=${game}`)).json()).slice(0,3);
  if (!events.length){ el('stage').innerHTML+='<div class="muted">No events.</div>'; return; }

  for (const ev of events){
    const markets = await (await fetch(`${api}/markets/${ev.id}`)).json();
    const byType={}; markets.forEach(m=>byType[m.type]=m);
    const main = byType['MAIN_WIN'];

    const box = document.createElement('div'); box.className='list';
    const head = document.createElement('div'); head.className='fx-head';
    const lab = document.createElement('div'); lab.className='title'; lab.textContent=`${new Date(ev.runsAt+healthSkew).toLocaleTimeString()} — ${game.toUpperCase()}`;
    const tm = document.createElement('div'); tm.className='pill'; tm.textContent = `ROUND ${roundIndex}`;
    head.appendChild(lab); head.appendChild(tm); box.appendChild(head);

    function addGrid(title, m, cols){
      if(!m) return;
      const lbl=document.createElement('div'); lbl.className='muted'; lbl.textContent=title; box.appendChild(lbl);
      const row=document.createElement('div'); row.style.display='grid'; row.style.gridTemplateColumns=`repeat(${cols},1fr)`; row.style.gap='8px';
      m.selections.forEach(s=>{
        const b=document.createElement('div'); b.className='sel'; b.textContent=`${s.name.replace(/DOG|HORSE/gi,'').trim()} ${m.odds[s.id]}`;
        b.onclick=()=>choose(ev,m,s); row.appendChild(b);
      });
      box.appendChild(row);
    }

    const want = window.racingMkt[game];
    if (want==='MAIN') addGrid('MAIN — WIN', byType['MAIN_WIN'], 3);
    if (want==='FORECAST') addGrid('FORECAST (Exacta)', byType['FORECAST'], 3);
    if (want==='QUINELLA') addGrid('QUINELLA', byType['QUINELLA'], 3);
    if (want==='TRICAST') addGrid('TRICAST', byType['TRICAST'], 3);

    const spacer = document.createElement('div'); spacer.style.height='6px'; box.appendChild(spacer);

    if (main){
      const lanes = document.createElement('div'); lanes.className='track';
      const count = game==='horse' ? 8 : Math.min(12, main.selections.length);
      for (let i=0;i<Math.min(count, main.selections.length);i++){
        const r=document.createElement('div'); r.className='runner'; r.style.top=(12 + i*22)+'px';
        r.animate([{transform:'translateX(0)'},{transform:'translateX(8px)'},{transform:'translateX(0)'}],
          {duration:2200+Math.random()*1200,iterations:Infinity});
        r.title = main.selections[i].name; lanes.appendChild(r);
      }
      box.appendChild(lanes);
    }

    el('stage').appendChild(box);
  }

  // Up next (show the next 4 slots at 3-min steps)
  el('next').innerHTML='';
  const base = ceilTo3MinSlot(Date.now()+healthSkew);
  for(let i=0;i<4;i++){
    const t = new Date(base + i*3*60*1000);
    const d=document.createElement('div'); d.className='sel';
    d.textContent = `${t.toLocaleTimeString()} — ROUND ${((roundIndex+i-1)%4)+1}`;
    el('next').appendChild(d);
  }
}

/* -------- Colors & Numbers (merged, colored numbers) -------- */
async function loadColorsNumbers(){
  setRacingRoundTiming();

  el('leagueChips').style.display='none';
  el('stage').innerHTML='';
  el('roundTimer').title = '3-minute round slots (x4)';

  // COLORS
  const evC = (await (await fetch(`${api}/events?game=colors`)).json())[0];
  const marketsC = await (await fetch(`${api}/markets/${evC.id}`)).json();
  const mC = marketsC.find(x=>x.type==='MAIN_COLOR');

  const boxC=document.createElement('div'); boxC.className='list';
  boxC.innerHTML = `<div class="muted">Colors</div>`;
  const gridC=document.createElement('div'); gridC.className='balls colors';
  mC?.selections?.forEach(s=>{
    const b=document.createElement('div'); b.className=`ball ${s.id}`; b.textContent=s.id[0];
    b.title = `${s.name} ${mC.odds[s.id]}`;
    b.onclick=()=>choose(evC,mC,s);
    gridC.appendChild(b);
  });
  boxC.appendChild(gridC);
  el('stage').appendChild(boxC);

  // NUMBERS (1–49) — colored by cycling RED/BLUE/GREEN/YELLOW/PURPLE/BLACK
  const evN = (await (await fetch(`${api}/events?game=lotto49`)).json())[0];
  const marketsN = await (await fetch(`${api}/markets/${evN.id}`)).json();
  const mN = marketsN.find(x=>x.type==='PICK1');

  const colors = ['RED','BLUE','GREEN','YELLOW','PURPLE','BLACK'];
  const boxN=document.createElement('div'); boxN.className='list';
  boxN.innerHTML = `<div class="muted">Numbers 1–49</div>`;
  const gridN=document.createElement('div'); gridN.className='balls numbers';
  mN?.selections?.forEach(s=>{
    const idx = (Number(s.id)-1) % colors.length;
    const b=document.createElement('div'); b.className=`ball ${colors[idx]}`; b.textContent=s.id;
    b.title = `#${s.id} ${mN.odds[s.id]}`;
    b.onclick=()=>choose(evN,mN,s);
    gridN.appendChild(b);
  });
  boxN.appendChild(gridN);
  el('stage').appendChild(boxN);

  // If backend provides "COLOR_MATCH_COUNT", render it as extra market
  const matchCount = marketsC.find(x=>x.type==='COLOR_MATCH_COUNT');
  if (matchCount){
    const boxM=document.createElement('div'); boxM.className='list';
    boxM.innerHTML = `<div class="muted">Color — Number of matches</div>`;
    const row=document.createElement('div'); row.style.display='grid'; row.style.gridTemplateColumns=`repeat(3,1fr)`; row.style.gap='8px';
    matchCount.selections.forEach(s=>{
      const b=document.createElement('div'); b.className='sel'; b.textContent=`${s.name} ${matchCount.odds[s.id]}`;
      b.onclick=()=>choose(evC,matchCount,s);
      row.appendChild(b);
    });
    boxM.appendChild(row);
    el('stage').appendChild(boxM);
  }

  // Up next (show 4 upcoming round times)
  el('next').innerHTML='';
  const base = ceilTo3MinSlot(Date.now()+healthSkew);
  for(let i=0;i<4;i++){
    const t = new Date(base + i*3*60*1000);
    const d=document.createElement('div'); d.className='sel';
    d.textContent = `${t.toLocaleTimeString()} — ROUND ${((roundIndex+i-1)%4)+1}`;
    el('next').appendChild(d);
  }
}

/* -------- Tabs router -------- */
document.querySelectorAll('.tab[data-tab]').forEach(t=>{
  t.addEventListener('click', ()=>{
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    CURRENT_TAB = t.dataset.tab;
    CURRENT = null; showSlip(false);
    if (CURRENT_TAB==='football') loadFootball();
    if (CURRENT_TAB==='dogs') loadRacing('dog');
    if (CURRENT_TAB==='horses') loadRacing('horse');
    if (CURRENT_TAB==='colors') loadColorsNumbers();
  });
});

/* -------- Tickets periodic refresh -------- */
async function loadTickets(){
  const r = await fetch(`${api}/bets?cashierId=${encodeURIComponent(CASHIER_ID)}`); const list = await r.json();
  renderTickets(list);
}
function renderTickets(list){
  const box = el('tickets'); box.innerHTML = '';
  list.slice(0,14).forEach(t=>{
    const d = document.createElement('div'); d.className='ticket';
    const ref = t.ref || `T-${(t.id||'').slice(0,8).toUpperCase()}`;
    d.innerHTML = `
      <div class="wm ${t.status||'OPEN'}">${t.status||'OPEN'}</div>
      <div><b>${ref}</b> — ${t.game?.toUpperCase()||''} — ${t.status||'OPEN'}</div>
      <div class="muted">${KES(t.stake)} • ${t.odds} → ${t.payout?KES(t.payout):'—'}</div>`;
    box.appendChild(d);
  });
}

/* -------- Boot -------- */
async function boot(){
  await refreshCashier();
  await loadFootball();   // default tab
  await loadTickets();

  // periodic refresh so page stays live
  setInterval(async ()=>{
    if (CURRENT_TAB==='football') await loadFootball();
    if (CURRENT_TAB==='dogs') await loadRacing('dog');
    if (CURRENT_TAB==='horses') await loadRacing('horse');
    if (CURRENT_TAB==='colors') await loadColorsNumbers();
    await loadTickets();
  }, 9000);
}
boot();
</script>
</body>
</html>
