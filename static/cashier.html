<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Cashier</title>
  <style>
    :root{
      --bg:#070b16; --panel:#0b1428; --line:#1c2741; --text:#e6edf3; --muted:#9aa4b2;
      --accent:#22c55e; --danger:#ef4444; --warn:#f59e0b; --chip:#0f1a33; --ink:#0e172f;
      --sky1:#122445; --sky2:#0b1324;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,Arial,sans-serif;background:
      radial-gradient(140% 120% at 50% -20%, var(--sky1) 0 45%, var(--sky2) 46% 100%); color:var(--text)}
    a{color:#7dd3fc}

    /* Header */
    header{
      position:sticky; top:0; z-index:50;
      display:flex; align-items:center; gap:12px;
      padding:10px 16px; border-bottom:1px solid var(--line);
      background:rgba(8,12,24,.85); backdrop-filter:blur(6px)
    }
    .brand{font-weight:900;letter-spacing:.3px;font-size:16px}
    .grow{flex:1}
    .kpi{padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#0e172f;font-size:12px}
    .pill{padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#0d1428;font-size:12px}
    .clock{min-width:220px;text-align:right}

    /* Layout */
    .container{max-width:1500px;margin:0 auto;padding:14px;display:grid;grid-template-columns:2fr 1fr;gap:14px}
    @media (max-width:1100px){ .container{grid-template-columns:1fr} }

    .panel{background:var(--panel);border:1px solid var(--line);border-radius:18px;padding:12px}
    .title{font-weight:900;margin-bottom:8px}
    .muted{color:var(--muted);font-size:12px}
    .divider{height:1px;background:var(--line);margin:10px 0}

    /* Tabs & chips */
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
    .tab{padding:8px 12px;border:1px solid var(--line);border-radius:12px;background:#0f1933;color:#e6edf3;cursor:pointer;font-weight:800}
    .tab.active{outline:2px solid var(--accent)}
    .chips{display:flex;gap:6px;flex-wrap:wrap}
    .chip{padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:var(--chip);cursor:pointer}
    .chip.active{outline:2px solid var(--accent)}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}

    /* Grids & selectors */
    .grid{display:grid;gap:10px}
    .list{border:1px dashed var(--line);border-radius:12px;padding:10px}
    .sel{padding:10px;border:1px solid var(--line);border-radius:10px;background:#0d1428;cursor:pointer;text-align:center}
    .sel:hover{outline:2px solid #1f6feb44}

    /* Markets toggle (horizontal) */
    .markets{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0 10px}
    .mkt{padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#0f1933;cursor:pointer;font-size:12px}
    .mkt.active{outline:2px solid #22c55e}

    /* Fixture card */
    .fx{display:grid; gap:8px; margin-bottom:10px}
    .fx-head{display:flex; align-items:center; justify-content:space-between; gap:8px}
    .teams{display:flex; align-items:center; gap:10px; font-weight:800}
    .club{display:flex; align-items:center; gap:6px}
    .logo{width:26px;height:26px;border-radius:50%;background:#0b1324;border:1px solid #1c2741;object-fit:cover}

    /* Racing lanes (dogs/horses) */
    .track{position:relative;height:180px;border:1px dashed var(--line);border-radius:14px;margin-bottom:8px;
      background:
        linear-gradient(90deg,#0b1324 0 10px, #12203f 10px 12px, transparent 12px),
        repeating-linear-gradient(to bottom, #0f1629 0, #0f1629 26px, #0b1324 26px, #0b1324 28px);
      overflow:hidden}
    .runner{position:absolute;left:8px;width:42px;height:20px;background:#e5e7eb;border-radius:3px 10px 10px 3px;
      box-shadow:0 0 6px #fff2, inset 0 -2px 3px #0003}
    .runner:after{content:"";position:absolute;right:-6px;top:6px;width:8px;height:8px;border-radius:50%;background:#e5e7eb;box-shadow:0 0 5px #fff4}

    /* Betslip & tickets */
    .betslip{display:grid;gap:8px}
    input,button{font-family:inherit}
    input[type="number"], input[type="text"]{width:100%;padding:10px;border-radius:10px;border:1px solid var(--line);background:#0d1428;color:#fff}
    .btn{padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#0d1428;color:#fff;cursor:pointer;font-weight:800}
    .btn.primary{background:#0f2b1b;border-color:#1b4d28}
    .ticket{position:relative;padding:8px;border:1px dashed var(--line);border-radius:10px;margin-bottom:6px;background:#0c162c}
    .wm{position:absolute;inset:8px;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:28px;
      color:#fff1; pointer-events:none; transform:rotate(-18deg)}
    .wm.OPEN{color:#7dd3fc22}
    .wm.WON{color:#22c55e22}
    .wm.LOST{color:#ef444422}

    /* Lively accents */
    .shine{background:linear-gradient(120deg, transparent, #ffffff08 30%, transparent 60%); background-size:200% 100%; animation:shine 3.2s linear infinite}
    @keyframes shine{0%{background-position:-120% 0}100%{background-position:120% 0}}
  </style>
</head>
<body>
<header>
  <div class="brand">Cashier</div>
  <div class="grow"></div>
  <div class="pill clock" id="clock">—</div>
  <a href="/aviator" class="pill" style="display:flex;gap:6px;align-items:center;background:#0e172f">
    <img src="/static/img/aviator-icon.png" alt="Aviator" style="width:18px;height:18px;border-radius:50%"/>
    <span style="font-weight:800">Aviator</span>
  </a>
</header>

<div class="container">
  <!-- LEFT: Home / Leagues / Racing / Colors+Numbers -->
  <div class="panel shine">
    <div class="tabs">
      <div class="tab active" data-tab="home">Home</div>
      <div class="tab" data-tab="football">Football</div>
      <div class="tab" data-tab="dogs">Dogs</div>
      <div class="tab" data-tab="horses">Horses</div>
      <div class="tab" data-tab="colors">Colors & Numbers</div>
    </div>

    <div id="homeWrap">
      <div class="title">Leagues — Weekly Fixtures</div>
      <div class="chips" id="leagueWeekChips"></div>
      <div class="divider"></div>
      <div id="homeGrid" class="grid"></div>
    </div>

    <div id="stageWrap" style="display:none">
      <div class="title" id="title">—</div>
      <div class="chips" id="leagueChips" style="display:none"></div>
      <div id="stage" class="grid"></div>
    </div>
  </div>

  <!-- RIGHT: Controls / Aviator wallets / Up Next / History / Betslip -->
  <div class="panel">
    <div class="title">Controls</div>
    <div class="row">
      <div class="pill" id="cashierIdShow">Cashier: <b id="cashierId">shop-1</b></div>
      <div class="pill">Balance: <b id="cashBal">0 KES</b></div>
      <input id="cashierIdInput" value="shop-1" style="max-width:160px">
      <button class="btn" onclick="applyCashier()">Set</button>
      <button class="btn" onclick="topupCashier(5000)">Top-up 5,000</button>
    </div>
    <div class="divider"></div>

    <div>
      <div class="title">Aviator Players — Wallets</div>
      <div class="row">
        <select id="aviPlayer">
          <option value="pA">Player A</option>
          <option value="pB">Player B</option>
          <option value="pC">Player C</option>
        </select>
        <input id="aviAmount" type="number" value="1000" min="1" style="max-width:120px" />
        <button class="btn" onclick="aviLoad()">Load</button>
        <button class="btn" onclick="aviView()">View</button>
        <button class="btn" onclick="aviClear()">Pay & Clear</button>
        <div class="pill" id="aviBal">Bal: —</div>
      </div>
    </div>

    <div class="divider"></div>

    <div>
      <div class="title">Up Next</div>
      <div id="next" class="list"></div>
      <div class="divider"></div>
      <div class="row" style="justify-content:space-between">
        <div class="title">History</div>
        <input id="historySearch" placeholder="Scan / type Ref or Code…" style="max-width:220px"/>
      </div>
      <div id="tickets" class="list"></div>
    </div>

    <div class="divider"></div>

    <div>
      <div class="title">Betslip</div>
      <div class="betslip" id="betslip" style="display:none">
        <div class="muted" id="currentSel">No selection</div>
        <input id="stake" type="number" min="20" max="1000" value="100" placeholder="Stake (KES)"/>
        <div class="row"><div class="pill">Odds: <b id="odds">—</b></div><div class="pill">Potential: <b id="payout">—</b></div></div>
        <button class="btn primary" onclick="placeBet()">Place Bet</button>
        <div class="muted">Min 20, Max 1000, Max Payout 20,000</div>
      </div>
      <div id="noSlip" class="muted">Click a market to build a betslip.</div>
    </div>
  </div>
</div>

<script>
/* -------- Basics -------- */
const api = location.origin.replace(/:\\d+$/, ':4000');
const KES = (x)=> new Intl.NumberFormat('en-KE',{style:'currency',currency:'KES'}).format(Number(x||0));
function el(id){ return document.getElementById(id); }

/* Clock sync (like Aviator) */
let healthSkew=0;
async function syncClock(){ try{ const r=await fetch(`${api}/health`); const j=await r.json(); healthSkew=j.ts-Date.now(); }catch{} }
setInterval(()=>{ const d=new Date(Date.now()+healthSkew); el('clock').textContent=d.toLocaleString(); }, 500); syncClock();

/* Cashier */
let CASHIER_ID = 'shop-1';
async function refreshCashier(){
  try{ const r=await fetch(`${api}/cashier/${CASHIER_ID}/balance`); const j=await r.json();
    el('cashBal').textContent = KES(j.balance||0);
    el('cashierId').textContent = CASHIER_ID;
  }catch{}
}
async function topupCashier(amount){
  await fetch(`${api}/cashier/topup`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({cashierId:CASHIER_ID,amount})});
  refreshCashier();
}
function applyCashier(){ CASHIER_ID = el('cashierIdInput').value || 'shop-1'; refreshCashier(); }

/* Aviator wallets */
async function aviView(){
  const pid=el('aviPlayer').value; try{
    const r=await fetch(`${api}/aviator/wallet/${pid}`); const j=await r.json();
    el('aviBal').textContent = `Bal: ${KES(j.balance||0)}`;
  }catch{ el('aviBal').textContent='Bal: —'; }
}
async function aviLoad(){
  const pid=el('aviPlayer').value; const amt=Number(el('aviAmount').value||0)||0;
  try{
    const r=await fetch(`${api}/aviator/wallet/load`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({playerId:pid, amount:amt})});
    const j=await r.json(); el('aviBal').textContent = `Bal: ${KES(j.balance||0)}`;
  }catch{}
}
async function aviClear(){
  const pid=el('aviPlayer').value;
  try{
    const r=await fetch(`${api}/aviator/wallet/${pid}`); const j=await r.json();
    const bal=j.balance||0; if (bal>0){
      await fetch(`${api}/aviator/wallet/load`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({playerId:pid, amount:-bal})});
      el('aviBal').textContent = `Bal: ${KES(0)}`;
    }
  }catch{}
}

/* Global view state */
let CURRENT = null; // {event, market, selection}
let CURRENT_TAB = 'home';
let CURRENT_LEAGUE = 'EPL';
let CURRENT_MARKET = 'MAIN';
const MARKET_TABS = ['MAIN','OU15','OU25','BTTS','H15','A15','CMB15','CMB25'];

/* Fixtures per week: simple rolling buckets by runsAt */
function groupByWeek(events){
  const weeks = {};
  events.forEach(ev=>{
    const d = new Date(ev.runsAt + healthSkew);
    const start = new Date(d); start.setDate(d.getDate() - d.getDay()); start.setHours(0,0,0,0);
    const key = start.toISOString().slice(0,10);
    if(!weeks[key]) weeks[key]=[];
    weeks[key].push(ev);
  });
  return weeks;
}

/* ---------- HOME (weeks per league) ---------- */
async function loadHome(){
  el('homeWrap').style.display='block';
  el('stageWrap').style.display='none';
  el('leagueWeekChips').innerHTML='';
  el('homeGrid').innerHTML='';

  const leagues=['EPL','LALIGA','UCL'];
  for (const L of leagues){
    const all = (await (await fetch(`${api}/events?game=football`)).json()).filter(e=>e.league===L);
    const weeks = groupByWeek(all);
    const wrap = document.createElement('div'); wrap.className='list';

    const head = document.createElement('div'); head.className='row';
    head.innerHTML = `<div class="title">${L} — Weekly</div>`;
    wrap.appendChild(head);

    Object.entries(weeks).slice(0,2).forEach(([wk, arr])=>{
      const lab = document.createElement('div'); lab.className='muted';
      lab.textContent = `Week of ${wk} — ${arr.length} fixtures`;
      wrap.appendChild(lab);

      arr.slice(0,6).forEach(ev=>{
        const fx = document.createElement('div'); fx.className='fx';
        const tbar = document.createElement('div'); tbar.className='fx-head';
        const left = document.createElement('div'); left.className='teams';

        const h = ev.home?.abbr||'?', a = ev.away?.abbr||'?';
        const Lpath = L.toLowerCase()==='epl'?'epl':(L.toLowerCase()==='laliga'?'laliga':'ucl');
        left.innerHTML = `
          <span class="club"><img class="logo" src="/static/logos/${Lpath}/${h}.png" onerror="this.style.visibility='hidden'"> ${h}</span>
          <span style="opacity:.6">vs</span>
          <span class="club"><img class="logo" src="/static/logos/${Lpath}/${a}.png" onerror="this.style.visibility='hidden'"> ${a}</span>`;
        const tm = document.createElement('div');
        tm.className='pill'; tm.textContent = new Date(ev.runsAt+healthSkew).toLocaleTimeString();
        tbar.appendChild(left); tbar.appendChild(tm);
        fx.appendChild(tbar);
        wrap.appendChild(fx);
      });
      const div=document.createElement('div'); div.className='divider'; wrap.appendChild(div);
    });

    el('homeGrid').appendChild(wrap);
  }
}

/* ---------- Leagues page ---------- */
async function loadFootball(){
  el('homeWrap').style.display='none';
  el('stageWrap').style.display='block';
  el('leagueChips').style.display='flex';
  // league chips
  const head = el('leagueChips'); head.innerHTML='';
  ['EPL','LALIGA','UCL'].forEach(L=>{
    const c=document.createElement('div'); c.className='chip'; if(L===CURRENT_LEAGUE) c.classList.add('active');
    c.textContent=L; c.onclick=()=>{ CURRENT_LEAGUE=L; el('stage').innerHTML=''; loadFootball(); };
    head.appendChild(c);
  });

  const all = (await (await fetch(`${api}/events?game=football`)).json()).filter(e=>e.league===CURRENT_LEAGUE);
  el('title').textContent = `Football (${CURRENT_LEAGUE}) — ${all.length} fixtures`;

  if (!all.length){ el('stage').innerHTML='<div class="muted">No fixtures.</div>'; return; }

  /* market tabs row */
  const mrow = document.createElement('div'); mrow.className='markets';
  MARKET_TABS.forEach(m=>{
    const b=document.createElement('div'); b.className='mkt'; b.textContent = ({
      MAIN:'MAIN', OU15:'OU 1.5', OU25:'OU 2.5', BTTS:'BTTS', H15:'HOME 1.5', A15:'AWAY 1.5', CMB15:'1X2+OU1.5', CMB25:'1X2+OU2.5'
    })[m];
    if(m===CURRENT_MARKET) b.classList.add('active');
    b.onclick=()=>{ CURRENT_MARKET=m; loadFootball(); };
    mrow.appendChild(b);
  });
  el('stage').appendChild(mrow);

  for (const ev of all.slice(0,10)){
    const markets = await (await fetch(`${api}/markets/${ev.id}`)).json();
    const byType={}; markets.forEach(m=>byType[m.type]=m);

    const box = document.createElement('div'); box.className='list';

    // header with circular logos
    const hbar = document.createElement('div'); hbar.className='fx-head';
    const clubs = document.createElement('div'); clubs.className='teams';
    const L = CURRENT_LEAGUE.toLowerCase()==='epl'?'epl':(CURRENT_LEAGUE.toLowerCase()==='laliga'?'laliga':'ucl');
    const H = ev.home.abbr, A = ev.away.abbr;
    clubs.innerHTML = `
      <span class="club"><img class="logo" src="/static/logos/${L}/${H}.png" onerror="this.style.visibility='hidden'"> ${H}</span>
      <span style="opacity:.6">vs</span>
      <span class="club"><img class="logo" src="/static/logos/${L}/${A}.png" onerror="this.style.visibility='hidden'"> ${A}</span>`;
    const tm = document.createElement('div'); tm.className='pill'; tm.textContent=new Date(ev.runsAt+healthSkew).toLocaleTimeString();
    hbar.appendChild(clubs); hbar.appendChild(tm);
    box.appendChild(hbar);

    function rowFor(mdef, cols=3){
      if(!mdef) return;
      const row=document.createElement('div'); row.style.display='grid'; row.style.gridTemplateColumns=`repeat(${cols}, 1fr)`; row.style.gap='8px';
      mdef.selections.forEach(s=>{
        const txt = `${s.name.replace(/\s*\(.*?\)\s*/g,'')} ${mdef.odds[s.id]}`; // no "@"
        const b=document.createElement('div'); b.className='sel'; b.textContent=txt;
        b.onclick=()=>choose(ev,mdef,s);
        row.appendChild(b);
      });
      box.appendChild(row);
    }

    // switch by CURRENT_MARKET
    if (CURRENT_MARKET==='MAIN') rowFor(byType[`MAIN_1X2_${CURRENT_LEAGUE}`], 3);
    if (CURRENT_MARKET==='OU15') rowFor(byType[`OU_1_5_${CURRENT_LEAGUE}`], 2);
    if (CURRENT_MARKET==='OU25') rowFor(byType[`OU_2_5_${CURRENT_LEAGUE}`], 2);
    if (CURRENT_MARKET==='BTTS') rowFor(byType[`BTTS_${CURRENT_LEAGUE}`], 2);
    if (CURRENT_MARKET==='H15') rowFor(byType[`HOME_OU_1_5_${CURRENT_LEAGUE}`], 2);
    if (CURRENT_MARKET==='A15') rowFor(byType[`AWAY_OU_1_5_${CURRENT_LEAGUE}`], 2);
    if (CURRENT_MARKET==='CMB15') rowFor(byType[`COMBO_1X2_OU_1_5_${CURRENT_LEAGUE}`], 3);
    if (CURRENT_MARKET==='CMB25') rowFor(byType[`COMBO_1X2_OU_2_5_${CURRENT_LEAGUE}`], 3);

    el('stage').appendChild(box);
  }

  // side panels
  el('next').innerHTML='';
  all.slice(10,13).forEach(n=>{
    const d=document.createElement('div'); d.className='sel';
    d.textContent=`${new Date(n.runsAt+healthSkew).toLocaleTimeString()} — ${n.home.abbr} vs ${n.away.abbr}`;
    el('next').appendChild(d);
  });
  loadTickets();
}

/* -------- Racing (Dogs/Horses) with realistic lanes -------- */
async function loadRacing(game){
  el('homeWrap').style.display='none';
  el('stageWrap').style.display='block';
  el('leagueChips').style.display='none';
  el('title').textContent = game==='dog'?'Dogs — WIN / FORECAST / QUINELLA / TRICAST':'Horses — WIN / FORECAST / QUINELLA / TRICAST';
  el('stage').innerHTML='';

  // market toggles like others (MAIN default)
  const mrow = document.createElement('div'); mrow.className='markets';
  ['MAIN','FORECAST','QUINELLA','TRICAST'].forEach(m=>{
    const b=document.createElement('div'); b.className='mkt'; if((game+'_mkt' in window?window[game+'_mkt']:'MAIN')===m) b.classList.add('active');
    b.textContent=m; b.onclick=()=>{ window[game+'_mkt']=m; loadRacing(game); };
    mrow.appendChild(b);
  });
  el('stage').appendChild(mrow);

  const events = (await (await fetch(`${api}/events?game=${game}`)).json()).slice(0,3);
  if (!events.length){ el('stage').innerHTML+='<div class="muted">No events.</div>'; return; }

  for (const ev of events){
    const markets = await (await fetch(`${api}/markets/${ev.id}`)).json();
    const byType={}; markets.forEach(m=>byType[m.type]=m);

    const box = document.createElement('div'); box.className='list';
    const h = document.createElement('div'); h.className='fx-head';
    const lab = document.createElement('div'); lab.className='title'; lab.textContent=`${new Date(ev.runsAt+healthSkew).toLocaleTimeString()} — ${game.toUpperCase()}`;
    const tm = document.createElement('div'); tm.className='pill'; tm.textContent = 'Round';
    h.appendChild(lab); h.appendChild(tm); box.appendChild(h);

    // lanes
    const main = byType['MAIN_WIN'];
    if (main){
      const lanes = document.createElement('div'); lanes.className='track';
      for (let i=0;i<main.selections.length;i++){
        const r=document.createElement('div'); r.className='runner'; r.style.top=(12 + i*28)+'px';
        // subtle animation
        r.animate([{transform:'translateX(0)'},{transform:'translateX(6px)'},{transform:'translateX(0)'}],
          {duration:2000+Math.random()*1200,iterations:Infinity});
        r.title = main.selections[i].name; lanes.appendChild(r);
      }
      box.appendChild(lanes);
    }

    function addGrid(title, m, cols){
      if(!m) return;
      const lab=document.createElement('div'); lab.className='muted'; lab.textContent=title; box.appendChild(lab);
      const row=document.createElement('div'); row.style.display='grid'; row.style.gridTemplateColumns=`repeat(${cols},1fr)`; row.style.gap='8px';
      m.selections.forEach(s=>{
        const b=document.createElement('div'); b.className='sel'; b.textContent=`${s.name.replace(/DOG|HORSE/gi,'').trim()} ${m.odds[s.id]}`;
        b.onclick=()=>choose(ev,m,s); row.appendChild(b);
      });
      box.appendChild(row);
    }

    const want = (window[game+'_mkt']||'MAIN');
    if (want==='MAIN') addGrid('MAIN — WIN', byType['MAIN_WIN'], 3);
    if (want==='FORECAST') addGrid('FORECAST (Exacta)', byType['FORECAST'], 3);
    if (want==='QUINELLA') addGrid('QUINELLA', byType['QUINELLA'], 3);
    if (want==='TRICAST') addGrid('TRICAST', byType['TRICAST'], 3);

    el('stage').appendChild(box);
  }

  // previous
  const res = await (await fetch(`${api}/results?game=${game}&limit=8`)).json();
  el('next').innerHTML='';
  el('tickets'); // keep
}

/* -------- Colors & Numbers (merged) -------- */
async function loadColorsNumbers(){
  el('homeWrap').style.display='none';
  el('stageWrap').style.display='block';
  el('leagueChips').style.display='none';
  el('title').textContent = 'Colors & Numbers — glossy balls';
  el('stage').innerHTML='';

  const evC = (await (await fetch(`${api}/events?game=colors`)).json())[0];
  const marketsC = await (await fetch(`${api}/markets/${evC.id}`)).json();
  const mC = marketsC.find(x=>x.type==='MAIN_COLOR');

  const boxC=document.createElement('div'); boxC.className='list';
  boxC.innerHTML = `<div class="muted">Colors</div>`;
  const gridC=document.createElement('div'); gridC.style.display='grid'; gridC.style.gridTemplateColumns='repeat(6,1fr)'; gridC.style.gap='8px';
  mC.selections.forEach(s=>{
    const b=document.createElement('div'); b.className='sel'; b.textContent=`${s.name} ${mC.odds[s.id]}`; // include odds
    b.onclick=()=>choose(evC,mC,s);
    gridC.appendChild(b);
  });
  boxC.appendChild(gridC);
  el('stage').appendChild(boxC);

  const evN = (await (await fetch(`${api}/events?game=lotto49`)).json())[0];
  const marketsN = await (await fetch(`${api}/markets/${evN.id}`)).json();
  const mN = marketsN.find(x=>x.type==='PICK1');

  const boxN=document.createElement('div'); boxN.className='list';
  boxN.innerHTML = `<div class="muted">Numbers 1–49</div>`;
  const gridN=document.createElement('div'); gridN.style.display='grid'; gridN.style.gridTemplateColumns='repeat(7,1fr)'; gridN.style.gap='8px';
  mN.selections.forEach(s=>{
    const b=document.createElement('div'); b.className='sel'; b.textContent=`#${s.id} ${mN.odds[s.id]}`;
    b.onclick=()=>choose(evN,mN,s);
    gridN.appendChild(b);
  });
  boxN.appendChild(gridN);
  el('stage').appendChild(boxN);
}

/* -------- Betslip / Place bet / Auto print -------- */
function showSlip(show){ el('betslip').style.display=show?'block':'none'; el('noSlip').style.display=show?'none':'block'; }
function choose(ev, m, sel){
  CURRENT = {event:ev, market:m, selection:sel};
  el('currentSel').textContent = `${ev.game.toUpperCase()} — ${m.type} — ${sel.name}`;
  el('odds').textContent = m.odds[sel.id];
  const stake = Number(el('stake').value || 0);
  el('payout').textContent = stake ? KES(Math.min(stake * Number(m.odds[sel.id]), 20000)) : '—';
  showSlip(true);
}
el('stake').addEventListener('input',()=>{
  if (!CURRENT){ el('payout').textContent='—'; return; }
  const stake = Number(el('stake').value || 0);
  el('payout').textContent = stake ? KES(Math.min(stake * Number(CURRENT.market.odds[CURRENT.selection.id]), 20000)) : '—';
});
async function placeBet(){
  if (!CURRENT) return alert('Pick a market/selection first');
  const stake = Number(el('stake').value || 0);
  if (stake<20) return alert('Minimum stake is 20');
  if (stake>1000) return alert('Maximum stake is 1000');
  const payload = { eventId: CURRENT.event.id, marketId: CURRENT.market.id, selectionId: CURRENT.selection.id, stake, cashierId: CASHIER_ID };
  const r = await fetch(`${api}/bets`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
  const j = await r.json();
  if (!j.ok) return alert(j.error || JSON.stringify(j));
  await refreshCashier();
  await loadTickets();
  // Auto open receipt in a small print window (server will render EJS; thermal prints if enabled)
  const w = window.open(`/receipt/${j.bet.id}`,'_blank','width=380,height=560');
  try{ w.focus(); }catch{}
}

/* -------- History + search (barcode-friendly) -------- */
async function loadTickets(){
  const r = await fetch(`${api}/bets?cashierId=${encodeURIComponent(CASHIER_ID)}`); const list = await r.json();
  renderTickets(list);
  // Scan/search handler
  const input = el('historySearch');
  input.oninput = ()=>{
    const q = input.value.trim().toUpperCase();
    if(!q) return renderTickets(list);
    const filtered = list.filter(t=>{
      // match by ref (T-XXXX) or id start (barcode 8 chars on receipt)
      const code = (t.id||'').slice(0,8).toUpperCase();
      const ref = (t.ref||`T-${code}`).toUpperCase();
      return ref.includes(q) || code.includes(q);
    });
    renderTickets(filtered);
  };
}
function renderTickets(list){
  const box = el('tickets'); box.innerHTML = '';
  list.slice(0,12).forEach(t=>{
    const d = document.createElement('div'); d.className='ticket';
    const ref = t.ref || `T-${(t.id||'').slice(0,8).toUpperCase()}`;
    d.innerHTML = `
      <div class="wm ${t.status||'OPEN'}">${t.status||'OPEN'}</div>
      <div><b>${ref}</b> — ${t.game?.toUpperCase()||''} — ${t.status}</div>
      <div class="muted">${KES(t.stake)} • ${t.odds} → ${t.payout?KES(t.payout):'—'}</div>`;
    box.appendChild(d);
  });
}

/* -------- Tabs router -------- */
document.querySelectorAll('.tab[data-tab]').forEach(t=>{
  t.addEventListener('click', ()=>{
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    CURRENT_TAB = t.dataset.tab;
    CURRENT = null; showSlip(false);

    if (CURRENT_TAB==='home') loadHome();
    if (CURRENT_TAB==='football') loadFootball();
    if (CURRENT_TAB==='dogs') loadRacing('dog');
    if (CURRENT_TAB==='horses') loadRacing('horse');
    if (CURRENT_TAB==='colors') loadColorsNumbers();
  });
});

/* -------- Boot & refresh loop -------- */
async function boot(){
  await refreshCashier();
  await loadHome();
  await loadTickets();
  // periodic refresh to keep lively/synced
  setInterval(async ()=>{
    if (CURRENT_TAB==='home') await loadHome();
    if (CURRENT_TAB==='football') await loadFootball();
    if (CURRENT_TAB==='dogs') await loadRacing('dog');
    if (CURRENT_TAB==='horses') await loadRacing('horse');
    if (CURRENT_TAB==='colors') await loadColorsNumbers();
    await loadTickets();
  }, 8000);
}
boot();
</script>
</body>
</html>
