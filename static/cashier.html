<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Cashier</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700;800&display=swap">
<style>
  :root{
    --bg:#070b16; --panel:#0b1428; --line:#1c2741; --text:#ffffff;
    --muted:#b6c2d1; --accent:#22c55e; --danger:#ef4444; --ink:#0e172f;
    --glass: linear-gradient(180deg,#0f1b36 0%, #0c152b 100%);
    --glow:#3b82f680; --gloss:linear-gradient(180deg,#ffffff26 0 6%, #ffffff05 6% 60%, #00000010 60% 100%);
    --radius:18px;
    --maxw:100%;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:"Space Grotesk",system-ui,Inter,Arial,sans-serif; color:var(--text);
    background:
      radial-gradient(140% 120% at 50% -20%, #13274f 0 45%, #0b1324 46% 100%);
  }
  a{color:#93c5fd;text-decoration:none}

  /* Header */
  header{
    position:sticky; top:0; z-index:50; display:flex; align-items:center; gap:14px;
    padding:12px 16px; border-bottom:1px solid var(--line);
    background:rgba(8,12,24,.85); backdrop-filter:blur(8px)
  }
  .brand{font-weight:800;letter-spacing:.3px;font-size:18px;display:flex;align-items:center;gap:10px}
  .brand svg{filter:drop-shadow(0 2px 6px #1e40af80)}
  .grow{flex:1}
  .clock{
    font-weight:800; letter-spacing:.4px;
    padding:10px 14px; border:1px solid #2a3c63; border-radius:999px; background:#0d1a32;
    box-shadow:inset 0 1px 0 #ffffff14, 0 8px 24px #0007;
  }
  .avi-link{
    display:inline-flex; align-items:center; gap:10px; font-weight:800;
    padding:10px 14px; border-radius:999px; border:1px solid #2a3e6a;
    background:linear-gradient(180deg,#101d38,#0c152b); box-shadow:inset 0 1px 0 #ffffff22, 0 12px 28px #0008;
    transition:transform .15s ease, filter .15s ease, box-shadow .15s ease;
  }
  .avi-link:hover{ transform:translateY(-1px); filter:brightness(1.1); box-shadow:0 18px 40px #1e293b80 }
  .avi-link img{ width:26px; height:26px; border-radius:50%; box-shadow:0 0 0 2px #183255 }
  .avi-link b{ font-size:14px }

  /* Layout */
  .container{max-width:var(--maxw);margin:0 auto;padding:12px;display:grid;grid-template-columns:minmax(0,2.1fr) minmax(0,.9fr);gap:14px}
  @media (max-width:1100px){ .container{grid-template-columns:1fr} }

  .panel{background:var(--glass);border:1px solid var(--line);border-radius:var(--radius);padding:12px;position:relative;overflow:hidden}
  .panel:before{content:"";position:absolute;inset:0;background:var(--gloss);pointer-events:none}
  .title{font-weight:800;margin-bottom:10px}
  .muted{color:var(--muted);font-size:12px}
  .divider{height:1px;background:var(--line);margin:10px 0}

  /* Seamless tile cards (used for Category / League / Week / Times) */
  .tilegrid{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:10px}
  .tilecard{
    display:flex; align-items:center; gap:10px; padding:10px 14px; cursor:pointer;
    background:#0f1c36; border:1px solid #2a3e64; border-radius:14px; font-weight:800;
    box-shadow:inset 0 1px 0 #ffffff20, 0 8px 22px #0006; transition:transform .15s ease, box-shadow .15s ease, filter .15s ease;
  }
  .tilecard svg{width:18px;height:18px}
  .tilecard:hover{ transform:translateY(-1px); box-shadow:0 16px 36px #0008, inset 0 1px 0 #ffffff30; filter:brightness(1.07) }
  .tilecard.active{ outline:2px solid var(--accent) }

  /* Markets strip (tile style) */
  .markets{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0 10px}
  .mkt{
    padding:8px 12px; border:1px solid #2b4068; border-radius:999px; background:#0e1a33; cursor:pointer; font-size:12px; font-weight:800;
    box-shadow:inset 0 1px 0 #ffffff20, 0 6px 16px #0007; transition:filter .15s ease, transform .15s ease;
  }
  .mkt:hover{ filter:brightness(1.08); transform:translateY(-1px) }
  .mkt.active{ outline:2px solid #22c55e }

  /* Dial & round info */
  .roundbar{display:flex;align-items:center;gap:10px}
  .dial{
    --p:0deg; --col:#22c55e; width:42px;height:42px;border-radius:50%;
    background: conic-gradient(var(--col) var(--p), #0000 var(--p)), radial-gradient(circle 18px, #0000 17px, #0d1428 18px);
    border:1px solid var(--line);
  }
  .roundtxt{display:flex;flex-direction:column;line-height:1}
  .roundtxt b{font-size:12px}
  .roundtxt small{font-size:11px;color:var(--muted)}
  .sched{display:flex;gap:8px;flex-wrap:wrap}

  /* Fixture card */
  .fxcard{
    display:grid; grid-template-columns:auto 1fr auto; gap:12px; align-items:center;
    padding:10px; border:1px solid #2a3d63; border-radius:16px; background:#0f1b35; margin-bottom:10px;
    box-shadow:inset 0 1px 0 #ffffff1a, 0 10px 26px #0007; position:relative; overflow:hidden;
  }
  .fxcard:hover{ box-shadow:0 18px 42px #0b1225cc }
  .idx{display:flex;align-items:center;justify-content:center;width:28px;height:28px;border-radius:10px;background:#0b1324;border:1px solid var(--line);font-weight:800;font-size:12px}
  .fxteams{display:flex;align-items:center;gap:10px;font-weight:800}
  .logo-lg{width:52px;height:52px;border-radius:50%;background:#0b1324;border:1px solid #1c2741;object-fit:cover}
  .ph{width:52px;height:52px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;background:#10203c;color:#e1e9f5;font-weight:800}
  .vs{opacity:.8;margin:0 6px}
  .meta{font-size:11px;color:#cdd6e4;display:flex;gap:10px}
  .oddsbar{display:flex;gap:8px;flex-wrap:wrap}
  .oddbtn{
    min-width:64px;padding:10px 12px;border-radius:12px;border:1px solid #3a455f;background:#0c1326;color:#fff;font-weight:800;text-align:center;cursor:pointer;
    box-shadow:inset 0 1px 0 #ffffff1a, 0 8px 18px #0007;
  }
  .oddbtn:hover{filter:brightness(1.12); transform:translateY(-1px)}
  .lanechip{display:inline-flex;align-items:center;gap:6px}

  /* Racing track with lane numbers */
  .track{position:relative;height:200px;border:1px dashed var(--line);border-radius:16px;margin:8px 0 10px;background:
      linear-gradient(90deg,#0b1324 0 10px, #12203f 10px 12px, transparent 12px),
      repeating-linear-gradient(to bottom, #0f1629 0, #0f1629 26px, #0b1324 26px, #0b1324 28px);}
  .runner{position:absolute;left:46px;width:46px;height:18px;background:#e5e7eb;border-radius:4px 10px 10px 4px;box-shadow:0 0 6px #fff2, inset 0 -2px 3px #0003}
  .runner:after{content:"";position:absolute;right:-6px;top:6px;width:8px;height:8px;border-radius:50%;background:#e5e7eb;box-shadow:0 0 5px #fff4}
  .laneNo{position:absolute;left:8px;width:30px;height:18px;border-radius:6px;background:#0b1324;border:1px solid #2a3d63;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:11px;color:#dbeafe}

  /* Balls grid */
  .balls{display:grid;gap:10px}
  .balls.colors{grid-template-columns:repeat(6,1fr)}
  .balls.numbers{grid-template-columns:repeat(7,1fr)}
  .ballwrap{display:flex;flex-direction:column;align-items:center;gap:6px}
  .ball{
    height:56px;width:56px;border-radius:50%; display:flex;align-items:center;justify-content:center; font-weight:800;color:#fff;border:2px solid #00000040; position:relative;
    box-shadow:inset -6px -8px 14px #00000055, inset 6px 6px 14px #ffffff20, 0 8px 18px #0008; cursor:pointer; user-select:none; font-size:18px
  }
  .ball::after{ content:""; position:absolute; top:7px; left:10px; width:18px; height:10px; background:radial-gradient(circle at 10px 5px, #ffffffcc, #ffffff22 60%, #ffffff00 100%); border-radius:50%; filter:blur(.3px); }
  .oddlab{font-size:12px;background:#0c1326;border:1px solid #2c3c60;padding:3px 8px;border-radius:999px}
  .RED{background:#ef4444} .BLUE{background:#3b82f6} .GREEN{background:#10b981}
  .YELLOW{background:#f59e0b} .PURPLE{background:#a855f7} .BLACK{background:#111827;color:#e5e7eb;border-color:#000}

  /* Right column */
  input,button,select{font-family:inherit}
  input[type="number"],input[type="text"]{width:100%;padding:12px;border-radius:12px;border:1px solid var(--line);background:#0d1428;color:#fff}
  .btn{padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#0d1428;color:#fff;cursor:pointer;font-weight:800}
  .btn.primary{background:#0f2b1b;border-color:#1b4d28}
  .betslip{display:grid;gap:8px}
  .ticket{position:relative;padding:8px;border:1px dashed var(--line);border-radius:12px;margin-bottom:6px;background:#0c162c}
  .wm{position:absolute;inset:8px;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:28px;color:#fff1;pointer-events:none;transform:rotate(-18deg)}
  .wm.OPEN{color:#7dd3fc22} .wm.WON{color:#22c55e22} .wm.LOST{color:#ef444422}

  .toaster{position:fixed;top:16px;right:16px;display:flex;flex-direction:column;gap:10px;z-index:80}
  .toast{background:#0f1933;border:1px solid #2a3b63;color:#e6edf3;padding:10px 12px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.35);opacity:0;transform:translateY(-6px);transition:opacity .18s ease, transform .18s ease}
  .toast.show{opacity:1;transform:none}
  .toast.success{border-color:#1d3f2a;background:#0e2217}
  .toast.error{border-color:#4d1a1a;background:#2a0e0e}
  .ico{width:16px;height:16px;display:inline-block;vertical-align:middle}
</style>
</head>
<body>
<header>
  <div class="brand">
    <svg class="ico" viewBox="0 0 24 24"><path fill="#7dd3fc" d="M12 2a10 10 0 1 0 0 20a10 10 0 0 0 0-20Zm0 2a8 8 0 0 1 7.7 6H12V4Z"/></svg>
    Cashier
  </div>
  <div class="grow"></div>
  <div id="clock" class="clock">—</div>
  <a href="/aviator" class="avi-link">
    <img src="/static/img/aviator-icon.png" alt="Aviator"/>
    <b>Aviator</b>
  </a>
</header>

<div class="container">
  <!-- LEFT SURFACE -->
  <div class="panel">
    <!-- Category cards -->
    <div id="catGrid" class="tilegrid"></div>

    <!-- round/dial + schedule cards -->
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;gap:12px">
      <div style="display:flex;gap:12px;align-items:center">
        <div class="roundbar">
          <div id="dial" class="dial"></div>
          <div class="roundtxt">
            <b id="liveText">LIVE</b>
            <small id="roundLabel">—</small>
          </div>
        </div>
        <div class="tilecard" id="roundTimer">Next in —</div>
      </div>
      <div id="schedule" class="tilegrid"></div>
    </div>

    <!-- League cards -->
    <div id="leagueGrid" class="tilegrid"></div>

    <!-- Markets -->
    <div id="marketRow" class="markets"></div>

    <!-- Stage -->
    <div id="stage"></div>
  </div>

  <!-- RIGHT COLUMN (controls only) -->
  <div class="panel">
    <div class="title">Controls</div>
    <div class="tilegrid" style="margin:0">
      <div class="tilecard">Cashier: <b id="cashierId">shop-1</b></div>
      <div class="tilecard">Balance: <b id="cashBal">0 KES</b></div>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:8px">
      <input id="cashierIdInput" value="shop-1" style="max-width:160px">
      <button class="btn" onclick="applyCashier()">Set</button>
      <button class="btn" onclick="topupCashier(5000)">Top-up 5,000</button>
    </div>

    <div class="divider"></div>

    <div>
      <div class="title">Aviator Players — Wallets</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <select id="aviPlayer">
          <option value="pA">Player A</option><option value="pB">Player B</option><option value="pC">Player C</option>
        </select>
        <input id="aviAmount" type="number" value="1000" min="1" style="max-width:120px" />
        <button class="btn" onclick="aviLoad()">Load</button>
        <button class="btn" onclick="aviView()">View</button>
        <button class="btn" onclick="aviClear()">Pay & Clear</button>
        <div class="tilecard" id="aviBal">Bal: —</div>
      </div>
    </div>

    <div class="divider"></div>

    <div>
      <div class="title">History</div>
      <input id="historySearch" placeholder="Scan / type Ref or Code…" style="max-width:250px;margin:8px 0"/>
      <div id="tickets" class="list"></div>
    </div>

    <div class="divider"></div>

    <div>
      <div class="title">Betslip</div>
      <div class="betslip" id="betslip" style="display:none">
        <div class="muted" id="currentSel">No selection</div>
        <input id="stake" type="number" min="20" max="1000" value="100" placeholder="Stake (KES)"/>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <div class="tilecard">Odds: <b id="odds">—</b></div>
          <div class="tilecard">Potential: <b id="payout">—</b></div>
        </div>
        <button class="btn primary" onclick="placeBet()">Place Bet</button>
        <div class="muted">Min 20, Max 1000, Max Payout 20,000</div>
      </div>
      <div id="noSlip" class="muted">Click odds to build a betslip.</div>
    </div>

    <div class="divider"></div>

    <div>
      <div class="title">Printer Settings</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <input id="printerName" type="text" placeholder="Printer name / device (opt.)" style="max-width:240px"/>
        <label class="tilecard" style="gap:8px"><input id="autoPrint" type="checkbox"/> Auto-print after bet</label>
        <button class="btn" onclick="savePrinter()">Save</button>
        <button class="btn" onclick="testPrint()">Test Print</button>
      </div>
      <div class="muted" style="margin-top:6px">Browser print is used now; you can hook a thermal bridge later.</div>
    </div>
  </div>
</div>

<div id="toaster" class="toaster"></div>

<script>
/* ---------- Toasts ---------- */
const toaster=document.getElementById('toaster');
function notify(msg,type='info',ms=2200){
  const t=document.createElement('div');
  t.className='toast'+(type==='success'?' success':type==='error'?' error':'');
  t.textContent=msg; toaster.appendChild(t);
  requestAnimationFrame(()=>t.classList.add('show'));
  setTimeout(()=>{ t.classList.remove('show'); setTimeout(()=>t.remove(),180); }, ms);
}

/* ---------- API helper (tries same-origin, then :4000) ---------- */
const ORIGIN = location.origin;
const PORT4000 = ORIGIN.replace(/^(https?:\/\/[^/:]+)(?::\d+)?$/,'$1:4000');
const API = {
  async get(path){
    try{ const r = await fetch(`${ORIGIN}${path}`,{cache:'no-store'}); if(r.ok) return r; }catch{}
    return fetch(`${PORT4000}${path}`,{cache:'no-store'});
  },
  async post(path, body){
    const opts={method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body||{})};
    try{ const r = await fetch(`${ORIGIN}${path}`,opts); if(r.ok) return r; }catch{}
    return fetch(`${PORT4000}${path}`,opts);
  }
};
const KES = x=> new Intl.NumberFormat('en-KE',{style:'currency',currency:'KES'}).format(Number(x||0));
const el = id=>document.getElementById(id);

/* ---------- Clock ---------- */
let healthSkew=0;
async function syncClock(){
  try{ const r=await API.get('/health'); const j=await r.json(); healthSkew=j.ts-Date.now(); }catch{ healthSkew=0; }
}
setInterval(()=>{ const d=new Date(Date.now()+healthSkew); el('clock').textContent=d.toLocaleString(); }, 500);
syncClock();

/* ---------- Cashier ---------- */
let CASHIER_ID='shop-1';
async function refreshCashier(){
  try{ const r=await API.get(`/cashier/${CASHIER_ID}/balance`); const j=await r.json();
    el('cashBal').textContent = KES(j.balance||0);
    el('cashierId').textContent = CASHIER_ID;
  }catch{}
}
async function topupCashier(amount){ await API.post(`/cashier/topup`,{cashierId:CASHIER_ID,amount}); refreshCashier(); }
function applyCashier(){ CASHIER_ID = el('cashierIdInput').value || 'shop-1'; refreshCashier(); }

/* ---------- Aviator wallets ---------- */
async function aviView(){ const pid=el('aviPlayer').value;
  try{ const r=await API.get(`/aviator/wallet/${pid}`); const j=await r.json(); el('aviBal').textContent=`Bal: ${KES(j.balance||0)}`; }
  catch{ el('aviBal').textContent='Bal: —'; } }
async function aviLoad(){
  const pid=el('aviPlayer').value; const amt=Number(el('aviAmount').value||0)||0;
  if(!amt) return notify('Enter amount to load.','error');
  try{ const r=await API.post(`/aviator/wallet/load`,{playerId:pid, amount:amt}); const j=await r.json();
    el('aviBal').textContent=`Bal: ${KES(j.balance||0)}`; notify('Wallet updated','success'); }
  catch{ notify('Wallet update failed','error'); }
}
async function aviClear(){
  const pid=el('aviPlayer').value;
  try{ const r=await API.get(`/aviator/wallet/${pid}`); const j=await r.json(); const bal=j.balance||0;
    if(bal>0){ await API.post(`/aviator/wallet/load`,{playerId:pid, amount:-bal}); el('aviBal').textContent=`Bal: ${KES(0)}`; notify('Paid & cleared','success'); }
    else notify('Nothing to clear','info');
  }catch{ notify('Clear failed','error'); }
}

/* ---------- Printer settings ---------- */
function loadPrinter(){
  el('printerName').value = localStorage.getItem('printerName')||'';
  el('autoPrint').checked = localStorage.getItem('autoPrint')==='1';
}
function savePrinter(){
  localStorage.setItem('printerName', el('printerName').value.trim());
  localStorage.setItem('autoPrint', el('autoPrint').checked ? '1':'0');
  notify('Printer settings saved','success');
}
function testPrint(){ window.print(); }

/* ---------- Logos ---------- */
function logoHTML(folder, abbr, big=true){
  const code=(abbr||'???').toUpperCase();
  const base=`/static/logos/${folder}/${code}`;
  const id=`lg_${folder}_${code}_${Math.random().toString(36).slice(2,7)}`;
  const cls=big?'logo-lg':'logo';
  const img=`<img id="${id}" class="${cls}" src="${base}.png" alt="${code}">`;
  const ph =`<span class="ph ${big?'':'ph-sm'}" id="${id}_ph" style="display:none">${code}</span>`;
  setTimeout(()=>{
    const tag=document.getElementById(id), phTag=document.getElementById(id+'_ph');
    if(!tag) return;
    tag.onerror=()=>{
      if(tag.src.endsWith('.png')) tag.src=`${base}.jpg`;
      else if(tag.src.endsWith('.jpg')) tag.src=`${base}.svg`;
      else{ tag.style.display='none'; if(phTag) phTag.style.display='inline-flex'; }
    };
  },0);
  return img+ph;
}

/* ---------- Timing / schedule ---------- */
const dial=el('dial'), roundTimer=el('roundTimer'), roundLabel=el('roundLabel'), scheduleBox=el('schedule');
let CURRENT_TAB='football', CURRENT_LEAGUE='EPL', CURRENT_MARKET='MAIN', CURRENT=null;
let nextBoundaryTs=null, boundarySpanMs=0, selectedSlot=0, weekPage=0; // weekPage pages 4 weeks at a time

function ceilToStep(ms,min){ const step=min*60*1000; return Math.ceil(ms/step)*step; }
function setTiming(){
  const now = Date.now()+healthSkew;
  if(CURRENT_TAB==='football'){ nextBoundaryTs=ceilToStep(now,7); boundarySpanMs=7*60*1000; roundLabel.textContent='FOOTBALL • Weeks'; }
  else{ nextBoundaryTs=ceilToStep(now,3); boundarySpanMs=3*60*1000; roundLabel.textContent=`NEXT START • ${new Date(nextBoundaryTs).toLocaleTimeString()}`; }
  buildSchedule();
}
function buildSchedule(){
  scheduleBox.innerHTML='';
  if(CURRENT_TAB==='football'){
    // show 4 week cards per page; arrows prev/next
    const start = 1 + weekPage*4;
    const prev = document.createElement('div'); prev.className='tilecard'; prev.textContent='◀'; prev.onclick=()=>{ if(weekPage>0){weekPage--; render();} };
    const next = document.createElement('div'); next.className='tilecard'; next.textContent='▶'; next.onclick=()=>{ weekPage++; render(); };
    scheduleBox.appendChild(prev);
    for(let i=0;i<4;i++){
      const wk = start+i;
      const card=document.createElement('div'); card.className='tilecard'; if(i===selectedSlot) card.classList.add('active');
      card.innerHTML=`<b>Week ${wk}</b>`;
      card.onclick=()=>{ selectedSlot=i; document.querySelectorAll('.tilegrid .tilecard').forEach(x=>x.classList.remove('active')); card.classList.add('active'); renderFootball(); };
      scheduleBox.appendChild(card);
    }
    scheduleBox.appendChild(next);
  }else{
    const base=nextBoundaryTs-boundarySpanMs;
    for(let i=0;i<4;i++){
      const ts=base+i*boundarySpanMs;
      const card=document.createElement('div'); card.className='tilecard'; if(i===selectedSlot) card.classList.add('active');
      card.innerHTML=`<b>${new Date(ts).toLocaleTimeString()}</b>`;
      card.onclick=()=>{ selectedSlot=i; document.querySelectorAll('#schedule .tilecard').forEach(x=>x.classList.remove('active')); card.classList.add('active'); render(); };
      scheduleBox.appendChild(card);
    }
  }
}
function tickDial(){
  const now=Date.now()+healthSkew;
  const remain=Math.max(0,(nextBoundaryTs||now)-now);
  const ratio=boundarySpanMs?1-remain/boundarySpanMs:0;
  const deg=Math.max(0,Math.min(360,ratio*360));
  dial.style.setProperty('--p',deg+'deg');
  const ss=Math.ceil(remain/1000), mm=Math.floor(ss/60), s=ss%60;
  roundTimer.textContent=`Next in ${String(mm).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
  if(remain<=0){ nextBoundaryTs+=boundarySpanMs; buildSchedule(); render(true); }
}
setInterval(tickDial,500);

/* ---------- Betslip ---------- */
function showSlip(b){ el('betslip').style.display=b?'block':'none'; el('noSlip').style.display=b?'none':'block'; }
function validateStake(raw){
  const stake=Number(raw); if(!Number.isFinite(stake)||stake<=0){ notify('Enter a valid stake.','error');return null;}
  if(stake<20){notify('Minimum stake is 20 KES.','error');return null;}
  if(stake>1000){notify('Maximum stake is 1000 KES.','error');return null;}
  return stake;
}
function formatBetLabel(ev, m, sel){
  const dt=new Date((ev.runsAt||Date.now())+healthSkew);
  const dateStr = dt.toLocaleDateString();
  const timeStr = dt.toLocaleTimeString();
  let extra='';
  if(ev.game==='football'){
    const wk = 1 + weekPage*4 + selectedSlot; // visible week number
    extra=` • Week ${wk} • ${ev.league}`;
  }else if(ev.game==='ucl'){ extra=' • Round'; }
  return `${ev.game.toUpperCase()}${extra} — ${ev.home?.abbr||''} vs ${ev.away?.abbr||''} • ${dateStr} ${timeStr} — ${m.type} — ${sel.name}`;
}
function updatePotential(){
  if(!CURRENT){ el('payout').textContent='—'; return; }
  const stake=Number(el('stake').value||0), odds=Number(CURRENT.market.odds[CURRENT.selection.id]);
  el('payout').textContent = stake? KES(Math.min(stake*odds,20000)) : '—';
}
function choose(ev,m,sel){
  CURRENT={event:ev,market:m,selection:sel};
  el('currentSel').textContent = formatBetLabel(ev,m,sel);
  el('odds').textContent = m.odds[sel.id];
  updatePotential(); showSlip(true);
}
el('stake').addEventListener('input',updatePotential);

async function placeBet(){
  if(!CURRENT) return notify('Pick a selection first','error');
  const stake=validateStake(el('stake').value); if(stake==null) return;
  const payload={
    eventId:CURRENT.event.id, marketId:CURRENT.market.id, selectionId:CURRENT.selection.id,
    stake, cashierId:CASHIER_ID,
    meta:{ label:el('currentSel').textContent } // so receipt can show it if your backend stores meta
  };
  try{
    const r=await API.post(`/bets`,payload); const j=await r.json();
    if(!j.ok) return notify(j.error||'Bet failed','error');
    await refreshCashier(); await loadTickets();
    notify('Bet placed','success');
    // open receipt
    const url = `/receipt/${j.bet.id}?label=${encodeURIComponent(el('currentSel').textContent)}`;
    const w=window.open(url,'_blank','width=380,height=560'); try{w.focus();}catch{}
    // auto-print if enabled
    if(localStorage.getItem('autoPrint')==='1'){ setTimeout(()=>{ try{ w.print(); }catch{} }, 800); }
  }catch{ notify('Bet failed','error'); }
}

/* ---------- History ---------- */
async function loadTickets(){
  const r = await API.get(`/bets?cashierId=${encodeURIComponent(CASHIER_ID)}`); const list = await r.json().catch(()=>[]);
  const box = el('tickets'); box.innerHTML='';
  (list||[]).slice(0,16).forEach(t=>{
    const d=document.createElement('div'); d.className='ticket';
    const ref=t.ref||`T-${(t.id||'').slice(0,8).toUpperCase()}`;
    d.innerHTML=`<div class="wm ${t.status||'OPEN'}">${t.status||'OPEN'}</div>
                 <div><b>${ref}</b> — ${t.game?.toUpperCase()||''} — ${t.status||'OPEN'}</div>
                 <div class="muted">${KES(t.stake)} • ${t.odds} → ${t.payout?KES(t.payout):'—'}</div>`;
    box.appendChild(d);
  });
  const input = el('historySearch');
  input.oninput=()=>{
    const q=input.value.trim().toUpperCase(); if(!q) return loadTickets();
    const filtered=list.filter(t=> (t.ref||'').toUpperCase().includes(q) || (t.id||'').toUpperCase().includes(q) );
    box.innerHTML='';
    filtered.slice(0,16).forEach(t=>{
      const d=document.createElement('div'); d.className='ticket';
      const ref=t.ref||`T-${(t.id||'').slice(0,8).toUpperCase()}`;
      d.innerHTML=`<div class="wm ${t.status||'OPEN'}">${t.status||'OPEN'}</div>
                   <div><b>${ref}</b> — ${t.game?.toUpperCase()||''} — ${t.status||'OPEN'}</div>
                   <div class="muted">${KES(t.stake)} • ${t.odds} → ${t.payout?KES(t.payout):'—'}</div>`;
      box.appendChild(d);
    });
  };
}

/* ---------- Cache (keep fixtures fixed while toggling markets) ---------- */
const CACHE={events:{}, markets:{}, loadedAt:{}};
async function getEvents(game){
  const now=Date.now();
  if(CACHE.events[game] && now-(CACHE.loadedAt[game]||0)<60_000) return CACHE.events[game];
  try{ const r=await API.get(`/events?game=${game}`); const arr=await r.json(); CACHE.events[game]=arr; CACHE.loadedAt[game]=now; return arr; }
  catch{ return CACHE.events[game]||[]; }
}
async function getMarkets(eventId){
  if(!CACHE.markets[eventId]){
    try{ const r=await API.get(`/markets/${eventId}`); const arr=await r.json(); const map={}; arr.forEach(m=>map[m.type]=m); CACHE.markets[eventId]=map; }
    catch{ CACHE.markets[eventId]={}; }
  }
  return CACHE.markets[eventId];
}

/* ---------- Helpers ---------- */
function pickMarket(byType, candidates){
  const keys=Object.keys(byType||{});
  for(const c of candidates){
    if(typeof c==='string'){ if(byType[c]) return byType[c]; }
    else { const k=keys.find(k=>c.test(k)); if(k) return byType[k]; }
  }
  return null;
}

/* ---------- UI Builders (cards) ---------- */
function buildCategories(){
  const cat=el('catGrid'); cat.innerHTML='';
  const items=[
    {key:'football', label:'Football', svg:`<svg viewBox="0 0 24 24"><path fill="#93c5fd" d="M12 2a10 10 0 1 0 0 20a10 10 0 0 0 0-20Zm0 3l-3 2l1 3l-2 2l2 2l-1 3l3 2l3-2l-1-3l2-2l-2-2l1-3l-3-2Z"/></svg>`},
    {key:'dogs', label:'Dogs', svg:`<svg viewBox="0 0 24 24"><path fill="#fda4af" d="M3 7h5l2 3h6l2-3h3l-2 10H5z"/></svg>`},
    {key:'horses', label:'Horses', svg:`<svg viewBox="0 0 24 24"><path fill="#fde68a" d="M3 14h4l3-5h7l4 5v2H3z"/></svg>`},
    {key:'colors', label:'Colors & Numbers', svg:`<svg viewBox="0 0 24 24"><circle cx="8" cy="8" r="4" fill="#ef4444"/><circle cx="16" cy="8" r="4" fill="#3b82f6"/><circle cx="12" cy="16" r="4" fill="#10b981"/></svg>`}
  ];
  items.forEach(it=>{
    const d=document.createElement('div'); d.className='tilecard'; if(CURRENT_TAB===it.key) d.classList.add('active');
    d.innerHTML = it.svg + `<span>${it.label}</span>`;
    d.onclick=()=>{ CURRENT_TAB=it.key; CURRENT=null; selectedSlot=0; setTiming(); render(true); };
    cat.appendChild(d);
  });
}
function buildLeagues(){
  const lg=el('leagueGrid'); lg.innerHTML='';
  if(CURRENT_TAB!=='football'){ lg.style.display='none'; return; }
  lg.style.display='flex';
  ['EPL','LALIGA','UCL'].forEach(L=>{
    const d=document.createElement('div'); d.className='tilecard'; if(L===CURRENT_LEAGUE) d.classList.add('active');
    d.innerHTML=`<b>${L}</b>`; d.onclick=()=>{ CURRENT_LEAGUE=L; selectedSlot=0; CURRENT_MARKET='MAIN'; weekPage=0; renderFootball(); buildSchedule(); };
    lg.appendChild(d);
  });
}
function buildMarkets(labels){
  const row=el('marketRow'); row.innerHTML='';
  labels.forEach(m=>{
    const b=document.createElement('div'); b.className='mkt'; if(m===CURRENT_MARKET) b.classList.add('active');
    b.textContent=MARKET_LABELS[m]||m; b.onclick=()=>{ CURRENT_MARKET=m; render(); };
    row.appendChild(b);
  });
}

/* ---------- Football ---------- */
const MARKET_TABS = ['MAIN','OU05','OU15','OU25','OU35','BTTS','H15','A15','DC','DNB','CMB15','CMB25'];
const MARKET_LABELS = {MAIN:'MAIN',OU05:'OU 0.5',OU15:'OU 1.5',OU25:'OU 2.5',OU35:'OU 3.5',BTTS:'BTTS',H15:'HOME 1.5',A15:'AWAY 1.5',DC:'DOUBLE CHANCE',DNB:'DRAW NO BET',CMB15:'1X2+OU1.5',CMB25:'1X2+OU2.5'};

async function renderFootball(){
  buildLeagues();
  buildMarkets(MARKET_TABS);

  const stage=el('stage'); stage.innerHTML='';

  let all = await getEvents('football');
  all=(all||[]).filter(e=>e.league===CURRENT_LEAGUE).sort((a,b)=>a.runsAt-b.runsAt);
  if(!all.length){ stage.innerHTML='<div class="muted">No fixtures.</div>'; return; }

  // chunk fixed 10 per "week"
  const blocks=[]; for(let i=0;i<all.length;i+=10) blocks.push(all.slice(i,i+10));
  const blockIndex = (weekPage*4 + selectedSlot) % blocks.length;
  const blk = blocks[blockIndex];

  let i=0;
  for(const ev of blk){
    i++;
    const byType = await getMarkets(ev.id);
    const folder = (CURRENT_LEAGUE.toLowerCase()==='epl')?'epl':(CURRENT_LEAGUE.toLowerCase()==='laliga'?'laliga':'ucl');
    const H=ev.home.abbr, A=ev.away.abbr;

    const mMain  = pickMarket(byType,[`MAIN_1X2_${CURRENT_LEAGUE}`,/MAIN.*1X2.*${CURRENT_LEAGUE}/]);
    const mOU05  = pickMarket(byType,[`OU_0_5_${CURRENT_LEAGUE}`,/OU[_-]?0[_-]?5.*${CURRENT_LEAGUE}/]);
    const mOU15  = pickMarket(byType,[`OU_1_5_${CURRENT_LEAGUE}`,/OU[_-]?1[_-]?5.*${CURRENT_LEAGUE}/]);
    const mOU25  = pickMarket(byType,[`OU_2_5_${CURRENT_LEAGUE}`,/OU[_-]?2[_-]?5.*${CURRENT_LEAGUE}/]);
    const mOU35  = pickMarket(byType,[`OU_3_5_${CURRENT_LEAGUE}`,/OU[_-]?3[_-]?5.*${CURRENT_LEAGUE}/]);
    const mBTTS  = pickMarket(byType,[`BTTS_${CURRENT_LEAGUE}`,/BTTS.*${CURRENT_LEAGUE}/]);
    const mH15   = pickMarket(byType,[`HOME_OU_1_5_${CURRENT_LEAGUE}`,/HOME.*OU.*1[_-]?5.*${CURRENT_LEAGUE}/]);
    const mA15   = pickMarket(byType,[`AWAY_OU_1_5_${CURRENT_LEAGUE}`,/AWAY.*OU.*1[_-]?5.*${CURRENT_LEAGUE}/]);
    const mDC    = pickMarket(byType,[`DC_${CURRENT_LEAGUE}`,/DOUBLE[_-]?CHANCE.*${CURRENT_LEAGUE}/]);
    const mDNB   = pickMarket(byType,[`DNB_${CURRENT_LEAGUE}`,/DRAW[_-]?NO[_-]?BET.*${CURRENT_LEAGUE}/]);
    const mCMB15 = pickMarket(byType,[`COMBO_1X2_OU_1_5_${CURRENT_LEAGUE}`,/COMBO.*1X2.*OU.*1[_-]?5.*${CURRENT_LEAGUE}/]);
    const mCMB25 = pickMarket(byType,[`COMBO_1X2_OU_2_5_${CURRENT_LEAGUE}`,/COMBO.*1X2.*OU.*2[_-]?5.*${CURRENT_LEAGUE}/]);

    const mMap={MAIN:mMain,OU05:mOU05,OU15:mOU15,OU25:mOU25,OU35:mOU35,BTTS:mBTTS,H15:mH15,A15:mA15,DC:mDC,DNB:mDNB,CMB15:mCMB15,CMB25:mCMB25};
    const mdef=mMap[CURRENT_MARKET] || mMain; if(!mdef) continue;

    const card=document.createElement('div'); card.className='fxcard';

    const idx=document.createElement('div'); idx.className='idx'; idx.textContent=String(i); card.appendChild(idx);

    const mid=document.createElement('div');
    mid.innerHTML = `
      <div class="fxteams">
        ${logoHTML(folder,H,true)} <span>${H}</span> <span class="vs">vs</span>
        ${logoHTML(folder,A,true)} <span>${A}</span>
      </div>
      <div class="meta">
        <span>${new Date((ev.runsAt||Date.now())+healthSkew).toLocaleDateString()}</span>
        <span>${new Date((ev.runsAt||Date.now())+healthSkew).toLocaleTimeString()}</span>
        <span>${CURRENT_LEAGUE}</span>
        <span>Week ${1 + weekPage*4 + selectedSlot}</span>
      </div>`;
    card.appendChild(mid);

    const od=document.createElement('div'); od.className='oddsbar';
    mdef.selections.forEach(s=>{
      const b=document.createElement('div'); b.className='oddbtn'; b.textContent=mdef.odds[s.id];
      b.title=s.name; b.onclick=()=>choose(ev,mdef,s); od.appendChild(b);
    });
    card.appendChild(od);

    stage.appendChild(card);
  }
}

/* ---------- Racing ---------- */
async function renderRacing(game){
  buildLeagues(); // hidden by function if not football
  buildMarkets(['MAIN','FORECAST','QUINELLA','TRICAST']);

  const stage=el('stage'); stage.innerHTML='';
  if(!window.racingMkt) window.racingMkt = {dog:'MAIN', horse:'MAIN'};

  let events=[]; try{ const r=await API.get(`/events?game=${game}`); events=(await r.json()).slice(0,3);}catch{}
  if(!events.length){ stage.innerHTML='<div class="muted">No events.</div>'; return; }

  for(const ev of events){
    const byType = await getMarkets(ev.id);
    const want = window.racingMkt[game];

    const card=document.createElement('div'); card.className='fxcard';

    const idx=document.createElement('div'); idx.className='idx'; idx.textContent=(ev.no||'•'); card.appendChild(idx);

    const mid=document.createElement('div');
    const title = game==='dog'?'DOG RACE':'HORSE RACE';
    mid.innerHTML = `<div class="fxteams"><span style="font-weight:800">${title}</span></div>
                     <div class="meta"><span>${new Date((ev.runsAt||Date.now())+healthSkew).toLocaleTimeString()}</span><span>Track</span></div>`;
    card.appendChild(mid);

    const right=document.createElement('div'); right.style.minWidth='220px'; right.style.display='grid'; right.style.gap='8px';

    /* animated lanes */
    const lanes=document.createElement('div'); lanes.className='track';
    const main=byType['MAIN_WIN']; const count = game==='horse'?8:Math.min(12, main?main.selections.length:8);
    for(let i=0;i<count;i++){
      const y = 14 + i*22;
      const tag=document.createElement('div'); tag.className='laneNo'; tag.style.top=y+'px'; tag.textContent=String(i+1); lanes.appendChild(tag);
      const r=document.createElement('div'); r.className='runner'; r.style.top=y+'px';
      r.animate([{transform:'translateX(0)'},{transform:'translateX(10px)'},{transform:'translateX(0)'}],{duration:2200+Math.random()*1200,iterations:Infinity});
      lanes.appendChild(r);
    }
    right.appendChild(lanes);

    function addGrid(m, cols, label){
      if(!m) return;
      const row=document.createElement('div'); row.style.display='grid'; row.style.gridTemplateColumns=`repeat(${cols},1fr)`; row.style.gap='8px';
      m.selections.forEach((s,ix)=>{
        const b=document.createElement('div'); b.className='oddbtn lanechip';
        b.innerHTML=`<span style="opacity:.85">${ix+1}</span> <span>${m.odds[s.id]}</span>`;
        b.title=s.name.replace(/DOG|HORSE/gi,'').trim();
        b.onclick=()=>choose(ev,m,s); row.appendChild(b);
      });
      const labelEl=document.createElement('div'); labelEl.className='muted'; labelEl.textContent=label; right.appendChild(labelEl);
      right.appendChild(row);
    }

    if(want==='MAIN') addGrid(byType['MAIN_WIN'], 3, `${game.toUpperCase()} — WIN`);
    if(want==='FORECAST') addGrid(byType['FORECAST'], 3, 'FORECAST (Exacta)');
    if(want==='QUINELLA') addGrid(byType['QUINELLA'], 3, 'QUINELLA');
    if(want==='TRICAST') addGrid(byType['TRICAST'], 3, 'TRICAST');

    card.appendChild(right);
    stage.appendChild(card);
  }
}

/* ---------- Colors & Numbers ---------- */
function colorsSVG(){
  return `<svg width="42" height="42" viewBox="0 0 42 42" xmlns="http://www.w3.org/2000/svg">
    <defs><filter id="g" x="-50%" y="-50%" width="200%" height="200%"><feGaussianBlur stdDeviation="2"/></filter></defs>
    <circle cx="15" cy="15" r="10" fill="#ef4444"/><circle cx="27" cy="15" r="10" fill="#3b82f6"/><circle cx="21" cy="26" r="10" fill="#10b981"/>
    <ellipse cx="21" cy="12" rx="18" ry="6" fill="#ffffff20" filter="url(#g)"/>
  </svg>`;
}
async function renderColorsNumbers(){
  buildLeagues(); // hidden
  buildMarkets(['MAIN']); // simple look

  const stage=el('stage'); stage.innerHTML='';
  // Colors
  let evC,marketsC,mC; try{ evC=(await (await API.get(`/events?game=colors`)).json())[0]; marketsC=await (await API.get(`/markets/${evC.id}`)).json(); mC=marketsC.find(x=>x.type==='MAIN_COLOR'); }catch{}
  const cardC=document.createElement('div'); cardC.className='fxcard';
  cardC.innerHTML=`<div class="idx">●</div>
    <div>
      <div class="fxteams">${colorsSVG()} <span style="margin-left:8px;font-weight:800">COLORS</span></div>
      <div class="meta"><span>${new Date((evC?.runsAt||Date.now())+healthSkew).toLocaleTimeString()}</span><span>3-pool triangle</span></div>
    </div>`;
  const gridC=document.createElement('div'); gridC.className='balls colors';
  mC?.selections?.forEach(s=>{
    const w=document.createElement('div'); w.className='ballwrap';
    const b=document.createElement('div'); b.className=`ball ${s.id}`; b.textContent=s.id[0]; b.onclick=()=>choose(evC,mC,s);
    const od=document.createElement('div'); od.className='oddlab'; od.textContent=mC.odds[s.id]; w.appendChild(b); w.appendChild(od); gridC.appendChild(w);
  });
  cardC.appendChild(gridC); stage.appendChild(cardC);

  // Numbers 1–49
  let evN,marketsN,mN; try{ evN=(await (await API.get(`/events?game=lotto49`)).json())[0]; marketsN=await (await API.get(`/markets/${evN.id}`)).json(); mN=marketsN.find(x=>x.type==='PICK1'); }catch{}
  const colors=['RED','BLUE','GREEN','YELLOW','PURPLE','BLACK'];
  const cardN=document.createElement('div'); cardN.className='fxcard';
  cardN.innerHTML=`<div class="idx">#</div>
    <div>
      <div class="fxteams"><span style="font-weight:800">NUMBERS 1–49</span></div>
      <div class="meta"><span>${new Date((evN?.runsAt||Date.now())+healthSkew).toLocaleTimeString()}</span></div>
    </div>`;
  const gridN=document.createElement('div'); gridN.className='balls numbers';
  mN?.selections?.forEach(s=>{
    const idx=(Number(s.id)-1)%colors.length;
    const w=document.createElement('div'); w.className='ballwrap';
    const b=document.createElement('div'); b.className=`ball ${colors[idx]}`; b.textContent=s.id; b.onclick=()=>choose(evN,mN,s);
    const od=document.createElement('div'); od.className='oddlab'; od.textContent=mN.odds[s.id]; w.appendChild(b); w.appendChild(od); gridN.appendChild(w);
  });
  cardN.appendChild(gridN); stage.appendChild(cardN);
}

/* ---------- Router ---------- */
function render(force=false){
  buildCategories();
  setTiming(); // ensures schedule shows correct style
  if(CURRENT_TAB==='football') renderFootball();
  if(CURRENT_TAB==='dogs') renderRacing('dog');
  if(CURRENT_TAB==='horses') renderRacing('horse');
  if(CURRENT_TAB==='colors') renderColorsNumbers();
}

/* ---------- Init ---------- */
async function loadTickets(){ /* defined above, already used */ }
async function boot(){
  loadPrinter();
  await refreshCashier();
  buildCategories(); buildLeagues(); buildMarkets(MARKET_TABS);
  setTiming();
  render(true);
  await loadTickets();
  setInterval(async ()=>{ await refreshCashier(); render(); await loadTickets(); }, 9000);
}
boot();
</script>
</body>
</html>
