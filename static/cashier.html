<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Cashier</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700;800&display=swap">
  <style>
    :root{
      --bg:#070b16; --panel:#0b1428; --line:#1c2741; --text:#e6edf3; --muted:#9aa4b2;
      --accent:#22c55e; --danger:#ef4444; --warn:#f59e0b;
      --glass1:linear-gradient(180deg,#0f1a33aa,#0a1226aa);
      --glass2:linear-gradient(180deg,#112042,#0a1329);
      --ring:0 0 0 1px #2b3c62, 0 8px 28px #00000066, inset 0 1px 0 #ffffff12;
      --maxw:100%;
      --dial-bg:#0d1428; --dial-fg:#22c55e; --dial-live:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;font-family:"Space Grotesk", Inter, system-ui, Arial, sans-serif;
      background:radial-gradient(140% 120% at 50% -20%, #122445 0 45%, #0b1324 46% 100%);
      color:var(--text)
    }
    a{color:#7dd3fc;text-decoration:none}

    header{
      position:sticky; top:0; z-index:50; display:flex; align-items:center; gap:12px;
      padding:10px 16px; border-bottom:1px solid var(--line);
      background:rgba(8,12,24,.85); backdrop-filter:blur(10px)
    }
    .brand{font-weight:800;letter-spacing:.3px;font-size:18px;display:flex;align-items:center;gap:8px}
    .grow{flex:1}

    /* Unified glossy pill system */
    .pill, .mkt, .seg .segbtn, .oddbtn, input[type="number"], input[type="text"], .btn{
      background:var(--glass1);
      border:1px solid #2b3c62;
      box-shadow:var(--ring);
      border-radius:14px;
    }
    .pill{padding:10px 14px;font-size:12px}
    .pill.badge{display:inline-flex;gap:8px;align-items:center}
    .pill.solid{background:var(--glass2);}

    .clock{min-width:260px;text-align:right;font-weight:900;letter-spacing:.2px;font-size:14px}

    /* Aviator CTA: larger + glossy */
    .aviator-link{display:inline-flex;align-items:center;gap:12px;padding:12px 16px;border-radius:18px;transform:translateZ(0)}
    .aviator-link img{width:32px;height:32px;border-radius:8px}
    .aviator-link b{font-size:16px}

    .roundbar{display:flex;align-items:center;gap:10px}
    .dial{
      --p:0deg; --col:var(--dial-fg);
      width:44px;height:44px;border-radius:50%;
      background:
        conic-gradient(var(--col) var(--p), #0000 var(--p)),
        radial-gradient(circle 19px, #0000 18px, var(--dial-bg) 19px);
      border:1px solid var(--line);
    }
    .dial.live{ --col: var(--dial-live); animation:pulse 1.1s infinite alternate }
    @keyframes pulse{from{filter:brightness(1)}to{filter:brightness(1.25)}}
    .roundtxt{display:flex;flex-direction:column;line-height:1}
    .roundtxt b{font-size:12px}
    .roundtxt small{font-size:11px;color:var(--muted)}

    .sched{display:flex;gap:8px;flex-wrap:wrap}
    .slot{display:flex;flex-direction:column;gap:4px;align-items:center;justify-content:center;min-width:96px;padding:8px;cursor:pointer}
    .slot.active{outline:2px solid var(--accent)}
    .slot small{font-size:11px;color:var(--muted)}

    .container{max-width:var(--maxw);margin:0 auto;padding:10px 10px 14px;display:grid;grid-template-columns:minmax(0,2.1fr) minmax(0,.9fr);gap:14px}
    @media (max-width:1100px){ .container{grid-template-columns:1fr} }

    .panel{background:var(--panel);border:1px solid var(--line);border-radius:18px;padding:12px}
    .title{font-weight:800;margin-bottom:8px}
    .muted{color:var(--muted);font-size:12px}
    .divider{height:1px;background:var(--line);margin:10px 0}

    /* Segmented tabs */
    .seg{display:inline-flex;border-radius:14px;overflow:hidden;border:1px solid #2b3c62;background:var(--glass2)}
    .seg .segbtn{padding:10px 16px;font-weight:800;cursor:pointer;border-right:1px solid #2b3c62;user-select:none}
    .seg .segbtn:last-child{border-right:none}
    .seg .segbtn[aria-pressed="true"]{background:#133262;outline:2px solid var(--accent)}

    .tiles-wrap{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px}

    /* Markets strip */
    .markets{display:flex;gap:6px;flex-wrap:wrap;margin:6px 0 10px}
    .mkt{padding:8px 12px;cursor:pointer;font-size:12px;font-weight:800}
    .mkt.active{outline:2px solid #22c55e}

    /* Glossy card fixtures */
    .fxrow{
      display:grid; grid-template-columns:30px 1fr auto; gap:10px; align-items:center;
      padding:10px;border-radius:16px;margin-bottom:10px;
      background:linear-gradient(180deg,#0f1d3d,#0b152b); border:1px solid #2a3e6a; box-shadow:var(--ring)
    }
    .fxrow:hover{transform:translateY(-1px); filter:brightness(1.02)}
    .fxteams{display:flex;align-items:center;gap:10px;font-weight:800}
    .logo-lg{width:56px;height:56px;border-radius:50%;background:#0b1324;border:1px solid #1c2741;object-fit:cover}
    .ph{width:56px;height:56px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;background:#10203c;color:#9fb3d4;font-weight:800;font-size:18px}
    .vs{opacity:.7;margin:0 6px}
    .oddsbar{display:flex;gap:8px;flex-wrap:wrap}
    .oddbtn{min-width:56px;padding:10px 12px;text-align:center;cursor:pointer;font-weight:800}
    .oddbtn:hover{filter:brightness(1.14)}
    .idx{display:flex;align-items:center;justify-content:center;width:28px;height:28px;border-radius:10px;background:#0b1324;border:1px solid var(--line);font-weight:800;font-size:12px}

    /* Balls (colors & numbers) */
    .balls{display:grid;gap:10px}
    .balls.colors{grid-template-columns:repeat(6,1fr)}
    .balls.numbers{grid-template-columns:repeat(7,1fr)}
    .ballwrap{display:flex;flex-direction:column;align-items:center;gap:6px}
    .ball{height:52px;width:52px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:800;color:#fff;border:2px solid #00000040;position:relative;box-shadow:inset -6px -8px 14px #00000055, inset 6px 6px 14px #ffffff1a, 0 2px 6px #00000066;cursor:pointer;user-select:none;font-size:18px}
    .ball::after{content:""; position:absolute; top:7px; left:10px; width:18px; height:10px; background:radial-gradient(circle at 10px 5px, #ffffffcc, #ffffff22 60%, #ffffff00 100%); border-radius:50%; filter:blur(.3px)}
    .oddlab{font-size:12px;background:#0c1326;border:1px solid #2c3c60;padding:3px 8px;border-radius:999px}
    .RED{background:#ef4444}.BLUE{background:#3b82f6}.GREEN{background:#10b981}.YELLOW{background:#f59e0b}.PURPLE{background:#a855f7}.BLACK{background:#111827;color:#e5e7eb;border-color:#000}

    .betslip{display:grid;gap:8px}
    input,button,select{font-family:inherit}
    input[type="number"], input[type="text"]{width:100%;padding:12px;color:#fff}
    .btn{padding:12px 14px;color:#fff;cursor:pointer;font-weight:900}
    .btn.primary{background:linear-gradient(180deg,#10361e,#0b2617);border-color:#1b4d28}
    .ticket{position:relative;padding:8px;border:1px dashed var(--line);border-radius:12px;margin-bottom:6px;background:#0c162c}
    .wm{position:absolute;inset:8px;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:28px;color:#fff1;pointer-events:none;transform:rotate(-18deg)}
    .wm.OPEN{color:#7dd3fc22}.wm.WON{color:#22c55e22}.wm.LOST{color:#ef444422}

    .ico{width:16px;height:16px;display:inline-block;vertical-align:middle}
    .toaster{position:fixed;top:16px;right:16px;display:flex;flex-direction:column;gap:10px;z-index:80}
    .toast{background:#0f1933;border:1px solid #2a3b63;color:#e6edf3;padding:10px 12px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.35);opacity:0;transform:translateY(-6px);transition:opacity .18s ease, transform .18s ease}
    .toast.show{opacity:1;transform:none}
    .toast.success{border-color:#1d3f2a;background:#0e2217}
    .toast.error{border-color:#4d1a1a;background:#2a0e0e}
  </style>
</head>
<body>
<header>
  <div class="brand">
    <svg class="ico" viewBox="0 0 24 24"><path fill="#7dd3fc" d="M12 2a10 10 0 1 0 0 20a10 10 0 0 0 0-20Zm0 2a8 8 0 0 1 7.7 6H12V4Z"/></svg>
    Cashier
  </div>
  <div class="grow"></div>
  <div class="pill clock" id="clock">—</div>
  <a href="/aviator" class="aviator-link pill solid badge">
    <img src="/static/img/aviator-icon.png" alt="Aviator"/>
    <b>Aviator</b>
  </a>
</header>

<div class="container">
  <div class="panel">
    <!-- Category tabs -->
    <div class="tiles-wrap">
      <div class="seg" role="tablist" aria-label="Game categories">
        <button class="segbtn" data-tab="football" aria-pressed="true">Football</button>
        <button class="segbtn" data-tab="dogs" aria-pressed="false">Dogs</button>
        <button class="segbtn" data-tab="horses" aria-pressed="false">Horses</button>
        <button class="segbtn" data-tab="colors" aria-pressed="false">Colors & Numbers</button>
      </div>
    </div>

    <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:6px;display:flex">
      <div style="display:flex;gap:12px;align-items:center">
        <div class="roundbar">
          <div id="dial" class="dial" title="Next switch"></div>
          <div class="roundtxt">
            <b id="liveText">LIVE</b>
            <small id="roundLabel">—</small>
          </div>
        </div>
        <div class="pill" id="roundTimer">Next in —</div>
      </div>
      <!-- Football = weeks; Others = time slots -->
      <div class="sched" id="schedule"></div>
    </div>

    <div class="chips" id="leagueChips" style="display:flex"></div>
    <div id="stage"></div>
  </div>

  <div class="panel">
    <div class="title">Controls</div>
    <div class="row" style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
      <div class="pill badge" id="cashierIdShow">
        <svg class="ico" viewBox="0 0 24 24"><path fill="#a7f3d0" d="M4 4h16v4H4zM4 10h10v10H4zM16 10h4v6h-4z"/></svg>
        Cashier: <b id="cashierId">shop-1</b>
      </div>
      <div class="pill">Balance: <b id="cashBal">0 KES</b></div>
      <input id="cashierIdInput" value="shop-1" style="max-width:160px">
      <button class="btn" onclick="applyCashier()">Set</button>
      <button class="btn" onclick="topupCashier(5000)">Top-up 5,000</button>
    </div>
    <div class="divider"></div>

    <div>
      <div class="title">Aviator Players — Wallets</div>
      <div class="row" style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <select id="aviPlayer">
          <option value="pA">Player A</option>
          <option value="pB">Player B</option>
          <option value="pC">Player C</option>
        </select>
        <input id="aviAmount" type="number" value="1000" min="1" style="max-width:120px" />
        <button class="btn" onclick="aviLoad()">Load</button>
        <button class="btn" onclick="aviView()">View</button>
        <button class="btn" onclick="aviClear()">Pay & Clear</button>
        <div class="pill" id="aviBal">Bal: —</div>
      </div>
    </div>

    <div class="divider"></div>

    <div>
      <div class="title">History</div>
      <input id="historySearch" placeholder="Scan / type Ref or Code…" style="max-width:220px;margin-top:6px"/>
      <div id="tickets" class="list" style="margin-top:8px"></div>
    </div>

    <div class="divider"></div>

    <div>
      <div class="title">Betslip</div>
      <div class="betslip" id="betslip" style="display:none">
        <div class="muted" id="currentSel">No selection</div>
        <input id="stake" type="number" min="20" max="1000" value="100" placeholder="Stake (KES)"/>
        <div class="row" style="display:flex;gap:8px;flex-wrap:wrap">
          <div class="pill">Odds: <b id="odds">—</b></div>
          <div class="pill">Potential: <b id="payout">—</b></div>
        </div>
        <label class="pill" style="display:flex;align-items:center;gap:8px;cursor:pointer">
          <input id="autoPrint" type="checkbox" style="accent-color:#22c55e"> Auto-print receipt after placing bet
        </label>
        <div class="muted">Min 20, Max 1000, Max Payout 20,000</div>
        <button class="btn primary" onclick="placeBet()">Place Bet</button>
      </div>
      <div id="noSlip" class="muted">Click a market to build a betslip.</div>

      <div class="divider"></div>

      <div class="title">Printer Settings</div>
      <div class="row" style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <input id="printerName" placeholder="Printer name / device (optional)" style="max-width:260px"/>
        <button class="btn" onclick="savePrinter()">Save</button>
        <button class="btn" onclick="testPrint()">Test Print</button>
      </div>
      <div class="muted">Browser print will be used. A thermal bridge/service can be integrated later.</div>
    </div>
  </div>
</div>

<div id="toaster" class="toaster"></div>

<script>
/* ---------- Toasts ---------- */
const toaster=document.getElementById('toaster');
function notify(msg,type='info',ms=2200){
  const t=document.createElement('div');
  t.className='toast'+(type==='success'?' success':type==='error'?' error':'');
  t.textContent=msg; toaster.appendChild(t);
  requestAnimationFrame(()=>t.classList.add('show'));
  setTimeout(()=>{ t.classList.remove('show'); setTimeout(()=>t.remove(),180); }, ms);
}

/* ---------- API helper (tries same-origin, then :4000) ---------- */
const ORIGIN = location.origin;
const PORT4000 = ORIGIN.replace(/^(https?:\/\/[^\/:]+)(?::\d+)?$/,'$1:4000');
const API = {
  async get(path){
    try{ const r = await fetch(`${ORIGIN}${path}`,{cache:'no-store'}); if(r.ok) return r; }catch{}
    return fetch(`${PORT4000}${path}`,{cache:'no-store'});
  },
  async post(path, body){
    const opts={method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body||{})};
    try{ const r = await fetch(`${ORIGIN}${path}`,opts); if(r.ok) return r; }catch{}
    return fetch(`${PORT4000}${path}`,opts);
  }
};
const KES = x=> new Intl.NumberFormat('en-KE',{style:'currency',currency:'KES'}).format(Number(x||0));
const el = id=>document.getElementById(id);

/* ---------- Clock ---------- */
let healthSkew=0;
async function syncClock(){
  try{ const r=await API.get('/health'); const j=await r.json(); healthSkew=j.ts-Date.now(); }catch{ healthSkew=0; }
}
setInterval(()=>{ const d=new Date(Date.now()+healthSkew); el('clock').textContent=d.toLocaleString(); }, 500);
syncClock();

/* ---------- Cashier ---------- */
let CASHIER_ID = 'shop-1';
async function refreshCashier(){
  try{ const r=await API.get(`/cashier/${CASHIER_ID}/balance`); const j=await r.json();
    el('cashBal').textContent = KES(j.balance||0);
    el('cashierId').textContent = CASHIER_ID;
  }catch{}
}
async function topupCashier(amount){ await API.post(`/cashier/topup`,{cashierId:CASHIER_ID,amount}); refreshCashier(); }
function applyCashier(){ CASHIER_ID = el('cashierIdInput').value || 'shop-1'; refreshCashier(); }

/* ---------- Aviator wallets ---------- */
async function aviView(){ const pid=el('aviPlayer').value; try{ const r=await API.get(`/aviator/wallet/${pid}`); const j=await r.json(); el('aviBal').textContent=`Bal: ${KES(j.balance||0)}`; }catch{ el('aviBal').textContent='Bal: —'; } }
async function aviLoad(){
  const pid=el('aviPlayer').value; const amt=Number(el('aviAmount').value||0)||0;
  if (!amt) return notify('Enter amount to load.','error');
  try{ const r=await API.post(`/aviator/wallet/load`,{playerId:pid, amount:amt}); const j=await r.json(); el('aviBal').textContent=`Bal: ${KES(j.balance||0)}`; notify('Wallet updated','success'); }catch{ notify('Wallet update failed','error'); }
}
async function aviClear(){
  const pid=el('aviPlayer').value;
  try{ const r=await API.get(`/aviator/wallet/${pid}`); const j=await r.json(); const bal=j.balance||0;
    if (bal>0){ await API.post(`/aviator/wallet/load`,{playerId:pid, amount:-bal}); el('aviBal').textContent=`Bal: ${KES(0)}`; notify('Paid & cleared','success'); }
    else notify('Nothing to clear','info');
  }catch{ notify('Clear failed','error'); }
}

/* ---------- Logos ---------- */
function logoHTML(folder, abbr, big=true){
  const code = (abbr||'???').toUpperCase();
  const base = `/static/logos/${folder}/${code}`;
  const id = `lg_${folder}_${code}_${Math.random().toString(36).slice(2,7)}`;
  const cls = big ? 'logo-lg' : 'logo';
  const img = `<img id="${id}" class="${cls}" src="${base}.png" alt="${code}">`;
  const ph  = `<span class="ph ${big?'':'ph-sm'}" id="${id}_ph" style="display:none">${code}</span>`;
  setTimeout(()=>{
    const tag = document.getElementById(id), phTag=document.getElementById(id+'_ph');
    if(!tag) return;
    tag.onerror = ()=>{
      if (tag.src.endsWith('.png')) tag.src = `${base}.jpg`;
      else if (tag.src.endsWith('.jpg')) tag.src = `${base}.svg`;
      else { tag.style.display='none'; if (phTag) phTag.style.display='inline-flex'; }
    };
  },0);
  return img+ph;
}

/* ---------- Timing & Schedules ---------- */
const dial = el('dial'); const roundTimer=el('roundTimer'); const roundLabel=el('roundLabel'); const scheduleBox=el('schedule');
let CURRENT_TAB='football', CURRENT=null, CURRENT_LEAGUE='EPL', CURRENT_MARKET='MAIN';
let nextBoundaryTs=null, boundarySpanMs=0, selectedSlot=0, weekPointer=0;

function ceilToStep(ms, min){ const step=min*60*1000; return Math.ceil(ms/step)*step; }
function buildTimeSchedule(stepMin){
  scheduleBox.className='sched';
  scheduleBox.innerHTML='';
  const base = nextBoundaryTs - boundarySpanMs;
  for(let i=0;i<4;i++){
    const ts = base + i*boundarySpanMs;
    const label = new Date(ts).toLocaleTimeString();
    const slot=document.createElement('div'); slot.className='slot pill'; if(i===selectedSlot) slot.classList.add('active');
    slot.innerHTML = `<b>${label}</b><small>${stepMin} min</small>`;
    slot.onclick=()=>{ selectedSlot=i; document.querySelectorAll('.slot').forEach(x=>x.classList.remove('active')); slot.classList.add('active'); refreshByTab(true); };
    scheduleBox.appendChild(slot);
  }
}
function buildWeekSchedule(totalWeeks){
  scheduleBox.className='seg';
  scheduleBox.innerHTML='';
  for(let i=0;i<totalWeeks;i++){
    const btn=document.createElement('button'); btn.className='segbtn'; btn.textContent=`Week ${i+1}`; btn.setAttribute('aria-pressed', i===weekPointer?'true':'false');
    btn.onclick=()=>{ weekPointer=i; renderFootball(); };
    scheduleBox.appendChild(btn);
  }
}
function setTiming(){
  const now = Date.now()+healthSkew;
  if (CURRENT_TAB==='football'){
    nextBoundaryTs = ceilToStep(now, 7);
    boundarySpanMs = 7*60*1000;
    roundLabel.textContent = `WEEK VIEW`;
    // weeks are built in renderFootball() once we know total
  }else{
    nextBoundaryTs = ceilToStep(now, 3);
    boundarySpanMs = 3*60*1000;
    roundLabel.textContent = `NEXT START • ${new Date(nextBoundaryTs).toLocaleTimeString()}`;
    buildTimeSchedule(boundarySpanMs/60000);
  }
}
function tickDial(){
  const now = Date.now()+healthSkew;
  const remain = Math.max(0, (nextBoundaryTs||now) - now);
  const ratio = boundarySpanMs ? 1 - remain / boundarySpanMs : 0;
  const deg = Math.max(0, Math.min(360, ratio*360));
  dial.style.setProperty('--p', deg+'deg');
  const ss = Math.ceil(remain/1000), mm=Math.floor(ss/60), s=ss%60;
  roundTimer.textContent = `Next in ${String(mm).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
  if (remain<=0){
    nextBoundaryTs += boundarySpanMs;
    if (CURRENT_TAB==='football'){ weekPointer++; }
    if (CURRENT_TAB!=='football') buildTimeSchedule(boundarySpanMs/60000);
    refreshByTab(false, true);
  }
}
setInterval(tickDial, 500);

/* ---------- Betslip ---------- */
function showSlip(b){ el('betslip').style.display=b?'block':'none'; el('noSlip').style.display=b?'none':'block'; }
function validateStake(raw){
  const stake=Number(raw); if(!Number.isFinite(stake)||stake<=0){ notify('Enter a valid stake.','error');return null;}
  if(stake<20){notify('Minimum stake is 20 KES.','error');return null;}
  if(stake>1000){notify('Maximum stake is 1000 KES.','error');return null;}
  return stake;
}
function fmtDate(ts){ const d=new Date(ts+healthSkew); return d.toLocaleString(); }
function updatePotential(){
  if(!CURRENT){ el('payout').textContent='—'; return; }
  const stake=Number(el('stake').value||0), odds=Number(CURRENT.market.odds[CURRENT.selection.id]);
  el('payout').textContent = stake? KES(Math.min(stake*odds,20000)) : '—';
}
function choose(ev,m,sel){
  const tag = CURRENT_TAB==='football' ? `Week ${computeWeekIndex(ev) + 1}` : new Date(ev.runsAt+healthSkew).toLocaleTimeString();
  CURRENT={event:ev,market:m,selection:sel};
  el('currentSel').innerHTML=`<b>${ev.game.toUpperCase()}</b> • ${tag} • ${fmtDate(ev.runsAt)}<br>${m.type} — ${sel.name}`;
  el('odds').textContent=m.odds[sel.id];
  updatePotential(); showSlip(true);
}
el('stake').addEventListener('input',updatePotential);

async function placeBet(){
  if(!CURRENT) return notify('Pick a selection first','error');
  const stake=validateStake(el('stake').value); if(stake==null) return;
  const wkIndex = CURRENT_TAB==='football' ? computeWeekIndex(CURRENT.event) + 1 : null;
  const payload={
    eventId:CURRENT.event.id, marketId:CURRENT.market.id, selectionId:CURRENT.selection.id,
    stake, cashierId:CASHIER_ID, slot:selectedSlot,
    meta:{ label: CURRENT_TAB==='football'?`Week ${wkIndex}`: new Date(CURRENT.event.runsAt+healthSkew).toLocaleTimeString(),
           datetime: fmtDate(CURRENT.event.runsAt), week: wkIndex }
  };
  const r=await API.post(`/bets`,payload); const j=await r.json();
  if(!j.ok){ notify(j.error||'Bet failed','error'); return; }
  await refreshCashier(); await loadTickets();

  // Open receipt and optionally auto-print
  const auto = el('autoPrint').checked || localStorage.getItem('mm_auto_print')==='1';
  const w=window.open(`/receipt/${j.bet.id}`,'_blank','width=400,height=620');
  try{ if (auto && w) w.addEventListener('load',()=>{ try{ w.focus(); w.print(); }catch{} }); }catch{}
  notify('Bet placed','success');
}

/* ---------- Printer Settings ---------- */
(function initPrinter(){
  const saved = localStorage.getItem('mm_printer_name') || '';
  const auto = localStorage.getItem('mm_auto_print')==='1';
  if (saved) el('printerName').value = saved;
  if (auto) el('autoPrint').checked = true;
})();
function savePrinter(){
  localStorage.setItem('mm_printer_name', el('printerName').value.trim());
  localStorage.setItem('mm_auto_print', el('autoPrint').checked ? '1':'0');
  notify('Printer settings saved','success');
}
function testPrint(){
  const w = window.open('', '_blank', 'width=380,height=560');
  if(!w){ notify('Allow popups to test print.','error'); return; }
  w.document.write(`<pre style="font:14px/1.4 monospace;margin:16px">*** TEST PRINT ***\nDevice: ${localStorage.getItem('mm_printer_name')||'Browser Default'}\nTime: ${new Date().toLocaleString()}\n\nIf this printed, your browser printing works.\n</pre>`);
  w.document.close(); try{w.focus(); w.print();}catch{}
}

/* ---------- History ---------- */
async function loadTickets(){
  const r = await API.get(`/bets?cashierId=${encodeURIComponent(CASHIER_ID)}`); const list = await r.json();
  const box = el('tickets'); box.innerHTML='';
  list.slice(0,16).forEach(t=>{
    const d=document.createElement('div'); d.className='ticket';
    const ref=t.ref||`T-${(t.id||'').slice(0,8).toUpperCase()}`;
    d.innerHTML=`<div class="wm ${t.status||'OPEN'}">${t.status||'OPEN'}</div>
                 <div><b>${ref}</b> — ${t.game?.toUpperCase()||''} — ${t.status||'OPEN'}</div>
                 <div class="muted">${KES(t.stake)} • ${t.odds} → ${t.payout?KES(t.payout):'—'}</div>`;
    box.appendChild(d);
  });
  const input = el('historySearch');
  input.oninput=()=>{
    const q=input.value.trim().toUpperCase(); if(!q) return loadTickets();
    const filtered=list.filter(t=> (t.ref||'').toUpperCase().includes(q) || (t.id||'').toUpperCase().includes(q) );
    const box2=el('tickets'); box2.innerHTML='';
    filtered.slice(0,16).forEach(t=>{
      const d=document.createElement('div'); d.className='ticket';
      const ref=t.ref||`T-${(t.id||'').slice(0,8).toUpperCase()}`;
      d.innerHTML=`<div class="wm ${t.status||'OPEN'}">${t.status||'OPEN'}</div>
                   <div><b>${ref}</b> — ${t.game?.toUpperCase()||''} — ${t.status||'OPEN'}</div>
                   <div class="muted">${KES(t.stake)} • ${t.odds} → ${t.payout?KES(t.payout):'—'}</div>`;
      box2.appendChild(d);
    });
  };
}

/* ---------- Caches ---------- */
const CACHE = { events:{}, markets:{}, loadedAt:{} };
async function getEvents(game){
  const now = Date.now();
  if (CACHE.events[game] && now - (CACHE.loadedAt[game]||0) < 60_000) return CACHE.events[game];
  try{ const r=await API.get(`/events?game=${game}`); const arr=await r.json(); CACHE.events[game]=arr; CACHE.loadedAt[game]=now; return arr; }catch{ return CACHE.events[game]||[]; }
}
async function getMarkets(eventId){
  if (!CACHE.markets[eventId]){
    try{ const r=await API.get(`/markets/${eventId}`); const arr=await r.json(); const map={}; arr.forEach(m=>map[m.type]=m); CACHE.markets[eventId]=map; }
    catch{ CACHE.markets[eventId]={}; }
  }
  return CACHE.markets[eventId];
}

/* ---------- Helpers ---------- */
function pickMarket(byType, candidates){
  const keys=Object.keys(byType||{});
  for(const c of candidates){
    if(typeof c==='string'){ if(byType[c]) return byType[c]; }
    else { const k=keys.find(k=>c.test(k)); if(k) return byType[k]; }
  }
  return null;
}

/* ---------- FOOTBALL (weeks of 10 fixtures) ---------- */
const MARKET_TABS = ['MAIN','OU05','OU15','OU25','OU35','BTTS','H15','A15','DC','DNB','CMB15','CMB25'];
const MLAB={MAIN:'MAIN',OU05:'OU 0.5',OU15:'OU 1.5',OU25:'OU 2.5',OU35:'OU 3.5',BTTS:'BTTS',H15:'HOME 1.5',A15:'AWAY 1.5',DC:'DOUBLE CHANCE',DNB:'DRAW NO BET',CMB15:'1X2+OU1.5',CMB25:'1X2+OU2.5'};

function computeWeekIndex(ev){
  // recompute based on current filtered list order
  if(!window._football_all) return 0;
  const idx = window._football_all.findIndex(x=>x.id===ev.id);
  return Math.floor(Math.max(0, idx)/10); // 10 fixtures per week
}

async function renderFootball(){
  const stage=el('stage'); stage.innerHTML='';

  // League chips
  el('leagueChips').style.display='flex';
  const head=el('leagueChips'); head.innerHTML='';
  ['EPL','LALIGA','UCL'].forEach(L=>{
    const c=document.createElement('div'); c.className='pill'; c.style.cursor='pointer'; if(L===CURRENT_LEAGUE) c.style.outline='2px solid var(--accent)';
    c.innerHTML=`<b>${L}</b>`; c.onclick=()=>{ CURRENT_LEAGUE=L; weekPointer=0; CURRENT_MARKET='MAIN'; renderFootball(); };
    head.appendChild(c);
  });

  // Markets tabs
  const mrow=document.createElement('div'); mrow.className='markets';
  MARKET_TABS.forEach(m=>{ const b=document.createElement('div'); b.className='mkt'; if(m===CURRENT_MARKET) b.classList.add('active'); b.textContent=MLAB[m]; b.onclick=()=>{CURRENT_MARKET=m; renderFootball();}; mrow.appendChild(b);});
  stage.appendChild(mrow);

  // Fixtures
  let all = await getEvents('football');
  all=(all||[]).filter(e=>e.league===CURRENT_LEAGUE).sort((a,b)=>a.runsAt-b.runsAt);
  window._football_all = all.slice(); // for computeWeekIndex
  if(!all.length){ stage.innerHTML+='<div class="muted">No fixtures.</div>'; return; }

  // Build weeks (10 per)
  const weeks=[]; for(let i=0;i<all.length;i+=10) weeks.push(all.slice(i,i+10));
  const totalWeeks = weeks.length;
  if (weekPointer>=totalWeeks) weekPointer=totalWeeks-1;
  if (weekPointer<0) weekPointer=0;

  // Build week segmented buttons
  buildWeekSchedule(totalWeeks);

  const blk = weeks[weekPointer];

  let rowIndex=0;
  for(const ev of blk){
    rowIndex++;
    const byType = await getMarkets(ev.id);

    const folder = CURRENT_LEAGUE.toLowerCase()==='epl'?'epl':(CURRENT_LEAGUE.toLowerCase()==='laliga'?'laliga':'ucl');
    const H=ev.home.abbr, A=ev.away.abbr;

    const mMain  = pickMarket(byType,[`MAIN_1X2_${CURRENT_LEAGUE}`,/MAIN.*1X2.*${CURRENT_LEAGUE}/]);
    const mOU05  = pickMarket(byType,[`OU_0_5_${CURRENT_LEAGUE}`,/OU[_-]?0[_-]?5.*${CURRENT_LEAGUE}/]);
    const mOU15  = pickMarket(byType,[`OU_1_5_${CURRENT_LEAGUE}`,/OU[_-]?1[_-]?5.*${CURRENT_LEAGUE}/]);
    const mOU25  = pickMarket(byType,[`OU_2_5_${CURRENT_LEAGUE}`,/OU[_-]?2[_-]?5.*${CURRENT_LEAGUE}/]);
    const mOU35  = pickMarket(byType,[`OU_3_5_${CURRENT_LEAGUE}`,/OU[_-]?3[_-]?5.*${CURRENT_LEAGUE}/]);
    const mBTTS  = pickMarket(byType,[`BTTS_${CURRENT_LEAGUE}`,/BTTS.*${CURRENT_LEAGUE}/]);
    const mH15   = pickMarket(byType,[`HOME_OU_1_5_${CURRENT_LEAGUE}`,/HOME.*OU.*1[_-]?5.*${CURRENT_LEAGUE}/]);
    const mA15   = pickMarket(byType,[`AWAY_OU_1_5_${CURRENT_LEAGUE}`,/AWAY.*OU.*1[_-]?5.*${CURRENT_LEAGUE}/]);
    const mDC    = pickMarket(byType,[`DC_${CURRENT_LEAGUE}`,/DOUBLE[_-]?CHANCE.*${CURRENT_LEAGUE}/]);
    const mDNB   = pickMarket(byType,[`DNB_${CURRENT_LEAGUE}`,/DRAW[_-]?NO[_-]?BET.*${CURRENT_LEAGUE}/]);
    const mCMB15 = pickMarket(byType,[`COMBO_1X2_OU_1_5_${CURRENT_LEAGUE}`,/COMBO.*1X2.*OU.*1[_-]?5.*${CURRENT_LEAGUE}/]);
    const mCMB25 = pickMarket(byType,[`COMBO_1X2_OU_2_5_${CURRENT_LEAGUE}`,/COMBO.*1X2.*OU.*2[_-]?5.*${CURRENT_LEAGUE}/]);

    const mMap={MAIN:mMain,OU05:mOU05,OU15:mOU15,OU25:mOU25,OU35:mOU35,BTTS:mBTTS,H15:mH15,A15:mA15,DC:mDC,DNB:mDNB,CMB15:mCMB15,CMB25:mCMB25};
    const mdef=mMap[CURRENT_MARKET] || mMain;
    if(!mdef) continue;

    const row=document.createElement('div'); row.className='fxrow';
    const idx=document.createElement('div'); idx.className='idx'; idx.textContent=String(rowIndex); row.appendChild(idx);

    const t=document.createElement('div'); t.className='fxteams';
    t.innerHTML = `${logoHTML(folder,H,true)} <span>${H}</span> <span class="vs">vs</span> ${logoHTML(folder,A,true)} <span>${A}</span>`;
    row.appendChild(t);

    const od=document.createElement('div'); od.className='oddsbar';
    mdef.selections.forEach(s=>{
      const b=document.createElement('div'); b.className='oddbtn'; b.textContent=mdef.odds[s.id];
      b.title = `${s.name}`; b.onclick=()=>choose(ev,mdef,s); od.appendChild(b);
    });
    row.appendChild(od);

    stage.appendChild(row);
  }
}

/* ---------- Racing ---------- */
async function renderRacing(game){
  el('leagueChips').style.display='none';
  const stage=el('stage'); stage.innerHTML='';

  if (!window.racingMkt) window.racingMkt = {dog:'MAIN', horse:'MAIN'};
  const mrow=document.createElement('div'); mrow.className='markets';
  ['MAIN','FORECAST','QUINELLA','TRICAST'].forEach(m=>{
    const b=document.createElement('div'); b.className='mkt'; if(window.racingMkt[game]===m) b.classList.add('active');
    b.textContent=m; b.onclick=()=>{window.racingMkt[game]=m; renderRacing(game);}; mrow.appendChild(b);
  });
  stage.appendChild(mrow);

  let events=[]; try{ const r=await API.get(`/events?game=${game}`); events=(await r.json()).slice(0,3);}catch{}
  if(!events.length){ stage.innerHTML+='<div class="muted">No events.</div>'; return; }

  for(const ev of events){
    const byType = await getMarkets(ev.id);
    const main=byType['MAIN_WIN'];

    const box=document.createElement('div'); box.className='panel'; box.style.background='#0e172f'; box.style.borderColor='#26385f';

    if(main){
      const lanes=document.createElement('div'); lanes.className='track';
      const count = game==='horse' ? 8 : Math.min(12, main.selections.length);
      for(let i=0;i<Math.min(count, main.selections.length);i++){
        const r=document.createElement('div'); r.className='runner'; r.style.top=(14 + i*22)+'px';
        r.animate([{transform:'translateX(0)'},{transform:'translateX(8px)'},{transform:'translateX(0)'}],
          {duration:2200+Math.random()*1200,iterations:Infinity});
        r.title=main.selections[i].name; lanes.appendChild(r);
      }
      box.appendChild(lanes);
    }

    function addGrid(title, m, cols){
      if(!m) return;
      const lbl=document.createElement('div'); lbl.className='muted'; lbl.textContent=title; box.appendChild(lbl);
      const row=document.createElement('div'); row.style.display='grid'; row.style.gridTemplateColumns=`repeat(${cols},1fr)`; row.style.gap='8px';
      m.selections.forEach(s=>{
        const b=document.createElement('div'); b.className='oddbtn'; b.textContent=m.odds[s.id];
        b.title=s.name.replace(/DOG|HORSE/gi,'').trim();
        b.onclick=()=>choose(ev,m,s); row.appendChild(b);
      });
      box.appendChild(row);
    }

    const want=window.racingMkt[game];
    if(want==='MAIN') addGrid(`${game.toUpperCase()} — WIN`, byType['MAIN_WIN'], 3);
    if(want==='FORECAST') addGrid('FORECAST (Exacta)', byType['FORECAST'], 3);
    if(want==='QUINELLA') addGrid('QUINELLA', byType['QUINELLA'], 3);
    if(want==='TRICAST') addGrid('TRICAST', byType['TRICAST'], 3);

    el('stage').appendChild(box);
  }
}

/* ---------- Colors & Numbers ---------- */
async function renderColorsNumbers(){
  el('leagueChips').style.display='none';
  const stage=el('stage'); stage.innerHTML='';

  let evC,marketsC,mC; try{ evC=(await (await API.get(`/events?game=colors`)).json())[0]; marketsC=await (await API.get(`/markets/${evC.id}`)).json(); mC=marketsC.find(x=>x.type==='MAIN_COLOR'); }catch{}
  const boxC=document.createElement('div'); boxC.className='panel'; boxC.style.background='#0e172f'; boxC.style.borderColor='#26385f';
  boxC.innerHTML='<div class="title">Colors</div>';
  const gridC=document.createElement('div'); gridC.className='balls colors';
  mC?.selections?.forEach(s=>{
    const w=document.createElement('div'); w.className='ballwrap';
    const b=document.createElement('div'); b.className=`ball ${s.id}`; b.textContent=s.id[0]; b.onclick=()=>choose(evC,mC,s);
    const od=document.createElement('div'); od.className='oddlab'; od.textContent=mC.odds[s.id];
    w.appendChild(b); w.appendChild(od); gridC.appendChild(w);
  });
  boxC.appendChild(gridC); stage.appendChild(boxC);

  let evN,marketsN,mN; try{ evN=(await (await API.get(`/events?game=lotto49`)).json())[0]; marketsN=await (await API.get(`/markets/${evN.id}`)).json(); mN=marketsN.find(x=>x.type==='PICK1'); }catch{}
  const colors=['RED','BLUE','GREEN','YELLOW','PURPLE','BLACK'];
  const boxN=document.createElement('div'); boxN.className='panel'; boxN.style.background='#0e172f'; boxN.style.borderColor='#26385f';
  boxN.innerHTML='<div class="title">Numbers 1–49</div>';
  const gridN=document.createElement('div'); gridN.className='balls numbers';
  mN?.selections?.forEach(s=>{
    const idx=(Number(s.id)-1)%colors.length;
    const w=document.createElement('div'); w.className='ballwrap';
    const b=document.createElement('div'); b.className=`ball ${colors[idx]}`; b.textContent=s.id; b.onclick=()=>choose(evN,mN,s);
    const od=document.createElement('div'); od.className='oddlab'; od.textContent=mN.odds[s.id];
    w.appendChild(b); w.appendChild(od); gridN.appendChild(w);
  });
  boxN.appendChild(gridN); stage.appendChild(boxN);
}

/* ---------- Router & Boot ---------- */
function setCategory(tab){
  document.querySelectorAll('.segbtn[data-tab]').forEach(b=>{
    const active = b.dataset.tab===tab; b.setAttribute('aria-pressed', active? 'true':'false');
  });
  CURRENT_TAB = tab; CURRENT=null; showSlip(false);
  setTiming();
  if (tab==='football'){ CURRENT_MARKET='MAIN'; renderFootball(); }
  if (tab==='dogs'){ renderRacing('dog'); }
  if (tab==='horses'){ renderRacing('horse'); }
  if (tab==='colors'){ renderColorsNumbers(); }
}
document.querySelectorAll('.segbtn[data-tab]').forEach(b=>{
  b.addEventListener('click', ()=> setCategory(b.dataset.tab));
});
function refreshByTab(forceReloadEvents=false, timed=false){
  if (CURRENT_TAB==='football') { if(forceReloadEvents||timed) { CACHE.loadedAt.football=0; } renderFootball(); }
  if (CURRENT_TAB==='dogs') renderRacing('dog');
  if (CURRENT_TAB==='horses') renderRacing('horse');
  if (CURRENT_TAB==='colors') renderColorsNumbers();
}

async function boot(){
  await refreshCashier();
  setTiming();
  setCategory('football'); // default; ensures MAIN market
  await loadTickets();
  setInterval(async ()=>{ await refreshCashier(); refreshByTab(false,true); await loadTickets(); }, 9000);
}
boot();
</script>
</body>
</html>
