<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Cashier</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700;800&display=swap">
  <style>
    :root{
      --bg:#070b16; --panel:#0b1428; --line:#1c2741; --text:#e6edf3; --muted:#9aa4b2;
      --accent:#22c55e; --danger:#ef4444; --warn:#f59e0b; --chip:#0f1a33; --ink:#0e172f;
      --dial-bg:#0d1428; --dial-fg:#22c55e; --dial-live:#ef4444; --glow:#7dd3fc;
      --maxw:100%;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;font-family:"Space Grotesk", Inter, system-ui, Arial, sans-serif;
      background:
        radial-gradient(140% 120% at 50% -20%, #122445 0 45%, #0b1324 46% 100%),
        linear-gradient(180deg, #0a0f1f 0, #0a0f1f 100%);
      color:var(--text)
    }
    a{color:#7dd3fc;text-decoration:none}

    /* Header */
    header{
      position:sticky; top:0; z-index:60; display:flex; align-items:center; gap:12px;
      padding:10px 16px; border-bottom:1px solid var(--line);
      background:rgba(8,12,24,.85); backdrop-filter:blur(6px)
    }
    .brand{font-weight:800;letter-spacing:.3px;font-size:18px;display:flex;align-items:center;gap:8px}
    .grow{flex:1}
    .pill{
      padding:8px 12px;border:1px solid #23365c;border-radius:12px;background:#0d1428;
      box-shadow:inset 0 1px 0 #ffffff0f, 0 2px 10px #00000040;font-size:12px
    }
    .pill.badge{display:inline-flex;gap:8px;align-items:center}
    .pill.solid{background:#0e172f;border-color:#2a3e6a}
    .clock{min-width:220px;text-align:right}

    /* Layout */
    .container{max-width:var(--maxw);margin:0 auto;padding:10px;display:grid;grid-template-columns:minmax(0,2.1fr) minmax(0,.9fr);gap:14px}
    @media (max-width:1100px){ .container{grid-template-columns:1fr} }
    .panel{background:var(--panel);border:1px solid var(--line);border-radius:18px;padding:12px}
    .title{font-weight:800;margin-bottom:8px}
    .muted{color:var(--muted);font-size:12px}
    .divider{height:1px;background:var(--line);margin:10px 0}

    /* Segmented cards (Games / Leagues / Weeks) */
    .seg{display:inline-flex;border-radius:14px;overflow:hidden;border:1px solid #2b3c62;background:#0e172f}
    .seg .segbtn{padding:8px 14px;font-weight:800;cursor:pointer;border-right:1px solid #2b3c62;user-select:none}
    .seg .segbtn:last-child{border-right:none}
    .seg .segbtn[aria-pressed="true"]{background:#12305b;outline:2px solid var(--accent)}

    /* Dial */
    .roundbar{display:flex;align-items:center;gap:10px}
    .dial{
      --p:0deg; --col:var(--dial-fg);
      width:40px;height:40px;border-radius:50%;
      background:
        conic-gradient(var(--col) var(--p), #0000 var(--p)),
        radial-gradient(circle 18px, #0000 17px, var(--dial-bg) 18px);
      border:1px solid var(--line)
    }
    .dial.live{ --col: var(--dial-live); animation:pulse 1.1s infinite alternate }
    @keyframes pulse{from{filter:brightness(1)}to{filter:brightness(1.25)}}
    .roundtxt{display:flex;flex-direction:column;line-height:1}
    .roundtxt b{font-size:12px}
    .roundtxt small{font-size:11px;color:var(--muted)}

    /* Schedule chips */
    .sched{display:flex;gap:8px;flex-wrap:wrap}
    .slot{display:flex;flex-direction:column;gap:4px;align-items:center;justify-content:center;min-width:86px;padding:8px;border:1px solid var(--line);border-radius:12px;background:#0d1428;cursor:pointer}
    .slot.active{outline:2px solid var(--accent)}
    .slot small{font-size:11px;color:var(--muted)}

    /* Markets strip */
    .markets{display:flex;gap:6px;flex-wrap:wrap;margin:8px 0 10px}
    .mkt{padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#0f1933;cursor:pointer;font-size:12px;font-weight:800}
    .mkt.active{outline:2px solid var(--accent)}

    /* Fixture rows */
    .fxrow{display:grid;grid-template-columns:30px 1fr auto;gap:10px;align-items:center;padding:8px;border:1px solid var(--line);border-radius:12px;background:#0e172f;margin-bottom:8px}
    .idx{display:flex;align-items:center;justify-content:center;width:28px;height:28px;border-radius:8px;background:#0b1324;border:1px solid var(--line);font-weight:800;font-size:12px}
    .fxteams{display:flex;align-items:center;gap:10px;font-weight:800}
    .logo-lg{width:56px;height:56px;border-radius:50%;background:#0b1324;border:1px solid #1c2741;object-fit:cover}
    .ph{width:56px;height:56px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;background:#10203c;color:#9fb3d4;font-weight:800;font-size:18px}
    .vs{opacity:.7;margin:0 6px}
    .oddsbar{display:flex;gap:8px;flex-wrap:wrap}
    .oddbtn{
      min-width:66px;padding:8px 10px;border-radius:10px;border:1px solid #3a455f;background:#0c1326;color:#fff;font-weight:800;text-align:center;cursor:pointer
    }
    .oddbtn:hover{filter:brightness(1.12)}
    .odds-lab{display:block;font-size:10px;opacity:.75;margin-top:2px}

    /* Balls */
    .balls{display:grid;gap:10px}
    .balls.colors{grid-template-columns:repeat(6,1fr)}
    .balls.numbers{grid-template-columns:repeat(7,1fr)}
    .ballwrap{display:flex;flex-direction:column;align-items:center;gap:6px}
    .ball{height:52px;width:52px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:800;color:#fff;border:2px solid #00000040;position:relative;box-shadow:inset -6px -8px 14px #00000055, inset 6px 6px 14px #ffffff1a, 0 2px 6px #00000066;cursor:pointer;font-size:18px}
    .ball::after{content:""; position:absolute; top:7px; left:10px; width:18px; height:10px; background:radial-gradient(circle at 10px 5px, #ffffffcc, #ffffff22 60%, #ffffff00 100%); border-radius:50%; filter:blur(0.3px)}
    .oddlab{font-size:12px;background:#0c1326;border:1px solid #2c3c60;padding:3px 8px;border-radius:999px}
    .RED{background:#ef4444}.BLUE{background:#3b82f6}.GREEN{background:#10b981}.YELLOW{background:#f59e0b}.PURPLE{background:#a855f7}.BLACK{background:#111827;color:#e5e7eb;border-color:#000}

    /* Right panel */
    .betslip{display:grid;gap:8px}
    input,button,select{font-family:inherit}
    input[type="number"], input[type="text"]{width:100%;padding:12px;border-radius:12px;border:1px solid var(--line);background:#0d1428;color:#fff}
    .btn{padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#0d1428;color:#fff;cursor:pointer;font-weight:800}
    .btn.primary{background:#0f2b1b;border-color:#1b4d28}
    .ticket{position:relative;padding:8px;border:1px dashed var(--line);border-radius:12px;margin-bottom:6px;background:#0c162c}
    .wm{position:absolute;inset:8px;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:28px;color:#fff1;pointer-events:none;transform:rotate(-18deg)}
    .wm.OPEN{color:#7dd3fc22}.wm.WON{color:#22c55e22}.wm.LOST{color:#ef444422}

    .ico{width:16px;height:16px;display:inline-block;vertical-align:middle}
    .toaster{position:fixed;top:16px;right:16px;display:flex;flex-direction:column;gap:10px;z-index:80}
    .toast{background:#0f1933;border:1px solid #2a3b63;color:#e6edf3;padding:10px 12px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.35);opacity:0;transform:translateY(-6px);transition:opacity .18s ease, transform .18s ease}
    .toast.show{opacity:1;transform:none}
    .toast.success{border-color:#1d3f2a;background:#0e2217}
    .toast.error{border-color:#4d1a1a;background:#2a0e0e}
  </style>
</head>
<body>
<header>
  <div class="brand">
    <svg class="ico" viewBox="0 0 24 24"><path fill="#7dd3fc" d="M12 2a10 10 0 1 0 0 20a10 10 0 0 0 0-20Zm0 2a8 8 0 0 1 7.7 6H12V4Z"/></svg>
    Cashier
  </div>
  <div class="grow"></div>
  <a href="/virtuals-live" class="pill solid badge" title="TV / Live draws">
    <svg class="ico" viewBox="0 0 24 24"><path fill="#a7f3d0" d="M3 6h18v11H3zM7 20h10v2H7z"/></svg>
    <b>TV</b>
  </a>
  <div class="pill clock" id="clock">—</div>
  <a href="/aviator" class="pill solid badge">
    <img src="/static/img/aviator-icon.png" alt="Aviator" style="width:18px;height:18px;border-radius:50%"/>
    <b>Aviator</b>
  </a>
</header>

<div class="container">
  <div class="panel">
    <!-- Games segmented card -->
    <div class="seg" role="tablist" aria-label="Game categories" id="gameSeg">
      <button class="segbtn" data-tab="football" aria-pressed="true">Football</button>
      <button class="segbtn" data-tab="dogs" aria-pressed="false">Dogs</button>
      <button class="segbtn" data-tab="horses" aria-pressed="false">Horses</button>
      <button class="segbtn" data-tab="colors" aria-pressed="false">Colors & Numbers</button>
    </div>

    <!-- Dial + schedule (weeks/slots) -->
    <div class="row" style="justify-content:space-between;align-items:center;margin:10px 0;display:flex">
      <div style="display:flex;gap:12px;align-items:center">
        <div class="roundbar">
          <div id="dial" class="dial" title="Next switch"></div>
          <div class="roundtxt">
            <b id="liveText">LIVE</b>
            <small id="roundLabel">—</small>
          </div>
        </div>
        <div class="pill" id="roundTimer">Next in —</div>
      </div>
      <div class="sched" id="schedule"></div>
    </div>

    <!-- Leagues segmented card (football only) -->
    <div id="leagueSegWrap" style="margin-bottom:8px;display:none">
      <div class="seg" id="leagueSeg" role="tablist" aria-label="Leagues"></div>
    </div>

    <!-- Markets -->
    <div class="markets" id="marketTabs"></div>

    <!-- Stage -->
    <div id="stage"></div>
  </div>

  <div class="panel">
    <div class="title">Controls</div>
    <div class="row" style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
      <div class="pill badge" id="cashierIdShow">
        <svg class="ico" viewBox="0 0 24 24"><path fill="#a7f3d0" d="M4 4h16v4H4zM4 10h10v10H4zM16 10h4v6h-4z"/></svg>
        Cashier: <b id="cashierId">shop-1</b>
      </div>
      <div class="pill">Balance: <b id="cashBal">0 KES</b></div>
      <input id="cashierIdInput" value="shop-1" placeholder="shop-1" style="max-width:160px">
      <button class="btn" onclick="applyCashier()">Set</button>
    </div>

    <div class="divider"></div>

    <!-- History moved up (right after balance) -->
    <div>
      <div class="row" style="justify-content:space-between;display:flex;align-items:center">
        <div class="title">History</div>
        <input id="historySearch" placeholder="Scan / type Ref or Code…" style="max-width:220px"/>
      </div>
      <div id="tickets" class="list"></div>
    </div>

    <div class="divider"></div>

    <div>
      <div class="title">Aviator Players — Wallets</div>
      <div class="row" style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <select id="aviPlayer">
          <option value="pA">Player A</option>
          <option value="pB">Player B</option>
          <option value="pC">Player C</option>
        </select>
        <input id="aviAmount" type="number" value="1000" min="1" style="max-width:120px" />
        <button class="btn" onclick="aviLoad()">Load</button>
        <button class="btn" onclick="aviView()">View</button>
        <input id="aviClearAmount" type="number" min="1" placeholder="Cash-out (optional)" style="max-width:150px"/>
        <button class="btn" onclick="aviClear()">Pay & Clear</button>
        <div class="pill" id="aviBal">Bal: —</div>
      </div>
    </div>

    <div class="divider"></div>

    <div>
      <div class="title">Betslip</div>
      <div class="betslip" id="betslip" style="display:none">
        <div class="muted" id="currentSel">No selection</div>
        <input id="stake" type="number" min="20" max="1000" value="100" placeholder="Stake (KES)"/>
        <div class="row" style="display:flex;gap:8px;flex-wrap:wrap">
          <div class="pill">Odds: <b id="odds">—</b></div>
          <div class="pill">Potential: <b id="payout">—</b></div>
        </div>
        <button id="placeBtn" class="btn primary" onclick="placeBet()">Place Bet</button>
        <div class="muted">Min 20, Max 1000, Max Payout 20,000</div>
      </div>
      <div id="noSlip" class="muted">Click a market to build a betslip.</div>
    </div>
  </div>
</div>

<div id="toaster" class="toaster"></div>

<script>
/* Toasts */
const toaster=document.getElementById('toaster');
function notify(msg,type='info',ms=2200){
  const t=document.createElement('div');
  t.className='toast'+(type==='success'?' success':type==='error'?' error':'');
  t.textContent=msg; toaster.appendChild(t);
  requestAnimationFrame(()=>t.classList.add('show'));
  setTimeout(()=>{ t.classList.remove('show'); setTimeout(()=>t.remove(),180); }, ms);
}

/* API helper */
const ORIGIN = location.origin;
const PORT4000 = ORIGIN.replace(/^(https?:\/\/[^\/:]+)(?::\d+)?$/,'$1:4000');
const API = {
  async get(path){
    try{ const r = await fetch(`${ORIGIN}${path}`,{cache:'no-store'}); if(r.ok) return r; }catch{}
    return fetch(`${PORT4000}${path}`,{cache:'no-store'});
  },
  async post(path, body){
    const opts={method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body||{})};
    try{ const r = await fetch(`${ORIGIN}${path}`,opts); if(r.ok) return r; }catch{}
    return fetch(`${PORT4000}${path}`,opts);
  }
};
const KES = x=> new Intl.NumberFormat('en-KE',{style:'currency',currency:'KES'}).format(Number(x||0));
const el = id=>document.getElementById(id);

/* Clock */
let healthSkew=0;
async function syncClock(){
  try{ const r=await API.get('/health'); const j=await r.json(); healthSkew=j.ts-Date.now(); }catch{ healthSkew=0; }
}
setInterval(()=>{ const d=new Date(Date.now()+healthSkew); el('clock').textContent=d.toLocaleString(); }, 500);
syncClock();

/* Cashier */
let CASHIER_ID = 'shop-1';
async function refreshCashier(){
  try{ const r=await API.get(`/cashier/${CASHIER_ID}/balance`); const j=await r.json();
    el('cashBal').textContent = KES(j.balance||0);
    el('cashierId').textContent = CASHIER_ID;
  }catch{}
}
function applyCashier(){ CASHIER_ID = (el('cashierIdInput').value||'shop-1').trim(); refreshCashier(); }

/* Aviator wallets */
async function aviView(){ const pid=el('aviPlayer').value; try{ const r=await API.get(`/aviator/wallet/${pid}`); const j=await r.json(); el('aviBal').textContent=`Bal: ${KES(j.balance||0)}`; }catch{ el('aviBal').textContent='Bal: —'; } }
async function aviLoad(){
  const pid=el('aviPlayer').value; const amt=Number(el('aviAmount').value||0)||0;
  if (!amt) return notify('Enter amount to load.','error');
  try{ const r=await API.post(`/aviator/wallet/load`,{playerId:pid, amount:amt}); const j=await r.json(); el('aviBal').textContent=`Bal: ${KES(j.balance||0)}`; notify('Wallet updated','success'); }catch{ notify('Wallet update failed','error'); }
}
async function aviClear(){
  const pid=el('aviPlayer').value; const req=Number(el('aviClearAmount').value||0)||0;
  try{
    const r=await API.get(`/aviator/wallet/${pid}`); const j=await r.json(); let bal=Number(j.balance||0);
    if (bal<=0) return notify('Nothing to clear','info');
    const pay = req>0 ? Math.min(req, bal) : bal;
    await API.post(`/aviator/wallet/load`,{playerId:pid, amount:-pay});
    const rem = bal - pay;
    el('aviBal').textContent=`Bal: ${KES(rem)}`;
    el('aviClearAmount').value='';
    notify(rem>0?`Paid ${KES(pay)} — Remaining ${KES(rem)}`:'Paid & cleared','success');
  }catch{ notify('Clear failed','error'); }
}

/* Logos */
function logoHTML(folder, abbr, big=true){
  const code = (abbr||'???').toUpperCase();
  const base = `/static/logos/${folder}/${code}`;
  const id = `lg_${folder}_${code}_${Math.random().toString(36).slice(2,7)}`;
  const cls = big ? 'logo-lg' : 'logo';
  const img = `<img id="${id}" class="${cls}" src="${base}.png" alt="${code}">`;
  const ph  = `<span class="ph ${big?'':'ph-sm'}" id="${id}_ph" style="display:none">${code}</span>`;
  setTimeout(()=>{
    const tag = document.getElementById(id), phTag=document.getElementById(id+'_ph');
    if(!tag) return;
    tag.onerror = ()=>{
      if (tag.src.endsWith('.png')) tag.src = `${base}.jpg`;
      else if (tag.src.endsWith('.jpg')) tag.src = `${base}.svg`;
      else { tag.style.display='none'; if (phTag) phTag.style.display='inline-flex'; }
    };
  },0);
  return img+ph;
}

/* State */
const dial = el('dial'); const roundTimer=el('roundTimer'); const roundLabel=el('roundLabel'); const scheduleBox=el('schedule');
let CURRENT_TAB='football', CURRENT=null;
const LEAGUES = ['EPL','LALIGA','UCL']; let leagueIdx=0; let CURRENT_LEAGUE=LEAGUES[leagueIdx];
let CURRENT_MARKET='MAIN';
let nextBoundaryTs=null, boundarySpanMs=0, selectedSlot=0, weekPointer=0;

/* Helpers */
function ceilToStep(ms, min){ const step=min*60*1000; return Math.ceil(ms/step)*step; }
function buildSchedule(stepMin){
  scheduleBox.innerHTML='';
  const base = nextBoundaryTs - boundarySpanMs;
  for(let i=0;i<4;i++){
    const ts = base + i*boundarySpanMs;
    const label = new Date(ts).toLocaleTimeString();
    const slot=document.createElement('div'); slot.className='slot'; if(i===selectedSlot) slot.classList.add('active');
    slot.innerHTML = `<b>${label}</b><small>${stepMin} min</small>`;
    slot.onclick=()=>{ selectedSlot=i; document.querySelectorAll('.slot').forEach(x=>x.classList.remove('active')); slot.classList.add('active'); refreshByTab(true); };
    scheduleBox.appendChild(slot);
  }
}
function setTiming(){
  const now = Date.now()+healthSkew;
  if (CURRENT_TAB==='football'){ nextBoundaryTs=ceilToStep(now,7); boundarySpanMs=7*60*1000; roundLabel.textContent='FOOTBALL • Weeks'; }
  else { nextBoundaryTs=ceilToStep(now,3); boundarySpanMs=3*60*1000; roundLabel.textContent='NEXT START • '+new Date(nextBoundaryTs).toLocaleTimeString(); }
  buildSchedule(boundarySpanMs/60000);
}
function tickDial(){
  const now = Date.now()+healthSkew;
  const remain = Math.max(0, (nextBoundaryTs||now) - now);
  const ratio = boundarySpanMs ? 1 - remain / boundarySpanMs : 0;
  const deg = Math.max(0, Math.min(360, ratio*360));
  dial.style.setProperty('--p', deg+'deg');
  const ss = Math.ceil(remain/1000), mm=Math.floor(ss/60), s=ss%60;
  roundTimer.textContent = `Next in ${String(mm).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
  if (remain<=0){
    nextBoundaryTs += boundarySpanMs;
    if (CURRENT_TAB==='football'){ weekPointer++; }
    buildSchedule(boundarySpanMs/60000);
    refreshByTab(false,true);
  }
}
setInterval(tickDial, 500);

/* Betslip */
function showSlip(b){ el('betslip').style.display=b?'block':'none'; el('noSlip').style.display=b?'none':'block'; }
function validateStake(raw){
  const stake=Number(raw); if(!Number.isFinite(stake)||stake<=0){ notify('Enter a valid stake.','error');return null;}
  if(stake<20){notify('Minimum stake is 20 KES.','error');return null;}
  if(stake>1000){notify('Maximum stake is 1000 KES.','error');return null;}
  return stake;
}
function updatePotential(){
  if(!CURRENT){ el('payout').textContent='—'; return; }
  const stake=Number(el('stake').value||0), odds=Number(CURRENT.market.odds[CURRENT.selection.id]);
  el('payout').textContent = stake? KES(Math.min(stake*odds,20000)) : '—';
}
function labelForSelection(selId, name){
  // compact labels often used in virtuals
  const id = (selId||'').toUpperCase();
  if (['1','X','2'].includes(id)) return id;
  if (/OVER/i.test(name)) return name.replace(/^\s*/,'');
  if (/UNDER/i.test(name)) return name.replace(/^\s*/,'');
  return name;
}
function choose(ev,m,sel){
  CURRENT={event:ev,market:m,selection:sel};
  el('currentSel').textContent=`${(ev.game||'').toUpperCase()} — ${m.type} — ${sel.name}`;
  el('odds').textContent=m.odds[sel.id];
  updatePotential(); showSlip(true);
}
el('stake').addEventListener('input',updatePotential);
async function placeBet(){
  if(!CURRENT) return notify('Pick a selection first','error');
  const stake=validateStake(el('stake').value); if(stake==null) return;
  const payload={eventId:CURRENT.event.id,marketId:CURRENT.market.id,selectionId:CURRENT.selection.id,stake,cashierId:CASHIER_ID,slot:selectedSlot};
  const btn=el('placeBtn'); btn.disabled=true; btn.textContent='Placing…';
  try{
    const r=await API.post(`/bets`,payload); const j=await r.json();
    if(!j || j.ok===false) { notify((j&&j.error)||'Bet failed','error'); return; }
    await refreshCashier(); await loadTickets(); notify('Bet placed','success');
    window.open(`/receipt/${j.bet.id}`,'_blank','width=380,height=560');
    showSlip(false);
  }catch{ notify('Bet failed','error'); }
  finally{ btn.disabled=false; btn.textContent='Place Bet'; }
}

/* History */
async function loadTickets(){
  const r = await API.get(`/bets?cashierId=${encodeURIComponent(CASHIER_ID)}`); const list = await r.json();
  const box = el('tickets'); box.innerHTML='';
  (list||[]).slice(0,20).forEach(t=>{
    const d=document.createElement('div'); d.className='ticket';
    const ref=t.ref||`T-${(t.id||'').slice(0,8).toUpperCase()}`;
    d.innerHTML=`<div class="wm ${t.status||'OPEN'}">${t.status||'OPEN'}</div>
                 <div><b>${ref}</b> — ${t.game?.toUpperCase()||''} — ${t.status||'OPEN'}</div>
                 <div class="muted">${KES(t.stake)} • ${t.odds} → ${t.payout?KES(t.payout):'—'}</div>`;
    box.appendChild(d);
  });
  const input = el('historySearch');
  input.oninput=()=>{
    const q=input.value.trim().toUpperCase(); if(!q) return loadTickets();
    const filtered=(list||[]).filter(t=> (t.ref||'').toUpperCase().includes(q) || (t.id||'').toUpperCase().includes(q) );
    const box2=el('tickets'); box2.innerHTML='';
    filtered.slice(0,20).forEach(t=>{
      const d=document.createElement('div'); d.className='ticket';
      const ref=t.ref||`T-${(t.id||'').slice(0,8).toUpperCase()}`;
      d.innerHTML=`<div class="wm ${t.status||'OPEN'}">${t.status||'OPEN'}</div>
                   <div><b>${ref}</b> — ${t.game?.toUpperCase()||''} — ${t.status||'OPEN'}</div>
                   <div class="muted">${KES(t.stake)} • ${t.odds} → ${t.payout?KES(t.payout):'—'}</div>`;
      box2.appendChild(d);
    });
  };
}

/* Cache */
const CACHE = { events:{}, markets:{}, loadedAt:{} };
async function getEvents(game){
  const now=Date.now(); if(CACHE.events[game] && now-(CACHE.loadedAt[game]||0)<60_000) return CACHE.events[game];
  try{ const r=await API.get(`/events?game=${game}`); const arr=await r.json(); CACHE.events[game]=arr; CACHE.loadedAt[game]=now; return arr; }catch{ return CACHE.events[game]||[]; }
}
async function getMarkets(eventId){
  if(!CACHE.markets[eventId]){
    try{ const r=await API.get(`/markets/${eventId}`); const arr=await r.json(); const map={}; (arr||[]).forEach(m=>map[m.type]=m); CACHE.markets[eventId]=map; }
    catch{ CACHE.markets[eventId]={}; }
  }
  return CACHE.markets[eventId];
}
function pickMarket(byType, candidates){
  const keys=Object.keys(byType||{});
  for(const c of candidates){ if(typeof c==='string'){ if(byType[c]) return byType[c]; } else { const k=keys.find(k=>c.test(k)); if(k) return byType[k]; } }
  return null;
}

/* Markets + labels */
const MARKET_TABS = ['MAIN','OU05','OU15','OU25','OU35','BTTS','H15','A15','DC','DNB','CMB15','CMB25'];
const MLAB={MAIN:'MAIN',OU05:'OU 0.5',OU15:'OU 1.5',OU25:'OU 2.5',OU35:'OU 3.5',BTTS:'BTTS',H15:'HOME 1.5',A15:'AWAY 1.5',DC:'DOUBLE CHANCE',DNB:'DRAW NO BET',CMB15:'1X2+OU1.5',CMB25:'1X2+OU2.5'};

function renderMarketStrip(){
  const box=el('marketTabs'); box.innerHTML='';
  if(CURRENT_TAB!=='football'){ box.style.display='none'; return; }
  box.style.display='flex';
  MARKET_TABS.forEach(m=>{
    const b=document.createElement('div'); b.className='mkt'; if(m===CURRENT_MARKET) b.classList.add('active');
    b.textContent=MLAB[m]; b.onclick=()=>{ CURRENT_MARKET=m; renderFootball(); };
    box.appendChild(b);
  });
}

/* Football */
async function renderFootball(){
  // League segmented control
  const wrap=document.getElementById('leagueSegWrap'); const seg=document.getElementById('leagueSeg');
  wrap.style.display='block'; seg.innerHTML='';
  LEAGUES.forEach((L,i)=>{
    const b=document.createElement('button'); b.className='segbtn'; b.textContent=L;
    b.setAttribute('aria-pressed', i===leagueIdx?'true':'false');
    b.onclick=()=>{ leagueIdx=i; CURRENT_LEAGUE=LEAGUES[leagueIdx]; weekPointer=0; CURRENT_MARKET='MAIN'; renderFootball(); };
    seg.appendChild(b);
  });

  renderMarketStrip();

  const stage=el('stage'); stage.innerHTML='';
  let all = await getEvents('football');
  all=(all||[]).filter(e=>e.league===CURRENT_LEAGUE).sort((a,b)=>a.runsAt-b.runsAt);
  if(!all.length){ stage.innerHTML='<div class="muted">No fixtures.</div>'; return; }

  // split into blocks of 10 = "weeks"
  const blocks=[]; for(let i=0;i<all.length;i+=10) blocks.push(all.slice(i,i+10));
  // auto-advance league when weekPointer finishes the league
  if (weekPointer>=blocks.length){
    leagueIdx = (leagueIdx+1)%LEAGUES.length; CURRENT_LEAGUE=LEAGUES[leagueIdx]; weekPointer=0;
    notify(`Switching to ${CURRENT_LEAGUE}`, 'info', 1400);
    return renderFootball();
  }
  const blk = blocks[weekPointer];

  // show “Week n of N”
  roundLabel.textContent = `WEEK ${weekPointer+1} / ${blocks.length} • ${CURRENT_LEAGUE}`;

  // prefetch all markets for the block
  const mktList = await Promise.all(blk.map(ev=>getMarkets(ev.id)));

  let rowIndex=0;
  for(let i=0;i<blk.length;i++){
    const ev=blk[i], byType=mktList[i]||{};
    rowIndex++;
    const folder = CURRENT_LEAGUE.toLowerCase()==='epl'?'epl':(CURRENT_LEAGUE.toLowerCase()==='laliga'?'laliga':'ucl');
    const H=ev.home?.abbr||'H', A=ev.away?.abbr||'A';

    const mMain  = pickMarket(byType,[`MAIN_1X2_${CURRENT_LEAGUE}`,/MAIN.*1X2.*${CURRENT_LEAGUE}/i, /MAIN.*1X2/i]);
    const mOU05  = pickMarket(byType,[`OU_0_5_${CURRENT_LEAGUE}`,/OU[_-]?0[_-]?5.*${CURRENT_LEAGUE}/i, /OVER.*0\.?5/i]);
    const mOU15  = pickMarket(byType,[`OU_1_5_${CURRENT_LEAGUE}`,/OU[_-]?1[_-]?5.*${CURRENT_LEAGUE}/i, /OVER.*1\.?5/i]);
    const mOU25  = pickMarket(byType,[`OU_2_5_${CURRENT_LEAGUE}`,/OU[_-]?2[_-]?5.*${CURRENT_LEAGUE}/i, /OVER.*2\.?5/i]);
    const mOU35  = pickMarket(byType,[`OU_3_5_${CURRENT_LEAGUE}`,/OU[_-]?3[_-]?5.*${CURRENT_LEAGUE}/i, /OVER.*3\.?5/i]);
    const mBTTS  = pickMarket(byType,[`BTTS_${CURRENT_LEAGUE}`,/BTTS.*${CURRENT_LEAGUE}/i, /BTTS/i]);
    const mH15   = pickMarket(byType,[`HOME_OU_1_5_${CURRENT_LEAGUE}`,/HOME.*OU.*1[_-]?5.*${CURRENT_LEAGUE}/i]);
    const mA15   = pickMarket(byType,[`AWAY_OU_1_5_${CURRENT_LEAGUE}`,/AWAY.*OU.*1[_-]?5.*${CURRENT_LEAGUE}/i]);
    const mDC    = pickMarket(byType,[`DC_${CURRENT_LEAGUE}`,/DOUBLE[_-]?CHANCE.*${CURRENT_LEAGUE}/i, /DOUBLE[_ ]CHANCE/i]);
    const mDNB   = pickMarket(byType,[`DNB_${CURRENT_LEAGUE}`,/DRAW[_-]?NO[_-]?BET.*${CURRENT_LEAGUE}/i, /DNB/i]);
    const mCMB15 = pickMarket(byType,[`COMBO_1X2_OU_1_5_${CURRENT_LEAGUE}`,/COMBO.*1X2.*OU.*1[_-]?5.*${CURRENT_LEAGUE}/i]);
    const mCMB25 = pickMarket(byType,[`COMBO_1X2_OU_2_5_${CURRENT_LEAGUE}`,/COMBO.*1X2.*OU.*2[_-]?5.*${CURRENT_LEAGUE}/i]);
    const mMap={MAIN:mMain,OU05:mOU05,OU15:mOU15,OU25:mOU25,OU35:mOU35,BTTS:mBTTS,H15:mH15,A15:mA15,DC:mDC,DNB:mDNB,CMB15:mCMB15,CMB25:mCMB25};
    const mdef=mMap[CURRENT_MARKET] || mMain; if(!mdef) continue;

    const row=document.createElement('div'); row.className='fxrow';
    const idx=document.createElement('div'); idx.className='idx'; idx.textContent=String(rowIndex); row.appendChild(idx);
    const t=document.createElement('div'); t.className='fxteams';
    t.innerHTML = `${logoHTML(folder,H,true)} <span>${H}</span> <span class="vs">vs</span> ${logoHTML(folder,A,true)} <span>${A}</span>`;
    row.appendChild(t);

    const od=document.createElement('div'); od.className='oddsbar';
    (mdef.selections||[]).forEach(s=>{
      const b=document.createElement('div'); b.className='oddbtn';
      const lab=labelForSelection(s.id, s.name);
      b.innerHTML = `<div>${mdef.odds[s.id]}</div><small class="odds-lab">${lab}</small>`;
      b.title = s.name; b.onclick=()=>choose(ev,mdef,s);
      od.appendChild(b);
    });
    row.appendChild(od);
    stage.appendChild(row);
  }
}

/* Racing */
function renderRaceMarketStrip(game){
  const bar=el('marketTabs'); bar.innerHTML=''; bar.style.display='flex';
  if (!window.racingMkt) window.racingMkt={dog:'MAIN',horse:'MAIN'};
  ['MAIN','FORECAST','QUINELLA','TRICAST'].forEach(m=>{
    const b=document.createElement('div'); b.className='mkt'; if((window.racingMkt?.[game]||'MAIN')===m) b.classList.add('active');
    b.textContent=m; b.onclick=()=>{ window.racingMkt[game]=m; renderRacing(game); };
    bar.appendChild(b);
  });
}
async function renderRacing(game){
  document.getElementById('leagueSegWrap').style.display='none';
  renderRaceMarketStrip(game);
  const stage=el('stage'); stage.innerHTML='';

  let events=[]; try{ const r=await API.get(`/events?game=${game}`); events=(await r.json()).slice(0,3);}catch{}
  if(!events.length){ stage.innerHTML='<div class="muted">No events.</div>'; return; }

  for(const ev of events){
    const byType = await getMarkets(ev.id);
    const want = (window.racingMkt[game]||'MAIN');
    const mWIN   = pickMarket(byType, [/MAIN.*WIN/i, 'MAIN_WIN', `${game.toUpperCase()}_MAIN_WIN`]);
    const mFCAST = pickMarket(byType, [/FORECAST/i,'FORECAST']);
    const mQUIN  = pickMarket(byType, [/QUINELLA/i,'QUINELLA']);
    const mTRI   = pickMarket(byType, [/TRICAST/i,'TRICAST']);
    const useMap={MAIN:mWIN, FORECAST:mFCAST, QUINELLA:mQUIN, TRICAST:mTRI};
    const mdef=useMap[want]||mWIN;

    const row=document.createElement('div'); row.className='fxrow';
    const idx=document.createElement('div'); idx.className='idx'; idx.textContent='•'; row.appendChild(idx);
    const t=document.createElement('div'); t.className='fxteams'; t.textContent=(ev.name||game.toUpperCase())+' — '+new Date((ev.runsAt||Date.now())+healthSkew).toLocaleTimeString(); row.appendChild(t);
    const od=document.createElement('div'); od.className='oddsbar';
    (mdef?.selections||[]).slice(0,10).forEach((s)=>{
      const b=document.createElement('div'); b.className='oddbtn';
      b.innerHTML = `<div>${mdef.odds[s.id]}</div><small class="odds-lab">${s.name.replace(/DOG|HORSE/gi,'').trim()}</small>`;
      b.onclick=()=>choose(ev,mdef,s); od.appendChild(b);
    });
    row.appendChild(od); stage.appendChild(row);
  }
}

/* Colors & Numbers (with "Number of Colors") */
async function renderColorsNumbers(){
  document.getElementById('leagueSegWrap').style.display='none';
  el('marketTabs').style.display='none';
  const stage=el('stage'); stage.innerHTML='';

  // COLORS – main colors
  let evC, byC, mColor, mCount;
  try{
    evC=(await (await API.get(`/events?game=colors`)).json())[0];
    byC = await getMarkets(evC.id);
    mColor = pickMarket(byC, ['MAIN_COLOR', /MAIN[_-]?COLOR/i]);
    mCount = pickMarket(byC, [/COLOR[_-]?COUNT/i, 'COLOR_COUNT','COLORS_COUNT']);
  }catch{}

  if(mColor){
    const boxC=document.createElement('div'); boxC.className='panel';
    boxC.innerHTML='<div class="title">Colors</div>';
    const gridC=document.createElement('div'); gridC.className='balls colors';
    (mColor.selections||[]).forEach(s=>{
      const w=document.createElement('div'); w.className='ballwrap';
      const b=document.createElement('div'); b.className=`ball ${s.id}`; b.textContent=s.id[0];
      b.onclick=()=>choose(evC,mColor,s);
      const od=document.createElement('div'); od.className='oddlab'; od.textContent=mColor.odds[s.id];
      w.appendChild(b); w.appendChild(od); gridC.appendChild(w);
    });
    boxC.appendChild(gridC); stage.appendChild(boxC);
  }

  // NEW: Number of Colors (if backend provides it)
  if(mCount){
    const boxCC=document.createElement('div'); boxCC.className='panel';
    boxCC.innerHTML='<div class="title">Number of Colors</div>';
    const row=document.createElement('div'); row.style.display='flex'; row.style.flexWrap='wrap'; row.style.gap='8px';
    (mCount.selections||[]).forEach(s=>{
      const b=document.createElement('div'); b.className='oddbtn';
      b.innerHTML = `<div>${mCount.odds[s.id]}</div><small class="odds-lab">${s.name}</small>`;
      b.onclick=()=>choose(evC,mCount,s); row.appendChild(b);
    });
    boxCC.appendChild(row); stage.appendChild(boxCC);
  }

  // NUMBERS 1–49
  let evN, byN, mN;
  try{
    evN=(await (await API.get(`/events?game=lotto49`)).json())[0];
    byN=await getMarkets(evN.id);
    mN = pickMarket(byN, [/PICK\s*1/i,'PICK1']);
  }catch{}
  if(mN){
    const colors=['RED','BLUE','GREEN','YELLOW','PURPLE','BLACK'];
    const boxN=document.createElement('div'); boxN.className='panel';
    boxN.innerHTML='<div class="title">Numbers 1–49</div>';
    const gridN=document.createElement('div'); gridN.className='balls numbers';
    (mN.selections||[]).forEach(s=>{
      const idx=(Number(s.id)-1)%colors.length;
      const w=document.createElement('div'); w.className='ballwrap';
      const b=document.createElement('div'); b.className=`ball ${colors[idx]}`; b.textContent=s.id; b.onclick=()=>choose(evN,mN,s);
      const od=document.createElement('div'); od.className='oddlab'; od.textContent=mN.odds[s.id];
      w.appendChild(b); w.appendChild(od); gridN.appendChild(w);
    });
    boxN.appendChild(gridN); stage.appendChild(boxN);
  }
}

/* Router */
function setCategory(tab){
  document.querySelectorAll('#gameSeg .segbtn').forEach(b=>{
    const active = b.dataset.tab===tab; b.setAttribute('aria-pressed', active? 'true':'false');
  });
  CURRENT_TAB = tab; CURRENT=null; showSlip(false);
  setTiming();
  if (tab==='football'){ CURRENT_MARKET='MAIN'; renderFootball(); }
  if (tab==='dogs'){ renderRacing('dog'); }
  if (tab==='horses'){ renderRacing('horse'); }
  if (tab==='colors'){ renderColorsNumbers(); }
}
document.querySelectorAll('#gameSeg .segbtn').forEach(b=> b.addEventListener('click', ()=> setCategory(b.dataset.tab)));

function refreshByTab(forceReloadEvents=false, timed=false){
  if (CURRENT_TAB==='football') { if(forceReloadEvents||timed) { CACHE.loadedAt.football=0; } renderFootball(); }
  if (CURRENT_TAB==='dogs') renderRacing('dog');
  if (CURRENT_TAB==='horses') renderRacing('horse');
  if (CURRENT_TAB==='colors') renderColorsNumbers();
}

/* Boot */
async function boot(){
  await refreshCashier();
  setTiming();
  setCategory('football');
  await loadTickets();
  setInterval(async ()=>{ await refreshCashier(); refreshByTab(false,true); await loadTickets(); }, 9000);
}
boot();
</script>
</body>
</html>
