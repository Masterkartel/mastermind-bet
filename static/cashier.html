<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Cashier</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700;800&display=swap">
  <style>
    :root{
      --bg:#070b16; --panel:#0b1428; --line:#1c2741; --text:#ffffff; --muted:#a8b3c7;
      --accent:#22c55e; --danger:#ef4444; --warn:#f59e0b; --chip:#0f1a33; --ink:#0e172f;
      --dial-bg:#0d1428; --dial-fg:#22c55e; --dial-live:#ef4444;
      --glow:#7dd3fc;
      --maxw:100%;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;font-family:"Space Grotesk", Inter, system-ui, Arial, sans-serif;
      background:
        radial-gradient(140% 120% at 50% -20%, #122445 0 45%, #0b1324 46% 100%),
        linear-gradient(180deg, #0a0f1f 0, #0a0f1f 100%);
      color:var(--text)
    }
    a{color:#fff;text-decoration:none}

    /* ----- Header ----- */
    header{
      position:sticky; top:0; z-index:60; display:flex; align-items:center; gap:12px;
      padding:12px 16px; border-bottom:1px solid var(--line);
      background:rgba(8,12,24,.85); backdrop-filter:blur(8px)
    }
    .brand{font-weight:800;letter-spacing:.3px;font-size:20px;display:flex;align-items:center;gap:10px}
    .brand .ico{filter:drop-shadow(0 0 6px #7dd3fc88)}
    .grow{flex:1}
    .pill{
      padding:10px 14px;border:1px solid #2a3c66;border-radius:14px;background:#0d1428;color:#fff;
      box-shadow:inset 0 1px 0 #ffffff14, 0 6px 20px #00000040;font-size:13px
    }
    .pill.badge{display:inline-flex;gap:10px;align-items:center}
    .pill.solid{background:#0e172f;border-color:#2a3e6a}
    .clock{min-width:260px;text-align:right;font-weight:800}

    .avi-link{transform:translateZ(0); border-radius:16px; padding:10px 16px; font-weight:800; font-size:14px}
    .avi-link img{width:26px;height:26px;border-radius:50%; box-shadow:0 0 10px #7dd3fc55}

    /* ----- Layout ----- */
    .container{max-width:var(--maxw);margin:0 auto;padding:12px;display:grid;grid-template-columns:minmax(0,2.1fr) minmax(0,.9fr);gap:14px}
    @media (max-width:1100px){ .container{grid-template-columns:1fr} }

    .panel{
      background:linear-gradient(180deg,#0b1428,#0a1122);
      border:1px solid #1c2741;border-radius:18px;padding:12px;
      box-shadow:0 10px 24px #0006, inset 0 1px 0 #ffffff10
    }
    .title{font-weight:800;margin-bottom:8px}
    .muted{color:var(--muted);font-size:12px}
    .divider{height:1px;background:linear-gradient(90deg, #1c2741, #26345a);margin:10px 0}

    /* ----- Seamless “card tabs” (games, leagues, weeks, markets) ----- */
    .cards{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px}
    .cardtab{
      position:relative; padding:10px 14px; border-radius:14px; font-weight:800; cursor:pointer; user-select:none;
      background:linear-gradient(180deg,#0f1c36,#0c1530); border:1px solid #22355c; color:#fff;
      box-shadow:inset 0 1px 0 #ffffff1a, 0 6px 16px #0008;
      transition:transform .12s ease, filter .12s ease, box-shadow .12s ease;
    }
    .cardtab:hover{ filter:brightness(1.1); box-shadow:inset 0 1px 0 #ffffff26, 0 10px 24px #000a }
    .cardtab.active{ outline:2px solid var(--accent); box-shadow:0 0 0 6px #22c55e22, 0 10px 22px #0008 }

    /* ----- Dial/round ----- */
    .roundbar{display:flex;align-items:center;gap:10px}
    .dial{
      --p:0deg; --col:var(--dial-fg);
      width:44px;height:44px;border-radius:50%;
      background:
        conic-gradient(var(--col) var(--p), #0000 var(--p)),
        radial-gradient(circle 20px, #0000 18px, var(--dial-bg) 18px);
      border:1px solid var(--line); box-shadow:0 0 12px #22c55e33
    }
    .dial.live{ --col: var(--dial-live); animation:pulse 1.1s infinite alternate }
    @keyframes pulse{from{filter:brightness(1)}to{filter:brightness(1.25)}}
    .roundtxt{display:flex;flex-direction:column;line-height:1}
    .roundtxt b{font-size:12px}
    .roundtxt small{font-size:11px;color:var(--muted)}

    .sched{display:flex;gap:8px;flex-wrap:wrap}
    .slot{
      display:flex;flex-direction:column;gap:4px;align-items:center;justify-content:center;
      min-width:90px;padding:8px;border:1px solid var(--line);border-radius:12px;background:#0d1428;cursor:pointer;
      box-shadow:inset 0 1px 0 #ffffff10
    }
    .slot.active{outline:2px solid var(--accent)}
    .slot small{font-size:11px;color:var(--muted)}

    /* ----- Fixture rows (cards) ----- */
    .fxrow{
      display:grid; grid-template-columns:36px 1fr auto; gap:12px; align-items:center;
      padding:12px;border:1px solid #22365f;border-radius:16px;
      background:linear-gradient(180deg,#0c1530,#0a1328);
      margin-bottom:10px;
      box-shadow:inset 0 1px 0 #ffffff12, 0 10px 24px #0008
    }
    .fxrow:hover{ filter:brightness(1.03); box-shadow:inset 0 1px 0 #ffffff18, 0 14px 28px #000a }
    .fxteams{display:flex;align-items:center;gap:10px;font-weight:800}
    .logo-lg{width:54px;height:54px;border-radius:50%;background:#0b1324;border:1px solid #1c2741;object-fit:cover}
    .ph{width:54px;height:54px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;background:#10203c;color:#9fb3d4;font-weight:800;font-size:18px}
    .vs{opacity:.8;margin:0 6px}
    .oddsbar{display:flex;gap:8px;flex-wrap:wrap}
    .oddbtn{
      min-width:62px;padding:10px 12px;border-radius:10px;border:1px solid #3a455f;background:#0c1326;color:#fff;font-weight:800;text-align:center;cursor:pointer;
      box-shadow:inset 0 1px 0 #ffffff14
    }
    .oddbtn:hover{filter:brightness(1.15)}
    .idx{display:flex;align-items:center;justify-content:center;width:30px;height:30px;border-radius:10px;background:#0b1324;border:1px solid var(--line);font-weight:800;font-size:12px}

    /* ----- Racing lanes ----- */
    .racebox{background:linear-gradient(180deg,#0c1530,#0a1328); border:1px solid #22365f; border-radius:16px; padding:12px; margin-bottom:10px; box-shadow:inset 0 1px 0 #ffffff12, 0 10px 24px #0008}
    .track{position:relative;height:206px;border:1px dashed var(--line);border-radius:14px;margin:10px 0 10px;background:
        linear-gradient(90deg,#0b1324 0 10px, #12203f 10px 12px, transparent 12px),
        repeating-linear-gradient(to bottom, #0f1629 0, #0f1629 26px, #0b1324 26px, #0b1324 28px);
      overflow:hidden}
    .runner{position:absolute;left:8px;width:56px;height:22px;background:#e5e7eb;border-radius:3px 10px 10px 3px;box-shadow:0 0 6px #fff2, inset 0 -2px 3px #0003; display:flex;align-items:center;justify-content:flex-end;padding-right:6px;font-weight:900;color:#0a0a0a}
    .runner:after{content:"";position:absolute;right:-6px;top:7px;width:8px;height:8px;border-radius:50%;background:#e5e7eb;box-shadow:0 0 5px #fff4}

    .laneodds{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
    .lanebtn{display:flex;align-items:center;gap:8px}
    .lanetag{display:inline-flex;align-items:center;justify-content:center;min-width:28px;height:28px;border-radius:999px;background:#0b1324;border:1px solid #2a3f6b;font-weight:900}
    .oddbtn.small{min-width:auto}

    /* ----- Balls (Colors & Numbers) ----- */
    .balls{display:grid;gap:10px}
    .balls.colors{grid-template-columns:repeat(6,1fr)}
    .balls.numbers{grid-template-columns:repeat(7,1fr)}
    .ballwrap{display:flex;flex-direction:column;align-items:center;gap:6px}
    .ball{
      height:56px;width:56px;border-radius:50%;
      display:flex;align-items:center;justify-content:center;
      font-weight:900;color:#fff;border:2px solid #00000040;
      position:relative;box-shadow:inset -6px -8px 14px #00000055, inset 6px 6px 14px #ffffff1a, 0 2px 6px #00000066;
      cursor:pointer;user-select:none;font-size:18px
    }
    .ball::after{
      content:""; position:absolute; top:7px; left:10px; width:18px; height:10px;
      background:radial-gradient(circle at 10px 5px, #ffffffcc, #ffffff22 60%, #ffffff00 100%);
      border-radius:50%; filter:blur(0.3px);
    }
    .oddlab{font-size:12px;background:#0c1326;border:1px solid #2c3c60;padding:3px 8px;border-radius:999px}
    .RED{background:#ef4444}
    .BLUE{background:#3b82f6}
    .GREEN{background:#10b981}
    .YELLOW{background:#f59e0b}
    .PURPLE{background:#a855f7}
    .BLACK{background:#111827;color:#e5e7eb;border-color:#000}

    /* ----- Right: controls + betslip ----- */
    .betslip{display:grid;gap:8px}
    input,button,select{font-family:inherit}
    input[type="number"], input[type="text"]{width:100%;padding:12px;border-radius:12px;border:1px solid var(--line);background:#0d1428;color:#fff}
    .btn{padding:10px 12px;border-radius:12px;border:1px solid #2a3c66;background:#0d1428;color:#fff;cursor:pointer;font-weight:800; box-shadow:inset 0 1px 0 #ffffff12}
    .btn.primary{background:#0f2b1b;border-color:#1b4d28}
    .btn.warn{background:#3a1a0b;border-color:#7a3d1c}
    .ticket{position:relative;padding:8px;border:1px dashed var(--line);border-radius:12px;margin-bottom:6px;background:#0c162c}
    .wm{position:absolute;inset:8px;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:28px;color:#fff1;pointer-events:none;transform:rotate(-18deg)}
    .wm.OPEN{color:#7dd3fc22}
    .wm.WON{color:#22c55e22}
    .wm.LOST{color:#ef444422}

    .ico{width:18px;height:18px;display:inline-block;vertical-align:middle}

    .toaster{position:fixed;top:16px;right:16px;display:flex;flex-direction:column;gap:10px;z-index:80}
    .toast{background:#0f1933;border:1px solid #2a3b63;color:#e6edf3;padding:10px 12px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.35);opacity:0;transform:translateY(-6px);transition:opacity .18s ease, transform .18s ease}
    .toast.show{opacity:1;transform:none}
    .toast.success{border-color:#1d3f2a;background:#0e2217}
    .toast.error{border-color:#4d1a1a;background:#2a0e0e}
  </style>
</head>
<body>
<header>
  <div class="brand">
    <svg class="ico" viewBox="0 0 24 24"><path fill="#7dd3fc" d="M12 2a10 10 0 1 0 0 20a10 10 0 0 0 0-20Zm0 2a8 8 0 0 1 7.7 6H12V4Z"/></svg>
    Cashier
  </div>
  <div class="grow"></div>
  <div class="pill clock" id="clock"><b>—</b></div>
  <a href="/aviator" class="pill solid badge avi-link">
    <img src="/static/img/aviator-icon.png" alt="Aviator"/>
    <b style="letter-spacing:.3px">Aviator</b>
  </a>
</header>

<div class="container">
  <div class="panel">
    <!-- GAME TABS -->
    <div id="gameTabs" class="cards" aria-label="Games"></div>

    <!-- Round/Timer + week/round pager -->
    <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:6px;display:flex">
      <div style="display:flex;gap:12px;align-items:center">
        <div class="roundbar">
          <div id="dial" class="dial" title="Next switch"></div>
          <div class="roundtxt">
            <b id="liveText">LIVE</b>
            <small id="roundLabel">—</small>
          </div>
        </div>
        <div class="pill" id="roundTimer"><b>Next in —</b></div>
      </div>
      <div id="weekPager" class="cards"></div>
    </div>

    <!-- LEAGUES -->
    <div id="leagueTabs" class="cards"></div>

    <!-- MARKETS -->
    <div id="marketTabs" class="cards" style="margin-top:-2px"></div>

    <!-- STAGE -->
    <div id="stage"></div>
  </div>

  <div class="panel">
    <div class="title">Controls</div>
    <div class="row" style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
      <div class="pill badge" id="cashierIdShow">
        <svg class="ico" viewBox="0 0 24 24"><path fill="#a7f3d0" d="M4 4h16v4H4zM4 10h10v10H4zM16 10h4v6h-4z"/></svg>
        Cashier: <b id="cashierId">shop-1</b>
      </div>
      <div class="pill">Balance: <b id="cashBal">0 KES</b></div>
      <input id="cashierIdInput" value="shop-1" placeholder="shop-1" style="max-width:160px">
      <button class="btn" onclick="applyCashier()">Set</button>
      <button class="btn" onclick="topupCashier(5000)">Top-up 5,000</button>
    </div>
    <div class="divider"></div>

    <div>
      <div class="title">Aviator Players — Wallets</div>
      <div class="row" style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <select id="aviPlayer">
          <option value="pA">Player A</option>
          <option value="pB">Player B</option>
          <option value="pC">Player C</option>
        </select>
        <input id="aviAmount" type="number" value="1000" min="1" style="max-width:120px" />
        <button class="btn" onclick="aviLoad()">Load</button>
        <button class="btn" onclick="aviView()">View</button>
        <button class="btn" onclick="aviClear()">Pay & Clear</button>
        <div class="pill" id="aviBal">Bal: —</div>
      </div>
    </div>

    <div class="divider"></div>

    <div>
      <div class="title">History</div>
      <input id="historySearch" placeholder="Scan / type Ref or Code…" style="max-width:220px"/>
      <div id="tickets" class="list" style="margin-top:8px"></div>
    </div>

    <div class="divider"></div>

    <div>
      <div class="title">Betslip</div>
      <div class="betslip" id="betslip" style="display:none">
        <div class="muted" id="currentSel">No selection</div>
        <input id="stake" type="number" min="20" max="1000" value="100" placeholder="Stake (KES)"/>
        <div class="row" style="display:flex;gap:8px;flex-wrap:wrap">
          <div class="pill">Odds: <b id="odds">—</b></div>
          <div class="pill">Potential: <b id="payout">—</b></div>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button id="placeBtn" class="btn primary" onclick="placeBet()">Place Bet</button>
          <button class="btn warn" onclick="clearSlip()">Clear Slip</button>
        </div>
        <div class="muted">Min 20, Max 1000, Max Payout 20,000</div>
      </div>
      <div id="noSlip" class="muted">Click a market to build a betslip.</div>

      <div class="divider"></div>
      <div class="title">Printer Settings</div>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <input id="printerName" placeholder="Printer name / device (opt)" style="max-width:240px"/>
        <label class="pill badge" style="gap:8px">
          <input id="autoPrint" type="checkbox" style="accent-color:#22c55e"> Auto-print after bet
        </label>
        <button class="btn" onclick="testPrint()">Test Print</button>
      </div>
      <div class="muted" style="margin-top:6px">Browser print is used now; you can hook a thermal bridge later.</div>
    </div>
  </div>
</div>

<div id="toaster" class="toaster"></div>

<script>
/* ---------- Toasts ---------- */
const toaster=document.getElementById('toaster');
function notify(msg,type='info',ms=2200){
  const t=document.createElement('div');
  t.className='toast'+(type==='success'?' success':type==='error'?' error':'');
  t.textContent=msg; toaster.appendChild(t);
  requestAnimationFrame(()=>t.classList.add('show'));
  setTimeout(()=>{ t.classList.remove('show'); setTimeout(()=>t.remove(),180); }, ms);
}

/* ---------- API helper (tries same-origin, then :4000) ---------- */
const ORIGIN = location.origin;
const PORT4000 = ORIGIN.replace(/^(https?:\/\/[^\/:]+)(?::\d+)?$/,'$1:4000');
const API = {
  async get(path){
    try{ const r = await fetch(`${ORIGIN}${path}`,{cache:'no-store'}); if(r.ok) return r; }catch{}
    return fetch(`${PORT4000}${path}`,{cache:'no-store'});
  },
  async post(path, body){
    const opts={method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body||{})};
    try{ const r = await fetch(`${ORIGIN}${path}`,opts); if(r.ok) return r; }catch{}
    return fetch(`${PORT4000}${path}`,opts);
  }
};
const KES = x=> new Intl.NumberFormat('en-KE',{style:'currency',currency:'KES'}).format(Number(x||0));
const el = id=>document.getElementById(id);

/* ---------- Clock ---------- */
let healthSkew=0;
async function syncClock(){
  try{ const r=await API.get('/health'); const j=await r.json(); healthSkew=j.ts-Date.now(); }catch{ healthSkew=0; }
}
setInterval(()=>{ const d=new Date(Date.now()+healthSkew); el('clock').innerHTML='<b>'+d.toLocaleString()+'</b>'; }, 500);
syncClock();

/* ---------- Cashier ---------- */
let CASHIER_ID = 'shop-1';
async function refreshCashier(){
  try{ const r=await API.get(`/cashier/${CASHIER_ID}/balance`); const j=await r.json();
    el('cashBal').textContent = KES(j.balance||0);
    el('cashierId').textContent = CASHIER_ID;
  }catch{}
}
async function topupCashier(amount){ await API.post(`/cashier/topup`,{cashierId:CASHIER_ID,amount}); refreshCashier(); }
function applyCashier(){ CASHIER_ID = (el('cashierIdInput').value||'shop-1').trim(); refreshCashier(); }

/* ---------- Aviator wallets ---------- */
async function aviView(){ const pid=el('aviPlayer').value; try{ const r=await API.get(`/aviator/wallet/${pid}`); const j=await r.json(); el('aviBal').textContent=`Bal: ${KES(j.balance||0)}`; }catch{ el('aviBal').textContent='Bal: —'; } }
async function aviLoad(){
  const pid=el('aviPlayer').value; const amt=Number(el('aviAmount').value||0)||0;
  if (!amt) return notify('Enter amount to load.','error');
  try{ const r=await API.post(`/aviator/wallet/load`,{playerId:pid, amount:amt}); const j=await r.json(); el('aviBal').textContent=`Bal: ${KES(j.balance||0)}`; notify('Wallet updated','success'); }catch{ notify('Wallet update failed','error'); }
}
async function aviClear(){
  const pid=el('aviPlayer').value;
  try{ const r=await API.get(`/aviator/wallet/${pid}`); const j=await r.json(); const bal=j.balance||0;
    if (bal>0){ await API.post(`/aviator/wallet/load`,{playerId:pid, amount:-bal}); el('aviBal').textContent=`Bal: ${KES(0)}`; notify('Paid & cleared','success'); }
    else notify('Nothing to clear','info');
  }catch{ notify('Clear failed','error'); }
}
/* ---------- Print ---------- */
function testPrint(){ window.print(); }

/* ---------- Logos ---------- */
function logoHTML(folder, abbr, big=true){
  const code = (abbr||'???').toUpperCase();
  const base = `/static/logos/${folder}/${code}`;
  const id = `lg_${folder}_${code}_${Math.random().toString(36).slice(2,7)}`;
  const cls = big ? 'logo-lg' : 'logo';
  const img = `<img id="${id}" class="${cls}" src="${base}.png" alt="${code}">`;
  const ph  = `<span class="ph ${big?'':'ph-sm'}" id="${id}_ph" style="display:none">${code}</span>`;
  setTimeout(()=>{
    const tag = document.getElementById(id), phTag=document.getElementById(id+'_ph');
    if(!tag) return;
    tag.onerror = ()=>{
      if (tag.src.endsWith('.png')) tag.src = `${base}.jpg`;
      else if (tag.src.endsWith('.jpg')) tag.src = `${base}.svg`;
      else { tag.style.display='none'; if (phTag) phTag.style.display='inline-flex'; }
    };
  },0);
  return img+ph;
}

/* ---------- Globals / State ---------- */
const dial = el('dial'); const roundTimer=el('roundTimer'); const roundLabel=el('roundLabel');
let CURRENT_TAB='football', CURRENT=null, CURRENT_LEAGUE='EPL', CURRENT_MARKET='MAIN';
let selectedSlot=0, weekPointer=0; // weekPointer is 0-based block index (each block = 10 fixtures)
let nextBoundaryTs=null, boundarySpanMs=0;

const GAME_TABS = [
  {id:'football', label:'Football', svg:'<svg class="ico" viewBox="0 0 24 24"><path fill="#93c5fd" d="M12 2c5.5 0 10 4.5 10 10s-4.5 10-10 10S2 17.5 2 12S6.5 2 12 2Zm0 3l-3 2l1 3l-2 2l2 2l-1 3l3 2l3-2l-1-3l2-2l-2-2l1-3l-3-2Z"/></svg>'},
  {id:'dogs', label:'Dogs', svg:'<svg class="ico" viewBox="0 0 24 24"><path fill="#fda4af" d="M3 7h5l2 3h6l2-3h3l-2 10H5z"/></svg>'},
  {id:'horses', label:'Horses', svg:'<svg class="ico" viewBox="0 0 24 24"><path fill="#fde68a" d="M3 14h4l3-5h7l4 5v2H3z"/></svg>'},
  {id:'colors', label:'Colors & Numbers', svg:'<svg class="ico" viewBox="0 0 24 24"><circle cx="8" cy="8" r="4" fill="#ef4444"/><circle cx="16" cy="8" r="4" fill="#3b82f6"/><circle cx="12" cy="16" r="4" fill="#10b981"/></svg>'},
];

const MARKET_TABS = ['MAIN','OU05','OU15','OU25','OU35','BTTS','H15','A15','DC','DNB','CMB15','CMB25'];
const MLAB={MAIN:'MAIN',OU05:'OU 0.5',OU15:'OU 1.5',OU25:'OU 2.5',OU35:'OU 3.5',BTTS:'BTTS',H15:'HOME 1.5',A15:'AWAY 1.5',DC:'DOUBLE CHANCE',DNB:'DRAW NO BET',CMB15:'1X2+OU1.5',CMB25:'1X2+OU2.5'};
const LEAGUES = ['EPL','LALIGA','UCL'];

function renderGameTabs(){
  const wrap=el('gameTabs'); wrap.innerHTML='';
  GAME_TABS.forEach(g=>{
    const b=document.createElement('div'); b.className='cardtab'; if(CURRENT_TAB===g.id) b.classList.add('active');
    b.innerHTML=`${g.svg}<span style="margin-left:6px">${g.label}</span>`;
    b.onclick=()=>{ CURRENT_TAB=g.id; CURRENT=null; showSlip(false); weekPointer=0; setTiming(); renderAll(); };
    wrap.appendChild(b);
  });
}
function renderLeagueTabs(){
  const box=el('leagueTabs'); box.innerHTML='';
  LEAGUES.forEach(L=>{
    const b=document.createElement('div'); b.className='cardtab'; if(CURRENT_LEAGUE===L) b.classList.add('active');
    b.textContent=L;
    b.onclick=()=>{ CURRENT_LEAGUE=L; weekPointer=0; CURRENT_MARKET='MAIN'; renderAll(); };
    box.appendChild(b);
  });
}
function renderMarketTabs(){
  const box=el('marketTabs'); box.innerHTML='';
  if(CURRENT_TAB!=='football'){ // racing & colors get their own simple market strips later
    box.style.display='none'; return;
  }
  box.style.display='flex';
  MARKET_TABS.forEach(m=>{
    const b=document.createElement('div'); b.className='cardtab'; if(m===CURRENT_MARKET) b.classList.add('active');
    b.textContent=MLAB[m]; b.onclick=()=>{ CURRENT_MARKET=m; renderFootball(); };
    box.appendChild(b);
  });
}

/* ---------- Timing / Pager ---------- */
function ceilToStep(ms, min){ const step=min*60*1000; return Math.ceil(ms/step)*step; }
function setTiming(){
  const now = Date.now()+healthSkew;
  if (CURRENT_TAB==='football'){ nextBoundaryTs=ceilToStep(now,7); boundarySpanMs=7*60*1000; roundLabel.textContent='FOOTBALL • Weeks'; }
  else { nextBoundaryTs=ceilToStep(now,3); boundarySpanMs=3*60*1000; roundLabel.textContent='NEXT START • '+new Date(nextBoundaryTs).toLocaleTimeString(); }
  buildWeekPager();
}
function tickDial(){
  const now = Date.now()+healthSkew;
  const remain = Math.max(0, (nextBoundaryTs||now) - now);
  const ratio = boundarySpanMs ? 1 - remain / boundarySpanMs : 0;
  const deg = Math.max(0, Math.min(360, ratio*360));
  dial.style.setProperty('--p', deg+'deg');
  const ss = Math.ceil(remain/1000), mm=Math.floor(ss/60), s=ss%60;
  roundTimer.innerHTML = `<b>Next in ${String(mm).padStart(2,'0')}:${String(s).padStart(2,'0')}</b>`;
  if (remain<=0){ nextBoundaryTs += boundarySpanMs; if(CURRENT_TAB==='football'){ weekPointer++; } renderAll(); }
}
setInterval(tickDial, 500);

/* Weeks/Rounds pager: shows 4 at a time; arrows step by 4 */
let weekBase=1; // first visible week number in the pager view
function buildWeekPager(){
  const box=el('weekPager'); box.innerHTML='';
  if(CURRENT_TAB!=='football'){ // racing+colors show next times instead of weeks
    // For visual uniformity we still show a tiny 4-slot time list
    const now=Date.now()+healthSkew, step=3*60*1000;
    for(let i=1;i<=4;i++){
      const d=new Date(now+i*step);
      const b=document.createElement('div'); b.className='cardtab'; b.textContent=d.toLocaleTimeString();
      b.onclick=()=>{}; box.appendChild(b);
    }
    return;
  }

  const isUCL = CURRENT_LEAGUE==='UCL';
  const labels = isUCL ? ['Group','Round of 16','Quarterfinal','Semifinal','Final'] : Array.from({length:38},(_,i)=>`Week ${i+1}`);
  const len = labels.length;

  function nav(dir){
    if(isUCL){ weekBase = Math.min(Math.max(1, weekBase + dir*4), Math.max(1,len-3)); }
    else { weekBase = Math.min(Math.max(1, weekBase + dir*4), Math.max(1,len-3)); }
    renderAll(false);
  }
  const prev=document.createElement('div'); prev.className='cardtab'; prev.innerHTML='◀'; prev.onclick=()=>nav(-1);
  const next=document.createElement('div'); next.className='cardtab'; next.innerHTML='▶'; next.onclick=()=>nav(1);
  box.appendChild(prev);

  for(let i=0;i<4;i++){
    const idx = Math.min(len, weekBase+i) - 1;
    const b=document.createElement('div'); b.className='cardtab';
    const active = (isUCL ? idx===weekPointer : idx===weekPointer);
    if(active) b.classList.add('active');
    b.textContent = labels[idx];
    b.onclick=()=>{ weekPointer = idx; renderFootball(); };
    box.appendChild(b);
  }
  box.appendChild(next);
}

/* ---------- Data cache ---------- */
const CACHE = { events:{}, markets:{}, loadedAt:{} };
async function getEvents(game){
  const now=Date.now(); if(CACHE.events[game] && now-(CACHE.loadedAt[game]||0)<60_000) return CACHE.events[game];
  try{ const r=await API.get(`/events?game=${game}`); const arr=await r.json(); CACHE.events[game]=arr; CACHE.loadedAt[game]=now; return arr; }catch{ return CACHE.events[game]||[]; }
}
async function getMarkets(eventId){
  if(!CACHE.markets[eventId]){
    try{ const r=await API.get(`/markets/${eventId}`); const arr=await r.json(); const map={}; (arr||[]).forEach(m=>map[m.type]=m); CACHE.markets[eventId]=map; }
    catch{ CACHE.markets[eventId]={}; }
  }
  return CACHE.markets[eventId];
}

/* ---------- Helpers ---------- */
function pickMarket(byType, candidates){
  const keys=Object.keys(byType||{});
  for(const c of candidates){
    if(typeof c==='string'){ if(byType[c]) return byType[c]; }
    else { const k=keys.find(k=>c.test(k)); if(k) return byType[k]; }
  }
  return null;
}
function showSlip(b){ el('betslip').style.display=b?'block':'none'; el('noSlip').style.display=b?'none':'block'; }
function clearSlip(){ CURRENT=null; showSlip(false); el('currentSel').textContent='No selection'; el('odds').textContent='—'; el('payout').textContent='—'; }

/* ---------- Betslip ---------- */
function validateStake(raw){
  const stake=Number(raw); if(!Number.isFinite(stake)||stake<=0){ notify('Enter a valid stake.','error');return null;}
  if(stake<20){notify('Minimum stake is 20 KES.','error');return null;}
  if(stake>1000){notify('Maximum stake is 1000 KES.','error');return null;}
  return stake;
}
function updatePotential(){
  if(!CURRENT){ el('payout').textContent='—'; return; }
  const stake=Number(el('stake').value||0), odds=Number(CURRENT.market.odds[CURRENT.selection.id]);
  el('payout').textContent = stake? KES(Math.min(stake*odds,20000)) : '—';
}
function selectionLabel(ev,m,sel){
  const dt = new Date((ev.runsAt||Date.now())+healthSkew);
  const when = `${dt.toLocaleDateString()} ${dt.toLocaleTimeString()}`;
  let period='';
  if(ev.game==='football'){
    if(ev.league==='UCL'){
      const rounds=['Group','Round of 16','Quarterfinal','Semifinal','Final'];
      period = rounds[Math.min(rounds.length-1, weekPointer)]||'Round';
    }else{
      period = `Week ${weekPointer+1}`;
    }
  }else{
    period = when;
  }
  const teams = ev.home?.abbr && ev.away?.abbr ? `${ev.home.abbr} vs ${ev.away.abbr}` : (ev.name||ev.game.toUpperCase());
  return `${ev.game.toUpperCase()} • ${ev.league||''} • ${period} — ${when} — ${m.type} — ${teams} — ${sel.name}`;
}
function choose(ev,m,sel){
  CURRENT={event:ev,market:m,selection:sel,label:selectionLabel(ev,m,sel)};
  el('currentSel').textContent=CURRENT.label;
  el('odds').textContent=m.odds[sel.id];
  updatePotential(); showSlip(true);
}
el('stake').addEventListener('input',updatePotential);
async function placeBet(){
  if(!CURRENT) return notify('Pick a selection first','error');
  const stake=validateStake(el('stake').value); if(stake==null) return;
  const payload={
    eventId:CURRENT.event.id, marketId:CURRENT.market.id, selectionId:CURRENT.selection.id,
    stake, cashierId:CASHIER_ID, slot:selectedSlot, label:CURRENT.label
  };
  try{
    const r=await API.post(`/bets`,payload); const j=await r.json();
    if(!j || j.ok===false){ notify((j&&j.error)||'Bet failed','error'); return; }
    await refreshCashier(); await loadTickets();
    if(el('autoPrint').checked){ window.print(); }
    notify('Bet placed','success');
    clearSlip();
    // open receipt if provided
    if(j.bet && j.bet.id){
      const w=window.open(`/receipt/${j.bet.id}`,'_blank','width=380,height=560'); try{w.focus();}catch{}
    }
  }catch(e){ notify('Bet failed','error'); }
}

/* ---------- History ---------- */
async function loadTickets(){
  const r = await API.get(`/bets?cashierId=${encodeURIComponent(CASHIER_ID)}`); const list = await r.json();
  const box = el('tickets'); box.innerHTML='';
  (list||[]).slice(0,16).forEach(t=>{
    const d=document.createElement('div'); d.className='ticket';
    const ref=t.ref||`T-${(t.id||'').slice(0,8).toUpperCase()}`;
    d.innerHTML=`<div class="wm ${t.status||'OPEN'}">${t.status||'OPEN'}</div>
                 <div><b>${ref}</b> — ${t.game?.toUpperCase()||''} — ${t.status||'OPEN'}</div>
                 <div class="muted">${KES(t.stake)} • ${t.odds} → ${t.payout?KES(t.payout):'—'}</div>`;
    box.appendChild(d);
  });
  const input = el('historySearch');
  input.oninput=()=>{
    const q=input.value.trim().toUpperCase(); if(!q) return loadTickets();
    const filtered=(list||[]).filter(t=> (t.ref||'').toUpperCase().includes(q) || (t.id||'').toUpperCase().includes(q) );
    const box2=el('tickets'); box2.innerHTML='';
    filtered.slice(0,16).forEach(t=>{
      const d=document.createElement('div'); d.className='ticket';
      const ref=t.ref||`T-${(t.id||'').slice(0,8).toUpperCase()}`;
      d.innerHTML=`<div class="wm ${t.status||'OPEN'}">${t.status||'OPEN'}</div>
                   <div><b>${ref}</b> — ${t.game?.toUpperCase()||''} — ${t.status||'OPEN'}</div>
                   <div class="muted">${KES(t.stake)} • ${t.odds} → ${t.payout?KES(t.payout):'—'}</div>`;
      box2.appendChild(d);
    });
  };
}

/* ---------- RENDERERS ---------- */
async function renderFootball(){
  renderGameTabs(); renderLeagueTabs(); renderMarketTabs(); buildWeekPager();

  const stage=el('stage'); stage.innerHTML='';
  let all = await getEvents('football');
  all=(all||[]).filter(e=>e.league===CURRENT_LEAGUE).sort((a,b)=>a.runsAt-b.runsAt);
  if(!all.length){ stage.innerHTML='<div class="muted">No fixtures.</div>'; return; }

  // group fixtures into "weeks" blocks of 10 for UI
  const blocks=[]; for(let i=0;i<all.length;i+=10) blocks.push(all.slice(i,i+10));
  const blk = blocks[Math.min(blocks.length-1, weekPointer)];

  let rowIndex=0;
  for(const ev of blk){
    rowIndex++;
    const byType = await getMarkets(ev.id);

    const folder = CURRENT_LEAGUE.toLowerCase()==='epl'?'epl':(CURRENT_LEAGUE.toLowerCase()==='laliga'?'laliga':'ucl');
    const H=ev.home?.abbr||'H', A=ev.away?.abbr||'A';

    const mMain  = pickMarket(byType,[`MAIN_1X2_${CURRENT_LEAGUE}`,/MAIN.*1X2.*${CURRENT_LEAGUE}/, /MAIN.*1X2/i]);
    const mOU05  = pickMarket(byType,[`OU_0_5_${CURRENT_LEAGUE}`,/OU[_-]?0[_-]?5.*${CURRENT_LEAGUE}/i, /OVER.*0\.?5/i]);
    const mOU15  = pickMarket(byType,[`OU_1_5_${CURRENT_LEAGUE}`,/OU[_-]?1[_-]?5.*${CURRENT_LEAGUE}/i, /OVER.*1\.?5/i]);
    const mOU25  = pickMarket(byType,[`OU_2_5_${CURRENT_LEAGUE}`,/OU[_-]?2[_-]?5.*${CURRENT_LEAGUE}/i, /OVER.*2\.?5/i]);
    const mOU35  = pickMarket(byType,[`OU_3_5_${CURRENT_LEAGUE}`,/OU[_-]?3[_-]?5.*${CURRENT_LEAGUE}/i, /OVER.*3\.?5/i]);
    const mBTTS  = pickMarket(byType,[`BTTS_${CURRENT_LEAGUE}`,/BTTS.*${CURRENT_LEAGUE}/i, /BTTS/i]);
    const mH15   = pickMarket(byType,[`HOME_OU_1_5_${CURRENT_LEAGUE}`,/HOME.*OU.*1[_-]?5.*${CURRENT_LEAGUE}/i]);
    const mA15   = pickMarket(byType,[`AWAY_OU_1_5_${CURRENT_LEAGUE}`,/AWAY.*OU.*1[_-]?5.*${CURRENT_LEAGUE}/i]);
    const mDC    = pickMarket(byType,[`DC_${CURRENT_LEAGUE}`,/DOUBLE[_-]?CHANCE.*${CURRENT_LEAGUE}/i, /DOUBLE[_ ]CHANCE/i]);
    const mDNB   = pickMarket(byType,[`DNB_${CURRENT_LEAGUE}`,/DRAW[_-]?NO[_-]?BET.*${CURRENT_LEAGUE}/i, /DNB/i]);
    const mCMB15 = pickMarket(byType,[`COMBO_1X2_OU_1_5_${CURRENT_LEAGUE}`,/COMBO.*1X2.*OU.*1[_-]?5.*${CURRENT_LEAGUE}/i]);
    const mCMB25 = pickMarket(byType,[`COMBO_1X2_OU_2_5_${CURRENT_LEAGUE}`,/COMBO.*1X2.*OU.*2[_-]?5.*${CURRENT_LEAGUE}/i]);

    const mMap={MAIN:mMain,OU05:mOU05,OU15:mOU15,OU25:mOU25,OU35:mOU35,BTTS:mBTTS,H15:mH15,A15:mA15,DC:mDC,DNB:mDNB,CMB15:mCMB15,CMB25:mCMB25};
    const mdef=mMap[CURRENT_MARKET] || mMain; if(!mdef) continue;

    const row=document.createElement('div'); row.className='fxrow';
    const idx=document.createElement('div'); idx.className='idx'; idx.textContent=String(rowIndex); row.appendChild(idx);
    const t=document.createElement('div'); t.className='fxteams';
    t.innerHTML = `${logoHTML(folder,H,true)} <span>${H}</span> <span class="vs">vs</span> ${logoHTML(folder,A,true)} <span>${A}</span>`;
    row.appendChild(t);

    const od=document.createElement('div'); od.className='oddsbar';
    (mdef.selections||[]).forEach(s=>{
      const b=document.createElement('div'); b.className='oddbtn'; b.textContent=mdef.odds[s.id];
      b.title = `${s.name}`; b.onclick=()=>choose(ev,mdef,s); od.appendChild(b);
    });
    row.appendChild(od);
    stage.appendChild(row);
  }
}

/* Dogs & Horses */
function renderRaceMarketsBar(game){
  const bar=el('marketTabs'); bar.innerHTML=''; bar.style.display='flex';
  ['MAIN','FORECAST','QUINELLA','TRICAST'].forEach(m=>{
    const b=document.createElement('div'); b.className='cardtab'; if((window.racingMkt?.[game]||'MAIN')===m) b.classList.add('active');
    b.textContent=m; b.onclick=()=>{ if(!window.racingMkt) window.racingMkt={dog:'MAIN',horse:'MAIN'}; window.racingMkt[game]=m; renderRacing(game); };
    bar.appendChild(b);
  });
}
async function renderRacing(game){
  renderGameTabs(); renderLeagueTabs(); renderRaceMarketsBar(game); buildWeekPager();
  const stage=el('stage'); stage.innerHTML='';
  if (!window.racingMkt) window.racingMkt = {dog:'MAIN', horse:'MAIN'};

  let events=[]; try{ const r=await API.get(`/events?game=${game}`); events=(await r.json()).slice(0,3);}catch{}
  if(!events.length){ stage.innerHTML='<div class="muted">No events.</div>'; return; }

  for(const ev of events){
    const byType = await getMarkets(ev.id);
    const mWIN   = pickMarket(byType, [/MAIN.*WIN/i, 'MAIN_WIN', `${game.toUpperCase()}_MAIN_WIN`]);
    const mFCAST = pickMarket(byType, [/FORECAST/i,'FORECAST']);
    const mQUIN  = pickMarket(byType, [/QUINELLA/i,'QUINELLA']);
    const mTRI   = pickMarket(byType, [/TRICAST/i,'TRICAST']);

    const want = (window.racingMkt[game]||'MAIN');
    const useMap={MAIN:mWIN, FORECAST:mFCAST, QUINELLA:mQUIN, TRICAST:mTRI};
    const mdef=useMap[want]||mWIN;

    const box=document.createElement('div'); box.className='racebox';
    const title=document.createElement('div'); title.className='muted'; title.textContent=`${game.toUpperCase()} RACE — ${new Date((ev.runsAt||Date.now())+healthSkew).toLocaleTimeString()}`;
    box.appendChild(title);

    // lanes drawing (always show up to 8)
    const lanes=document.createElement('div'); lanes.className='track';
    const laneCount = Math.min(8, (mWIN?.selections||[]).length || 8);
    for(let i=0;i<laneCount;i++){
      const r=document.createElement('div'); r.className='runner'; r.style.top=(14 + i*23)+'px';
      r.textContent=String(i+1);
      r.animate([{transform:'translateX(0)'},{transform:'translateX(10px)'},{transform:'translateX(0)'}],
        {duration:2000+Math.random()*1200,iterations:Infinity});
      lanes.appendChild(r);
    }
    box.appendChild(lanes);

    if(mdef){
      const grid=document.createElement('div'); grid.className='laneodds';
      (mdef.selections||[]).slice(0,8).forEach((s,idx)=>{
        const wr=document.createElement('div'); wr.className='lanebtn';
        const tag=document.createElement('div'); tag.className='lanetag'; tag.textContent=String(idx+1);
        const b=document.createElement('div'); b.className='oddbtn small'; b.textContent=mdef.odds[s.id]; b.title=s.name.replace(/DOG|HORSE/gi,'').trim();
        b.onclick=()=>choose(ev,mdef,s);
        wr.appendChild(tag); wr.appendChild(b); grid.appendChild(wr);
      });
      box.appendChild(grid);
    }else{
      box.innerHTML+='<div class="muted">No market data.</div>';
    }
    stage.appendChild(box);
  }
}

/* Colors & Numbers */
async function renderColorsNumbers(){
  renderGameTabs(); renderLeagueTabs(); el('marketTabs').style.display='none'; buildWeekPager();
  const stage=el('stage'); stage.innerHTML='';

  let evC,marketsC,mC; try{ evC=(await (await API.get(`/events?game=colors`)).json())[0]; marketsC=await (await API.get(`/markets/${evC.id}`)).json(); mC=(marketsC||[]).find(x=>/MAIN[_-]?COLOR/i.test(x.type)); }catch{}
  const boxC=document.createElement('div'); boxC.className='racebox';
  boxC.innerHTML='<div class="title">Colors</div>';
  const gridC=document.createElement('div'); gridC.className='balls colors';
  (mC?.selections||[]).forEach(s=>{
    const w=document.createElement('div'); w.className='ballwrap';
    const b=document.createElement('div'); b.className=`ball ${s.id}`; b.textContent=s.id[0]; b.onclick=()=>choose(evC,mC,s);
    const od=document.createElement('div'); od.className='oddlab'; od.textContent=mC.odds[s.id];
    w.appendChild(b); w.appendChild(od); gridC.appendChild(w);
  });
  boxC.appendChild(gridC); stage.appendChild(boxC);

  let evN,marketsN,mN; try{ evN=(await (await API.get(`/events?game=lotto49`)).json())[0]; marketsN=await (await API.get(`/markets/${evN.id}`)).json(); mN=(marketsN||[]).find(x=>/PICK\s*1/i.test(x.type)||x.type==='PICK1'); }catch{}
  const colors=['RED','BLUE','GREEN','YELLOW','PURPLE','BLACK'];
  const boxN=document.createElement('div'); boxN.className='racebox';
  boxN.innerHTML='<div class="title">Numbers 1–49</div>';
  const gridN=document.createElement('div'); gridN.className='balls numbers';
  (mN?.selections||[]).forEach(s=>{
    const idx=(Number(s.id)-1)%colors.length;
    const w=document.createElement('div'); w.className='ballwrap';
    const b=document.createElement('div'); b.className=`ball ${colors[idx]}`; b.textContent=s.id; b.onclick=()=>choose(evN,mN,s);
    const od=document.createElement('div'); od.className='oddlab'; od.textContent=mN.odds[s.id];
    w.appendChild(b); w.appendChild(od); gridN.appendChild(w);
  });
  boxN.appendChild(gridN); stage.appendChild(boxN);
}

/* ---------- Router ---------- */
function renderAll(rebuildWeeks=true){
  if(CURRENT_TAB==='football') renderFootball();
  if(CURRENT_TAB==='dogs') renderRacing('dog');
  if(CURRENT_TAB==='horses') renderRacing('horse');
  if(CURRENT_TAB==='colors') renderColorsNumbers();
}
async function boot(){
  renderGameTabs(); renderLeagueTabs(); renderMarketTabs(); buildWeekPager();
  await refreshCashier(); await loadTickets();
  setTiming(); renderAll();
  setInterval(async ()=>{ await refreshCashier(); await loadTickets(); }, 9000);
}
boot();
</script>
</body>
</html>
